{"remainingRequest":"/home/artur/programowanie/organiser/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/artur/programowanie/organiser/node_modules/vue2-timepicker/src/vue-timepicker.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/artur/programowanie/organiser/node_modules/vue2-timepicker/src/vue-timepicker.vue","mtime":1638016037242},{"path":"/home/artur/programowanie/organiser/node_modules/cache-loader/dist/cjs.js","mtime":1638016032464},{"path":"/home/artur/programowanie/organiser/node_modules/babel-loader/lib/index.js","mtime":1638016034515},{"path":"/home/artur/programowanie/organiser/node_modules/cache-loader/dist/cjs.js","mtime":1638016032464},{"path":"/home/artur/programowanie/organiser/node_modules/vue-loader/lib/index.js","mtime":1638016035031}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmNvbnN0IENPTkZJRyA9IHsKICBIT1VSX1RPS0VOUzogWydISCcsICdIJywgJ2hoJywgJ2gnLCAna2snLCAnayddLAogIE1JTlVURV9UT0tFTlM6IFsnbW0nLCAnbSddLAogIFNFQ09ORF9UT0tFTlM6IFsnc3MnLCAncyddLAogIEFQTV9UT0tFTlM6IFsnQScsICdhJ10sCiAgQkFTSUNfVFlQRVM6IFsnaG91cicsICdtaW51dGUnLCAnc2Vjb25kJywgJ2FwbSddCn0KCmNvbnN0IERFRkFVTFRfT1BUSU9OUyA9IHsKICBmb3JtYXQ6ICdISDptbScsCiAgbWludXRlSW50ZXJ2YWw6IDEsCiAgc2Vjb25kSW50ZXJ2YWw6IDEsCiAgaG91clJhbmdlOiBudWxsLAogIG1pbnV0ZVJhbmdlOiBudWxsLAogIHNlY29uZFJhbmdlOiBudWxsLAogIGhpZGVEaXNhYmxlZEhvdXJzOiBmYWxzZSwKICBoaWRlRGlzYWJsZWRNaW51dGVzOiBmYWxzZSwKICBoaWRlRGlzYWJsZWRTZWNvbmRzOiBmYWxzZSwKICBoaWRlRGlzYWJsZWRJdGVtczogZmFsc2UsCiAgaGlkZURyb3Bkb3duOiBmYWxzZSwKICBibHVyRGVsYXk6IDMwMCwKICBtYW51YWxJbnB1dFRpbWVvdXQ6IDEwMDAsCiAgZHJvcE9mZnNldEhlaWdodDogMTYwCn0KCmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAnVnVlVGltZXBpY2tlcicsCiAgcHJvcHM6IHsKICAgIHZhbHVlOiB7IHR5cGU6IFsgT2JqZWN0LCBTdHJpbmcgXSB9LAogICAgZm9ybWF0OiB7IHR5cGU6IFN0cmluZyB9LAogICAgbWludXRlSW50ZXJ2YWw6IHsgdHlwZTogWyBOdW1iZXIsIFN0cmluZyBdIH0sCiAgICBzZWNvbmRJbnRlcnZhbDogeyB0eXBlOiBbIE51bWJlciwgU3RyaW5nIF0gfSwKCiAgICBob3VyUmFuZ2U6IHsgdHlwZTogQXJyYXkgfSwKICAgIG1pbnV0ZVJhbmdlOiB7IHR5cGU6IEFycmF5IH0sCiAgICBzZWNvbmRSYW5nZTogeyB0eXBlOiBBcnJheSB9LAoKICAgIGhpZGVEaXNhYmxlZEhvdXJzOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sCiAgICBoaWRlRGlzYWJsZWRNaW51dGVzOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sCiAgICBoaWRlRGlzYWJsZWRTZWNvbmRzOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sCiAgICBoaWRlRGlzYWJsZWRJdGVtczogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LAoKICAgIGhpZGVDbGVhckJ1dHRvbjogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LAogICAgZGlzYWJsZWQ6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfSwKICAgIGNsb3NlT25Db21wbGV0ZTogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LAoKICAgIGlkOiB7IHR5cGU6IFN0cmluZyB9LAogICAgbmFtZTogeyB0eXBlOiBTdHJpbmcgfSwKICAgIGlucHV0Q2xhc3M6IHsgdHlwZTogWyBTdHJpbmcsIE9iamVjdCwgQXJyYXkgXSB9LAogICAgcGxhY2Vob2xkZXI6IHsgdHlwZTogU3RyaW5nIH0sCiAgICB0YWJpbmRleDogeyB0eXBlOiBbIE51bWJlciwgU3RyaW5nIF0sIGRlZmF1bHQ6IDAgfSwKICAgIGlucHV0V2lkdGg6IHsgdHlwZTogU3RyaW5nIH0sCiAgICBhdXRvY29tcGxldGU6IHsgdHlwZTogU3RyaW5nLCBkZWZhdWx0OiAnb2ZmJyB9LAoKICAgIGhvdXJMYWJlbDogeyB0eXBlOiBTdHJpbmcgfSwKICAgIG1pbnV0ZUxhYmVsOiB7IHR5cGU6IFN0cmluZyB9LAogICAgc2Vjb25kTGFiZWw6IHsgdHlwZTogU3RyaW5nIH0sCiAgICBhcG1MYWJlbDogeyB0eXBlOiBTdHJpbmcgfSwKICAgIGFtVGV4dDogeyB0eXBlOiBTdHJpbmcgfSwKICAgIHBtVGV4dDogeyB0eXBlOiBTdHJpbmcgfSwKCiAgICBibHVyRGVsYXk6IHsgdHlwZTogWyBOdW1iZXIsIFN0cmluZyBdIH0sCiAgICBhZHZhbmNlZEtleWJvYXJkOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sCgogICAgbGF6eTogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LAogICAgYXV0b1Njcm9sbDogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LAoKICAgIGRyb3BEaXJlY3Rpb246IHsgdHlwZTogU3RyaW5nLCBkZWZhdWx0OiAnZG93bicgfSwKICAgIGRyb3BPZmZzZXRIZWlnaHQ6IHsgdHlwZTogWyBOdW1iZXIsIFN0cmluZyBdIH0sCiAgICBjb250YWluZXJJZDogeyB0eXBlOiBTdHJpbmcgfSwKICAgIGFwcGVuZFRvQm9keTogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LAoKICAgIG1hbnVhbElucHV0OiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sCiAgICBtYW51YWxJbnB1dFRpbWVvdXQ6IHsgdHlwZTogWyBOdW1iZXIsIFN0cmluZyBdIH0sCiAgICBoaWRlRHJvcGRvd246IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfSwKICAgIGZpeGVkRHJvcGRvd25CdXR0b246IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfSwKCiAgICBkZWJ1Z01vZGU6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfQogIH0sCgogIGRhdGEgKCkgewogICAgcmV0dXJuIHsKICAgICAgdGltZVZhbHVlOiB7fSwKCiAgICAgIGhvdXJzOiBbXSwKICAgICAgbWludXRlczogW10sCiAgICAgIHNlY29uZHM6IFtdLAogICAgICBhcG1zOiBbXSwKCiAgICAgIGlzQWN0aXZlOiBmYWxzZSwKICAgICAgc2hvd0Ryb3Bkb3duOiBmYWxzZSwKICAgICAgaXNGb2N1c2luZzogZmFsc2UsCiAgICAgIGRlYm91bmNlVGltZXI6IHVuZGVmaW5lZCwKCiAgICAgIGhvdXJUeXBlOiAnSEgnLAogICAgICBtaW51dGVUeXBlOiAnbW0nLAogICAgICBzZWNvbmRUeXBlOiAnJywKICAgICAgYXBtVHlwZTogJycsCiAgICAgIGhvdXI6ICcnLAogICAgICBtaW51dGU6ICcnLAogICAgICBzZWNvbmQ6ICcnLAogICAgICBhcG06ICcnLAogICAgICBmdWxsVmFsdWVzOiB1bmRlZmluZWQsCiAgICAgIGJha0Rpc3BsYXlUaW1lOiB1bmRlZmluZWQsCiAgICAgIGRvQ2xlYXJBcG1DaGVja2luZzogZmFsc2UsCgogICAgICBzZWxlY3Rpb25UaW1lcjogdW5kZWZpbmVkLAogICAgICBrYklucHV0VGltZXI6IHVuZGVmaW5lZCwKICAgICAga2JJbnB1dExvZzogJycsCiAgICAgIGJha0N1cnJlbnRQb3M6IHVuZGVmaW5lZCwKICAgICAgZm9yY2VEcm9wT25Ub3A6IGZhbHNlCiAgICB9CiAgfSwKCiAgY29tcHV0ZWQ6IHsKICAgIG9wdHMgKCkgewogICAgICBjb25zdCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9PUFRJT05TKQoKICAgICAgaWYgKHRoaXMuZm9ybWF0ICYmIHRoaXMuZm9ybWF0Lmxlbmd0aCkgewogICAgICAgIG9wdGlvbnMuZm9ybWF0ID0gU3RyaW5nKHRoaXMuZm9ybWF0KQogICAgICB9CgogICAgICBpZiAodGhpcy5pc051bWJlcih0aGlzLm1pbnV0ZUludGVydmFsKSkgewogICAgICAgIG9wdGlvbnMubWludXRlSW50ZXJ2YWwgPSArdGhpcy5taW51dGVJbnRlcnZhbAogICAgICB9CiAgICAgIC8vIG1pbnV0ZUludGVydmFsIGZhaWxzYWZlCiAgICAgIGlmICghb3B0aW9ucy5taW51dGVJbnRlcnZhbCB8fCBvcHRpb25zLm1pbnV0ZUludGVydmFsIDwgMSB8fCBvcHRpb25zLm1pbnV0ZUludGVydmFsID4gNjApIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIGlmIChvcHRpb25zLm1pbnV0ZUludGVydmFsID4gNjApIHsKICAgICAgICAgICAgdGhpcy5kZWJ1Z0xvZyhgIm1pbnV0ZS1pbnRlcnZhbCIgc2hvdWxkIGJlIGxlc3MgdGhhbiA2MC4gQ3VycmVudCB2YWx1ZSBpcyAke3RoaXMubWludXRlSW50ZXJ2YWx9YCkKICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5taW51dGVJbnRlcnZhbCA9PT0gMCB8fCBvcHRpb25zLm1pbnV0ZUludGVydmFsIDwgMSkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKGAibWludXRlLWludGVydmFsIiBzaG91bGQgYmUgTk8gbGVzcyB0aGFuIDEuIEN1cnJlbnQgdmFsdWUgaXMgJHt0aGlzLm1pbnV0ZUludGVydmFsfWApCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvcHRpb25zLm1pbnV0ZUludGVydmFsID09PSAwKSB7CiAgICAgICAgICBvcHRpb25zLm1pbnV0ZUludGVydmFsID0gNjAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9ucy5taW51dGVJbnRlcnZhbCA9IDEKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmlzTnVtYmVyKHRoaXMuc2Vjb25kSW50ZXJ2YWwpKSB7CiAgICAgICAgb3B0aW9ucy5zZWNvbmRJbnRlcnZhbCA9ICt0aGlzLnNlY29uZEludGVydmFsCiAgICAgIH0KICAgICAgLy8gc2Vjb25kSW50ZXJ2YWwgZmFpbHNhZmUKICAgICAgaWYgKCFvcHRpb25zLnNlY29uZEludGVydmFsIHx8IG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPCAxIHx8IG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPiA2MCkgewogICAgICAgIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgaWYgKG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPiA2MCkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKGAic2Vjb25kLWludGVydmFsIiBzaG91bGQgYmUgbGVzcyB0aGFuIDYwLiBDdXJyZW50IHZhbHVlIGlzICR7dGhpcy5zZWNvbmRJbnRlcnZhbH1gKQogICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnNlY29uZEludGVydmFsID09PSAwIHx8IG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPCAxKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYCJzZWNvbmQtaW50ZXJ2YWwiIHNob3VsZCBiZSBOTyBsZXNzIHRoYW4gMS4gQ3VycmVudCB2YWx1ZSBpcyAke3RoaXMuc2Vjb25kSW50ZXJ2YWx9YCkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPT09IDApIHsKICAgICAgICAgIG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPSA2MAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcHRpb25zLnNlY29uZEludGVydmFsID0gMQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuaG91clJhbmdlICYmIEFycmF5LmlzQXJyYXkodGhpcy5ob3VyUmFuZ2UpKSB7CiAgICAgICAgb3B0aW9ucy5ob3VyUmFuZ2UgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuaG91clJhbmdlKSkKICAgICAgICBpZiAoIXRoaXMuaG91clJhbmdlLmxlbmd0aCAmJiB0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZygnVGhlICJob3VyLXJhbmdlIiBhcnJheSBpcyBlbXB0eSAobGVuZ3RoID09PSAwKScpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5taW51dGVSYW5nZSAmJiBBcnJheS5pc0FycmF5KHRoaXMubWludXRlUmFuZ2UpKSB7CiAgICAgICAgb3B0aW9ucy5taW51dGVSYW5nZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5taW51dGVSYW5nZSkpCiAgICAgICAgaWYgKCF0aGlzLm1pbnV0ZVJhbmdlLmxlbmd0aCAmJiB0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZygnVGhlICJtaW51dGUtcmFuZ2UiIGFycmF5IGlzIGVtcHR5IChsZW5ndGggPT09IDApJykKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNlY29uZFJhbmdlICYmIEFycmF5LmlzQXJyYXkodGhpcy5zZWNvbmRSYW5nZSkpIHsKICAgICAgICBvcHRpb25zLnNlY29uZFJhbmdlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLnNlY29uZFJhbmdlKSkKICAgICAgICBpZiAoIXRoaXMuc2Vjb25kUmFuZ2UubGVuZ3RoICYmIHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdUaGUgInNlY29uZC1yYW5nZSIgYXJyYXkgaXMgZW1wdHkgKGxlbmd0aCA9PT0gMCknKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuaGlkZURpc2FibGVkSXRlbXMpIHsKICAgICAgICBvcHRpb25zLmhpZGVEaXNhYmxlZEl0ZW1zID0gdHJ1ZQogICAgICB9CgogICAgICBpZiAodGhpcy5oaWRlRGlzYWJsZWRIb3VycyB8fCB0aGlzLmhpZGVEaXNhYmxlZEl0ZW1zKSB7CiAgICAgICAgb3B0aW9ucy5oaWRlRGlzYWJsZWRIb3VycyA9IHRydWUKICAgICAgfQogICAgICBpZiAodGhpcy5oaWRlRGlzYWJsZWRNaW51dGVzIHx8IHRoaXMuaGlkZURpc2FibGVkSXRlbXMpIHsKICAgICAgICBvcHRpb25zLmhpZGVEaXNhYmxlZE1pbnV0ZXMgPSB0cnVlCiAgICAgIH0KICAgICAgaWYgKHRoaXMuaGlkZURpc2FibGVkU2Vjb25kcyB8fCB0aGlzLmhpZGVEaXNhYmxlZEl0ZW1zKSB7CiAgICAgICAgb3B0aW9ucy5oaWRlRGlzYWJsZWRTZWNvbmRzID0gdHJ1ZQogICAgICB9CgogICAgICBpZiAodGhpcy5oaWRlRHJvcGRvd24pIHsKICAgICAgICBpZiAodGhpcy5tYW51YWxJbnB1dCkgewogICAgICAgICAgb3B0aW9ucy5oaWRlRHJvcGRvd24gPSB0cnVlCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZygnImhpZGUtZHJvcGRvd24iIG9ubHkgd29ya3Mgd2l0aCAibWFudWFsLWlucHV0IiBtb2RlJykKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmJsdXJEZWxheSAmJiArdGhpcy5ibHVyRGVsYXkgPiAwKSB7CiAgICAgICAgb3B0aW9ucy5ibHVyRGVsYXkgPSArdGhpcy5ibHVyRGVsYXkKICAgICAgfQoKICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXRUaW1lb3V0ICYmICt0aGlzLm1hbnVhbElucHV0VGltZW91dCA+IDApIHsKICAgICAgICBvcHRpb25zLm1hbnVhbElucHV0VGltZW91dCA9ICt0aGlzLm1hbnVhbElucHV0VGltZW91dAogICAgICB9CgogICAgICBpZiAodGhpcy5kcm9wT2Zmc2V0SGVpZ2h0ICYmICt0aGlzLmRyb3BPZmZzZXRIZWlnaHQgPiAwKSB7CiAgICAgICAgb3B0aW9ucy5kcm9wT2Zmc2V0SGVpZ2h0ID0gK3RoaXMuZHJvcE9mZnNldEhlaWdodAogICAgICB9CgogICAgICByZXR1cm4gb3B0aW9ucwogICAgfSwKCiAgICB1c2VTdHJpbmdWYWx1ZSAoKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdGhpcy52YWx1ZSA9PT0gJ3N0cmluZycKICAgIH0sCgogICAgZm9ybWF0U3RyaW5nICgpIHsKICAgICAgcmV0dXJuIHRoaXMub3B0cy5mb3JtYXQgfHwgREVGQVVMVF9PUFRJT05TLmZvcm1hdAogICAgfSwKCiAgICBpblVzZSAoKSB7CiAgICAgIGNvbnN0IHR5cGVzSW5Vc2UgPSBDT05GSUcuQkFTSUNfVFlQRVMuZmlsdGVyKHR5cGUgPT4gdGhpcy5nZXRUb2tlbkJ5VHlwZSh0eXBlKSkKICAgICAgLy8gU29ydCB0eXBlcyBhbmQgdG9rZW5zIGJ5IHRoZWlyIHNlcXVlbmNlIGluIHRoZSAiZm9ybWF0IiBzdHJpbmcKICAgICAgdHlwZXNJblVzZS5zb3J0KChsLCByKSA9PiB7CiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0U3RyaW5nLmluZGV4T2YodGhpcy5nZXRUb2tlbkJ5VHlwZShsKSB8fCBudWxsKSAtIHRoaXMuZm9ybWF0U3RyaW5nLmluZGV4T2YodGhpcy5nZXRUb2tlbkJ5VHlwZShyKSB8fCBudWxsKQogICAgICB9KQogICAgICBjb25zdCB0b2tlbnNJblVzZSA9IHR5cGVzSW5Vc2UubWFwKHR5cGUgPT4gdGhpcy5nZXRUb2tlbkJ5VHlwZSh0eXBlKSkKICAgICAgcmV0dXJuIHsKICAgICAgICBob3VyOiAhIXRoaXMuaG91clR5cGUsCiAgICAgICAgbWludXRlOiAhIXRoaXMubWludXRlVHlwZSwKICAgICAgICBzZWNvbmQ6ICEhdGhpcy5zZWNvbmRUeXBlLAogICAgICAgIGFwbTogISF0aGlzLmFwbVR5cGUsCiAgICAgICAgdHlwZXM6IHR5cGVzSW5Vc2UgfHwgW10sCiAgICAgICAgdG9rZW5zOiB0b2tlbnNJblVzZSB8fCBbXQogICAgICB9CiAgICB9LAoKICAgIGRpc3BsYXlUaW1lICgpIHsKICAgICAgbGV0IGZvcm1hdFN0cmluZyA9IFN0cmluZyh0aGlzLmZvcm1hdFN0cmluZykKICAgICAgaWYgKHRoaXMuaG91cikgewogICAgICAgIGZvcm1hdFN0cmluZyA9IGZvcm1hdFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5ob3VyVHlwZSwgJ2cnKSwgdGhpcy5ob3VyKQogICAgICB9CiAgICAgIGlmICh0aGlzLm1pbnV0ZSkgewogICAgICAgIGZvcm1hdFN0cmluZyA9IGZvcm1hdFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5taW51dGVUeXBlLCAnZycpLCB0aGlzLm1pbnV0ZSkKICAgICAgfQogICAgICBpZiAodGhpcy5zZWNvbmQgJiYgdGhpcy5zZWNvbmRUeXBlKSB7CiAgICAgICAgZm9ybWF0U3RyaW5nID0gZm9ybWF0U3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cCh0aGlzLnNlY29uZFR5cGUsICdnJyksIHRoaXMuc2Vjb25kKQogICAgICB9CiAgICAgIGlmICh0aGlzLmFwbSAmJiB0aGlzLmFwbVR5cGUpIHsKICAgICAgICBmb3JtYXRTdHJpbmcgPSBmb3JtYXRTdHJpbmcucmVwbGFjZShuZXcgUmVnRXhwKHRoaXMuYXBtVHlwZSwgJ2cnKSwgdGhpcy5hcG0pCiAgICAgIH0KICAgICAgcmV0dXJuIGZvcm1hdFN0cmluZwogICAgfSwKCiAgICBjdXN0b21EaXNwbGF5VGltZSAoKSB7CiAgICAgIGlmICghdGhpcy5hbVRleHQgJiYgIXRoaXMucG1UZXh0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGxheVRpbWUKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5kaXNwbGF5VGltZS5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5hcG0sICdnJyksIHRoaXMuYXBtRGlzcGxheVRleHQodGhpcy5hcG0pKQogICAgfSwKCiAgICBpbnB1dElzRW1wdHkgKCkgewogICAgICByZXR1cm4gdGhpcy5mb3JtYXRTdHJpbmcgPT09IHRoaXMuZGlzcGxheVRpbWUKICAgIH0sCgogICAgYWxsVmFsdWVTZWxlY3RlZCAoKSB7CiAgICAgIGlmICgKICAgICAgICAodGhpcy5pblVzZS5ob3VyICYmICF0aGlzLmhvdXIpIHx8CiAgICAgICAgKHRoaXMuaW5Vc2UubWludXRlICYmICF0aGlzLm1pbnV0ZSkgfHwKICAgICAgICAodGhpcy5pblVzZS5zZWNvbmQgJiYgIXRoaXMuc2Vjb25kKSB8fAogICAgICAgICh0aGlzLmluVXNlLmFwbSAmJiAhdGhpcy5hcG0pCiAgICAgICkgewogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICAgIHJldHVybiB0cnVlCiAgICB9LAoKICAgIGNvbHVtbnNTZXF1ZW5jZSAoKSB7CiAgICAgIHJldHVybiB0aGlzLmluVXNlLnR5cGVzLm1hcCh0eXBlID0+IHR5cGUpIHx8IFtdCiAgICB9LAoKICAgIHNob3dDbGVhckJ0biAoKSB7CiAgICAgIGlmICh0aGlzLmhpZGVDbGVhckJ1dHRvbiB8fCB0aGlzLmRpc2FibGVkKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgICAgcmV0dXJuICF0aGlzLmlucHV0SXNFbXB0eQogICAgfSwKCiAgICBzaG93RHJvcGRvd25CdG4gKCkgewogICAgICBpZiAodGhpcy5maXhlZERyb3Bkb3duQnV0dG9uKSB7IHJldHVybiB0cnVlIH0KICAgICAgaWYgKHRoaXMub3B0cy5oaWRlRHJvcGRvd24gJiYgdGhpcy5pc0FjdGl2ZSAmJiAhdGhpcy5zaG93RHJvcGRvd24pIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZQogICAgfSwKCiAgICBiYXNlT24xMkhvdXJzICgpIHsKICAgICAgcmV0dXJuIHRoaXMuaG91clR5cGUgPT09ICdoJyB8fCB0aGlzLmhvdXJUeXBlID09PSAnaGgnCiAgICB9LAoKICAgIGhvdXJSYW5nZUluMjRIckZvcm1hdCAoKSB7CiAgICAgIGlmICghdGhpcy5ob3VyVHlwZSB8fCAhdGhpcy5vcHRzLmhvdXJSYW5nZSkgeyByZXR1cm4gZmFsc2UgfQogICAgICBpZiAoIXRoaXMub3B0cy5ob3VyUmFuZ2UubGVuZ3RoKSB7IHJldHVybiBbXSB9CgogICAgICBjb25zdCByYW5nZSA9IFtdCiAgICAgIHRoaXMub3B0cy5ob3VyUmFuZ2UuZm9yRWFjaCh2YWx1ZSA9PiB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAyICYmIHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYE5lc3RlZCBhcnJheSB3aXRoaW4gImhvdXItcmFuZ2UiIG11c3QgY29udGFpbiBubyBtb3JlIHRoYW4gdHdvIGl0ZW1zLiBPbmx5IHRoZSBmaXJzdCB0d28gaXRlbXMgb2YgJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9IHdpbGwgYmUgdGFrZW4gaW50byBhY2NvdW50LmApCiAgICAgICAgICB9CgogICAgICAgICAgbGV0IHN0YXJ0ID0gdmFsdWVbMF0KICAgICAgICAgIGxldCBlbmQgPSB2YWx1ZVsxXSB8fCB2YWx1ZVswXQoKICAgICAgICAgIGlmICh0aGlzLmlzMTJoUmFuZ2Uoc3RhcnQpKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy50cmFuc2xhdGUxMmhSYW5nZShzdGFydCkKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmlzMTJoUmFuZ2UoZW5kKSkgewogICAgICAgICAgICBlbmQgPSB0aGlzLnRyYW5zbGF0ZTEyaFJhbmdlKGVuZCkKICAgICAgICAgIH0KCiAgICAgICAgICBmb3IgKGxldCBpID0gK3N0YXJ0OyBpIDw9ICtlbmQ7IGkrKykgewogICAgICAgICAgICBpZiAoaSA8IDAgfHwgaSA+IDI0KSB7IGNvbnRpbnVlIH0KICAgICAgICAgICAgaWYgKCFyYW5nZS5pbmNsdWRlcyhpKSkgewogICAgICAgICAgICAgIHJhbmdlLnB1c2goaSkKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5pczEyaFJhbmdlKHZhbHVlKSkgewogICAgICAgICAgICB2YWx1ZSA9IHRoaXMudHJhbnNsYXRlMTJoUmFuZ2UodmFsdWUpCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9ICt2YWx1ZQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlIDwgMCB8fCB2YWx1ZSA+IDI0KSB7IHJldHVybiB9CiAgICAgICAgICBpZiAoIXJhbmdlLmluY2x1ZGVzKHZhbHVlKSkgewogICAgICAgICAgICByYW5nZS5wdXNoKHZhbHVlKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSkKICAgICAgcmFuZ2Uuc29ydCgobCwgcikgPT4geyByZXR1cm4gbCAtIHIgfSkKICAgICAgcmV0dXJuIHJhbmdlCiAgICB9LAoKICAgIHJlc3RyaWN0ZWRIb3VyUmFuZ2UgKCkgewogICAgICAvLyBObyByZXN0cmljdGlvbgogICAgICBpZiAoIXRoaXMuaG91clJhbmdlSW4yNEhyRm9ybWF0KSB7IHJldHVybiBmYWxzZSB9CiAgICAgIC8vIDEyLUhvdXIKICAgICAgaWYgKHRoaXMuYmFzZU9uMTJIb3VycykgewogICAgICAgIGNvbnN0IHJhbmdlID0gdGhpcy5ob3VyUmFuZ2VJbjI0SHJGb3JtYXQubWFwKCh2YWx1ZSkgPT4gewogICAgICAgICAgaWYgKHZhbHVlID09PSAxMikgewogICAgICAgICAgICByZXR1cm4gJzEycCcKICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IDI0IHx8IHZhbHVlID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAnMTJhJwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlID4gMTIgPyBgJHt2YWx1ZSAlIDEyfXBgIDogYCR7dmFsdWV9YWAKICAgICAgICB9KQogICAgICAgIHJldHVybiByYW5nZQogICAgICB9CiAgICAgIC8vIDI0LUhvdXIKICAgICAgcmV0dXJuIHRoaXMuaG91clJhbmdlSW4yNEhyRm9ybWF0CiAgICB9LAoKICAgIHZhbGlkSG91cnNMaXN0ICgpIHsKICAgICAgaWYgKCF0aGlzLm1hbnVhbElucHV0KSB7IHJldHVybiBmYWxzZSB9CiAgICAgIGlmICh0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UpIHsKICAgICAgICBsZXQgbGlzdCA9IFtdCiAgICAgICAgaWYgKHRoaXMuYmFzZU9uMTJIb3VycykgewogICAgICAgICAgbGlzdCA9IHRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZS5tYXAoaHIgPT4gewogICAgICAgICAgICBjb25zdCBsID0gaHIuc3Vic3RyKDAsIGhyLmxlbmd0aCAtIDEpCiAgICAgICAgICAgIGNvbnN0IHIgPSBoci5zdWJzdHIoLTEpCiAgICAgICAgICAgIHJldHVybiBgJHt0aGlzLmZvcm1hdFZhbHVlKHRoaXMuaG91clR5cGUsIGwpfSR7cn1gCiAgICAgICAgICB9KQogICAgICAgICAgY29uc3QgYW0xMkluZGV4ID0gbGlzdC5pbmRleE9mKCcxMmEnKQogICAgICAgICAgaWYgKGFtMTJJbmRleCA+IDApIHsKICAgICAgICAgICAgLy8gTWFrZSAnMTJhJyB0aGUgZmlyc3QgaXRlbSBpbiBoL2hoCiAgICAgICAgICAgIGxpc3QudW5zaGlmdChsaXN0LnNwbGljZShhbTEySW5kZXgsIDEpWzBdKQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3QKICAgICAgICB9CiAgICAgICAgbGlzdCA9IHRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZS5tYXAoaHIgPT4gewogICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0VmFsdWUodGhpcy5ob3VyVHlwZSwgaHIpCiAgICAgICAgfSkKICAgICAgICBpZiAobGlzdC5sZW5ndGggPiAxICYmIGxpc3RbMF0gJiYgbGlzdFswXSA9PT0gJzI0JykgewogICAgICAgICAgLy8gTWFrZSAnMjQnIHRoZSBsYXN0IGl0ZW0gaW4gay9rawogICAgICAgICAgbGlzdC5wdXNoKGxpc3Quc2hpZnQoKSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxpc3QKICAgICAgfQogICAgICBpZiAodGhpcy5iYXNlT24xMkhvdXJzKSB7CiAgICAgICAgcmV0dXJuIFtdLmNvbmNhdChbXSwgdGhpcy5ob3Vycy5tYXAoaHIgPT4gYCR7aHJ9YWApLCB0aGlzLmhvdXJzLm1hcChociA9PiBgJHtocn1wYCkpCiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaG91cnMKICAgIH0sCgogICAgaGFzICgpIHsKICAgICAgY29uc3QgcmVzdWx0ID0gewogICAgICAgIGN1c3RvbUFwbVRleHQ6IGZhbHNlCiAgICAgIH0KICAgICAgY29uc3QgYXBtRW5hYmxlZCA9ICEhdGhpcy5hcG1UeXBlCgogICAgICBpZiAoYXBtRW5hYmxlZCAmJiB0aGlzLmhvdXJSYW5nZUluMjRIckZvcm1hdCAmJiB0aGlzLmhvdXJSYW5nZUluMjRIckZvcm1hdC5sZW5ndGgpIHsKICAgICAgICBjb25zdCByYW5nZSA9IFtdLmNvbmNhdChbXSwgdGhpcy5ob3VyUmFuZ2VJbjI0SHJGb3JtYXQpCiAgICAgICAgcmVzdWx0LmFtID0gcmFuZ2Uuc29tZSh2YWx1ZSA9PiB2YWx1ZSA8IDEyIHx8IHZhbHVlID09PSAyNCkKICAgICAgICByZXN1bHQucG0gPSByYW5nZS5zb21lKHZhbHVlID0+IHZhbHVlID49IDEyICYmIHZhbHVlIDwgMjQpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LmFtID0gYXBtRW5hYmxlZAogICAgICAgIHJlc3VsdC5wbSA9IGFwbUVuYWJsZWQKICAgICAgfQogICAgICBpZiAoKHRoaXMuYW1UZXh0ICYmIHRoaXMuYW1UZXh0Lmxlbmd0aCkgfHwgKHRoaXMucG1UZXh0ICYmIHRoaXMucG1UZXh0Lmxlbmd0aCkpIHsKICAgICAgICByZXN1bHQuY3VzdG9tQXBtVGV4dCA9IHRydWUKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9LAoKICAgIG1pbnV0ZVJhbmdlTGlzdCAoKSB7CiAgICAgIGlmICghdGhpcy5taW51dGVUeXBlIHx8ICF0aGlzLm9wdHMubWludXRlUmFuZ2UpIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgaWYgKCF0aGlzLm9wdHMubWludXRlUmFuZ2UubGVuZ3RoKSB7IHJldHVybiBbXSB9CiAgICAgIHJldHVybiB0aGlzLnJlbmRlclJhbmdlTGlzdCh0aGlzLm9wdHMubWludXRlUmFuZ2UsICdtaW51dGUnKQogICAgfSwKCiAgICBzZWNvbmRSYW5nZUxpc3QgKCkgewogICAgICBpZiAoIXRoaXMuc2Vjb25kVHlwZSB8fCAhdGhpcy5vcHRzLnNlY29uZFJhbmdlKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIGlmICghdGhpcy5vcHRzLnNlY29uZFJhbmdlLmxlbmd0aCkgeyByZXR1cm4gW10gfQogICAgICByZXR1cm4gdGhpcy5yZW5kZXJSYW5nZUxpc3QodGhpcy5vcHRzLnNlY29uZFJhbmdlLCAnc2Vjb25kJykKICAgIH0sCiAgICAKICAgIGhvdXJMYWJlbFRleHQgKCkgewogICAgICByZXR1cm4gdGhpcy5ob3VyTGFiZWwgfHwgdGhpcy5ob3VyVHlwZQogICAgfSwKICAgIG1pbnV0ZUxhYmVsVGV4dCAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1pbnV0ZUxhYmVsIHx8IHRoaXMubWludXRlVHlwZQogICAgfSwKICAgIHNlY29uZExhYmVsVGV4dCgpIHsKICAgICAgcmV0dXJuIHRoaXMuc2Vjb25kTGFiZWwgfHwgdGhpcy5zZWNvbmRUeXBlCiAgICB9LAogICAgYXBtTGFiZWxUZXh0ICgpIHsKICAgICAgcmV0dXJuIHRoaXMuYXBtTGFiZWwgfHwgdGhpcy5hcG1UeXBlCiAgICB9LAoKICAgIGlucHV0V2lkdGhTdHlsZSAoKSB7CiAgICAgIGlmICghdGhpcy5pbnB1dFdpZHRoIHx8ICF0aGlzLmlucHV0V2lkdGgubGVuZ3RoKSB7IHJldHVybiB9CiAgICAgIHJldHVybiB7CiAgICAgICAgd2lkdGg6IHRoaXMuaW5wdXRXaWR0aAogICAgICB9CiAgICB9LAoKICAgIHRva2VuUmVnZXhCYXNlICgpIHsKICAgICAgcmV0dXJuIHRoaXMuaW5Vc2UudG9rZW5zLmpvaW4oJ3wnKQogICAgfSwKCiAgICB0b2tlbkNodW5rcyAoKSB7CiAgICAgIGlmICghdGhpcy5tYW51YWxJbnB1dCAmJiAhdGhpcy51c2VTdHJpbmdWYWx1ZSkgeyByZXR1cm4gZmFsc2UgfQoKICAgICAgY29uc3QgZm9ybWF0U3RyaW5nID0gU3RyaW5nKHRoaXMuZm9ybWF0U3RyaW5nKQogICAgICBjb25zdCB0b2tlbnNSZWd4U3RyID0gYCgke3RoaXMudG9rZW5SZWdleEJhc2V9KSs/YAogICAgICBjb25zdCB0b2tlbnNNYXRjaEFsbCA9IHRoaXMuZ2V0TWF0Y2hBbGxCeVJlZ2V4KGZvcm1hdFN0cmluZywgdG9rZW5zUmVneFN0cikKCiAgICAgIGNvbnN0IHRva2VuQ2h1bmtzID0gW10KICAgICAgZm9yIChsZXQgdGtNYXRjaCBvZiB0b2tlbnNNYXRjaEFsbCkgewogICAgICAgIGNvbnN0IHJhd1Rva2VuID0gdGtNYXRjaFswXQogICAgICAgIGNvbnN0IHRva2VuTWF0Y2hJdGVtID0gewogICAgICAgICAgaW5kZXg6IHRrTWF0Y2guaW5kZXgsCiAgICAgICAgICB0b2tlbjogcmF3VG9rZW4sCiAgICAgICAgICB0eXBlOiB0aGlzLmdldFRva2VuVHlwZShyYXdUb2tlbiksCiAgICAgICAgICBuZWVkc0NhbGlicmF0ZTogcmF3VG9rZW4ubGVuZ3RoIDwgMiwKICAgICAgICAgIGxlbjogKHJhd1Rva2VuIHx8ICcnKS5sZW5ndGgKICAgICAgICB9CiAgICAgICAgdG9rZW5DaHVua3MucHVzaCh0b2tlbk1hdGNoSXRlbSkKICAgICAgfQogICAgICByZXR1cm4gdG9rZW5DaHVua3MKICAgIH0sCgogICAgbmVlZHNQb3NDYWxpYnJhdGUgKCkgewogICAgICBpZiAoIXRoaXMubWFudWFsSW5wdXQpIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgcmV0dXJuIHRoaXMudG9rZW5DaHVua3Muc29tZShjaGsgPT4gY2hrLm5lZWRzQ2FsaWJyYXRlKQogICAgfSwKCiAgICB0b2tlbkNodW5rc1BvcyAoKSB7CiAgICAgIGlmICghdGhpcy5tYW51YWxJbnB1dCkgeyByZXR1cm4gZmFsc2UgfQogICAgICBpZiAoIXRoaXMubmVlZHNQb3NDYWxpYnJhdGUpIHsKICAgICAgICByZXR1cm4gdGhpcy50b2tlbkNodW5rcy5tYXAoY2hrID0+IHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHRva2VuOiBjaGsudG9rZW4sCiAgICAgICAgICAgIHR5cGU6IGNoay50eXBlLAogICAgICAgICAgICBzdGFydDogY2hrLmluZGV4LAogICAgICAgICAgICBlbmQ6IGNoay5pbmRleCArIGNoay5sZW4KICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9CiAgICAgIGNvbnN0IGxpc3QgPSBbXQogICAgICBsZXQgY2FsaWJyYXRlTGVuID0gMAogICAgICB0aGlzLnRva2VuQ2h1bmtzLmZvckVhY2goY2hrID0+IHsKICAgICAgICBsZXQgY2h1bmtDdXJyZW50TGVuCiAgICAgICAgLy8gQWRqdXN0IGZvciBjdXN0b21pemVkIEFNL1BNIHRleHQKICAgICAgICBpZiAoY2hrLnR5cGUgPT09ICdhcG0nICYmIHRoaXMuaGFzLmN1c3RvbUFwbVRleHQpIHsKICAgICAgICAgIGlmICh0aGlzLmFwbSAmJiB0aGlzLmFwbS5sZW5ndGgpIHsKICAgICAgICAgICAgY29uc3QgY3VzdG9tQXBtVGV4dCA9IHRoaXMuYXBtLnRvTG93ZXJDYXNlKCkgPT09ICdhbScgPyB0aGlzLmFtVGV4dCA6IHRoaXMucG1UZXh0CiAgICAgICAgICAgIGNodW5rQ3VycmVudExlbiA9IChjdXN0b21BcG1UZXh0ICYmIGN1c3RvbUFwbVRleHQubGVuZ3RoKSA/IGN1c3RvbUFwbVRleHQubGVuZ3RoIDogY2hrLmxlbgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2h1bmtDdXJyZW50TGVuID0gY2hrLmxlbgogICAgICAgICAgfQogICAgICAgIC8vIE90aGVycwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaHVua0N1cnJlbnRMZW4gPSB0aGlzW2Noay50eXBlXSAmJiB0aGlzW2Noay50eXBlXS5sZW5ndGggPyB0aGlzW2Noay50eXBlXS5sZW5ndGggOiBjaGsubGVuCiAgICAgICAgfQogICAgICAgIGxpc3QucHVzaCh7CiAgICAgICAgICB0b2tlbjogY2hrLnRva2VuLAogICAgICAgICAgdHlwZTogY2hrLnR5cGUsCiAgICAgICAgICBzdGFydDogY2hrLmluZGV4ICsgY2FsaWJyYXRlTGVuLAogICAgICAgICAgZW5kOiBjaGsuaW5kZXggKyBjYWxpYnJhdGVMZW4gKyBjaHVua0N1cnJlbnRMZW4KICAgICAgICB9KQogICAgICAgIGlmIChjaGsubmVlZHNDYWxpYnJhdGUgJiYgY2h1bmtDdXJyZW50TGVuID4gY2hrLmxlbikgewogICAgICAgICAgY2FsaWJyYXRlTGVuICs9IChjaHVua0N1cnJlbnRMZW4gLSBjaGsubGVuKQogICAgICAgIH0KICAgICAgfSkKICAgICAgcmV0dXJuIGxpc3QKICAgIH0sCgogICAgaW52YWxpZFZhbHVlcyAoKSB7CiAgICAgIGlmICh0aGlzLmlucHV0SXNFbXB0eSkgeyByZXR1cm4gW10gfQogICAgICBpZiAoIXRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZSAmJiAhdGhpcy5taW51dGVSYW5nZUxpc3QgJiYgIXRoaXMuc2Vjb25kUmFuZ2VMaXN0ICYmIHRoaXMub3B0cy5taW51dGVJbnRlcnZhbCA9PT0gMSAmJiB0aGlzLm9wdHMuc2Vjb25kSW50ZXJ2YWwgPT09IDEpIHsgcmV0dXJuIFtdIH0KCiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdCiAgICAgIGlmICh0aGlzLmluVXNlLmhvdXIgJiYgIXRoaXMuaXNFbXB0eVZhbHVlKHRoaXMuaG91clR5cGUsIHRoaXMuaG91cikgJiYgKCF0aGlzLmlzVmFsaWRWYWx1ZSh0aGlzLmhvdXJUeXBlLCB0aGlzLmhvdXIpIHx8IHRoaXMuaXNEaXNhYmxlZCgnaG91cicsIHRoaXMuaG91cikpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goJ2hvdXInKQogICAgICB9CiAgICAgIGlmICh0aGlzLmluVXNlLm1pbnV0ZSAmJiAhdGhpcy5pc0VtcHR5VmFsdWUodGhpcy5taW51dGVUeXBlLCB0aGlzLm1pbnV0ZSkgJiYgKCF0aGlzLmlzVmFsaWRWYWx1ZSh0aGlzLm1pbnV0ZVR5cGUsIHRoaXMubWludXRlKSB8fCB0aGlzLmlzRGlzYWJsZWQoJ21pbnV0ZScsIHRoaXMubWludXRlKSB8fCB0aGlzLm5vdEluSW50ZXJ2YWwoJ21pbnV0ZScsIHRoaXMubWludXRlKSkpIHsKICAgICAgICByZXN1bHQucHVzaCgnbWludXRlJykKICAgICAgfQogICAgICBpZiAodGhpcy5pblVzZS5zZWNvbmQgJiYgIXRoaXMuaXNFbXB0eVZhbHVlKHRoaXMuc2Vjb25kVHlwZSwgdGhpcy5zZWNvbmQpICYmICghdGhpcy5pc1ZhbGlkVmFsdWUodGhpcy5zZWNvbmRUeXBlLCB0aGlzLnNlY29uZCkgfHwgdGhpcy5pc0Rpc2FibGVkKCdzZWNvbmQnLCB0aGlzLnNlY29uZCkgfHwgdGhpcy5ub3RJbkludGVydmFsKCdzZWNvbmQnLCB0aGlzLnNlY29uZCkpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goJ3NlY29uZCcpCiAgICAgIH0KICAgICAgaWYgKHRoaXMuaW5Vc2UuYXBtICYmICF0aGlzLmlzRW1wdHlWYWx1ZSh0aGlzLmFwbVR5cGUsIHRoaXMuYXBtKSAmJiAoIXRoaXMuaXNWYWxpZFZhbHVlKHRoaXMuYXBtVHlwZSwgdGhpcy5hcG0pIHx8IHRoaXMuaXNEaXNhYmxlZCgnYXBtJywgdGhpcy5hcG0pKSkgewogICAgICAgIHJlc3VsdC5wdXNoKCdhcG0nKQogICAgICB9CiAgICAgIGlmIChyZXN1bHQubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHJldHVybiBbXQogICAgfSwKCiAgICBoYXNJbnZhbGlkSW5wdXQgKCkgewogICAgICByZXR1cm4gQm9vbGVhbih0aGlzLmludmFsaWRWYWx1ZXMgJiYgdGhpcy5pbnZhbGlkVmFsdWVzLmxlbmd0aCkKICAgIH0sCgogICAgYXV0b0RpcmVjdGlvbkVuYWJsZWQgKCkgewogICAgICByZXR1cm4gdGhpcy5kcm9wRGlyZWN0aW9uID09PSAnYXV0bycKICAgIH0sCgogICAgZHJvcGRvd25EaXJDbGFzcyAoKSB7CiAgICAgIGlmICh0aGlzLmF1dG9EaXJlY3Rpb25FbmFibGVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZm9yY2VEcm9wT25Ub3AgPyAnZHJvcC11cCcgOiAnZHJvcC1kb3duJwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmRyb3BEaXJlY3Rpb24gPT09ICd1cCcgPyAnZHJvcC11cCcgOiAnZHJvcC1kb3duJyAgICAgIAogICAgfQogIH0sCgogIHdhdGNoOiB7CiAgICAnb3B0cy5mb3JtYXQnIChuZXdWYWx1ZSkgewogICAgICB0aGlzLnJlbmRlckZvcm1hdChuZXdWYWx1ZSkKICAgIH0sCiAgICAnb3B0cy5taW51dGVJbnRlcnZhbCcgKG5ld0ludGV2YWwpIHsKICAgICAgdGhpcy5yZW5kZXJMaXN0KCdtaW51dGUnLCBuZXdJbnRldmFsKQogICAgfSwKICAgICdvcHRzLnNlY29uZEludGVydmFsJyAobmV3SW50ZXZhbCkgewogICAgICB0aGlzLnJlbmRlckxpc3QoJ3NlY29uZCcsIG5ld0ludGV2YWwpCiAgICB9LAogICAgdmFsdWU6IHsKICAgICAgZGVlcDogdHJ1ZSwKICAgICAgaGFuZGxlciAoKSB7CiAgICAgICAgdGhpcy5yZWFkVmFsdWVzKCkKICAgICAgfQogICAgfSwKICAgIGRpc3BsYXlUaW1lICgpIHsKICAgICAgdGhpcy5maWxsVmFsdWVzKCkKICAgIH0sCiAgICBkaXNhYmxlZCAodG9EaXNhYmxlZCkgewogICAgICBpZiAodG9EaXNhYmxlZCkgewogICAgICAgIC8vIEZvcmNlIGNsb3NlIGRyb3Bkb3duIGFuZCByZXNldCBzdGF0dXMgd2hlbiBkaXNhYmxlZAogICAgICAgIGlmICh0aGlzLmlzQWN0aXZlKSB7CiAgICAgICAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc2hvd0Ryb3Bkb3duKSB7CiAgICAgICAgICB0aGlzLnNob3dEcm9wZG93biA9IGZhbHNlCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgJ2ludmFsaWRWYWx1ZXMubGVuZ3RoJyAobmV3TGVuZ3RoLCBvbGRMZW5ndGgpIHsKICAgICAgaWYgKG5ld0xlbmd0aCAmJiBuZXdMZW5ndGggPj0gMSkgewogICAgICAgIHRoaXMuJGVtaXQoJ2Vycm9yJywgdGhpcy5pbnZhbGlkVmFsdWVzKQogICAgICB9IGVsc2UgaWYgKG9sZExlbmd0aCAmJiBvbGRMZW5ndGggPj0gMSkgewogICAgICAgIHRoaXMuJGVtaXQoJ2Vycm9yJywgW10pCiAgICAgIH0KICAgIH0KICB9LAoKICBtZXRob2RzOiB7CiAgICBmb3JtYXRWYWx1ZSAodG9rZW4sIGkpIHsKICAgICAgaWYgKCF0aGlzLmlzTnVtYmVyKGkpKSB7IHJldHVybiAnJyB9CiAgICAgIGkgPSAraQogICAgICBzd2l0Y2ggKHRva2VuKSB7CiAgICAgICAgY2FzZSAnSCc6CiAgICAgICAgY2FzZSAnaCc6CiAgICAgICAgY2FzZSAnayc6CiAgICAgICAgY2FzZSAnbSc6CiAgICAgICAgY2FzZSAncyc6CiAgICAgICAgICBpZiAoWydoJywgJ2snXS5pbmNsdWRlcyh0b2tlbikgJiYgaSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gdG9rZW4gPT09ICdrJyA/ICcyNCcgOiAnMTInCiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gU3RyaW5nKGkpCiAgICAgICAgY2FzZSAnSEgnOgogICAgICAgIGNhc2UgJ21tJzoKICAgICAgICBjYXNlICdzcyc6CiAgICAgICAgY2FzZSAnaGgnOgogICAgICAgIGNhc2UgJ2trJzoKICAgICAgICAgIGlmIChbJ2hoJywgJ2trJ10uaW5jbHVkZXModG9rZW4pICYmIGkgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRva2VuID09PSAna2snID8gJzI0JyA6ICcxMicKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpIDwgMTAgPyBgMCR7aX1gIDogU3RyaW5nKGkpCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiAnJwogICAgICB9CiAgICB9LAoKICAgIGNoZWNrQWNjZXB0aW5nVHlwZSAodmFsaWRWYWx1ZXMsIGZvcm1hdFN0cmluZykgewogICAgICBpZiAoIXZhbGlkVmFsdWVzIHx8ICFmb3JtYXRTdHJpbmcgfHwgIWZvcm1hdFN0cmluZy5sZW5ndGgpIHsgcmV0dXJuICcnIH0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWxpZFZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChmb3JtYXRTdHJpbmcuaW5kZXhPZih2YWxpZFZhbHVlc1tpXSkgPiAtMSkgewogICAgICAgICAgcmV0dXJuIHZhbGlkVmFsdWVzW2ldCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAnJwogICAgfSwKCiAgICByZW5kZXJGb3JtYXQgKG5ld0Zvcm1hdCkgewogICAgICBuZXdGb3JtYXQgPSBuZXdGb3JtYXQgfHwgdGhpcy5vcHRzLmZvcm1hdCB8fCBERUZBVUxUX09QVElPTlMuZm9ybWF0CgogICAgICBsZXQgaG91clR5cGUgPSB0aGlzLmNoZWNrQWNjZXB0aW5nVHlwZShDT05GSUcuSE9VUl9UT0tFTlMsIG5ld0Zvcm1hdCkKICAgICAgbGV0IG1pbnV0ZVR5cGUgPSB0aGlzLmNoZWNrQWNjZXB0aW5nVHlwZShDT05GSUcuTUlOVVRFX1RPS0VOUywgbmV3Rm9ybWF0KQogICAgICB0aGlzLnNlY29uZFR5cGUgPSB0aGlzLmNoZWNrQWNjZXB0aW5nVHlwZShDT05GSUcuU0VDT05EX1RPS0VOUywgbmV3Rm9ybWF0KQogICAgICB0aGlzLmFwbVR5cGUgPSB0aGlzLmNoZWNrQWNjZXB0aW5nVHlwZShDT05GSUcuQVBNX1RPS0VOUywgbmV3Rm9ybWF0KQoKICAgICAgLy8gRmFpbHNhZmUgY2hlY2tpbmcKICAgICAgaWYgKCFob3VyVHlwZSAmJiAhbWludXRlVHlwZSAmJiAhdGhpcy5zZWNvbmRUeXBlICYmICF0aGlzLmFwbVR5cGUpIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUgJiYgdGhpcy5mb3JtYXQpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYE5vIHZhbGlkIHRva2VucyBmb3VuZCBpbiB5b3VyIGRlZmluZWQgImZvcm1hdCIgc3RyaW5nICIke3RoaXMuZm9ybWF0fSIuIEZhbGxiYWNrIHRvIHRoZSBkZWZhdWx0ICJISDptbSIgZm9ybWF0LmApCiAgICAgICAgfQogICAgICAgIGhvdXJUeXBlID0gJ0hIJwogICAgICAgIG1pbnV0ZVR5cGUgPSAnbW0nCiAgICAgIH0KICAgICAgdGhpcy5ob3VyVHlwZSA9IGhvdXJUeXBlCiAgICAgIHRoaXMubWludXRlVHlwZSA9IG1pbnV0ZVR5cGUKCiAgICAgIHRoaXMuaG91clR5cGUgPyB0aGlzLnJlbmRlckhvdXJzTGlzdCgpIDogdGhpcy5ob3VycyA9IFtdCiAgICAgIHRoaXMubWludXRlVHlwZSA/IHRoaXMucmVuZGVyTGlzdCgnbWludXRlJykgOiB0aGlzLm1pbnV0ZXMgPSBbXQogICAgICB0aGlzLnNlY29uZFR5cGUgPyB0aGlzLnJlbmRlckxpc3QoJ3NlY29uZCcpIDogdGhpcy5zZWNvbmRzID0gW10KICAgICAgdGhpcy5hcG1UeXBlID8gdGhpcy5yZW5kZXJBcG1MaXN0KCkgOiB0aGlzLmFwbXMgPSBbXQoKICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgIHRoaXMucmVhZFZhbHVlcygpCiAgICAgIH0pCiAgICB9LAoKICAgIHJlbmRlckhvdXJzTGlzdCAoKSB7CiAgICAgIGNvbnN0IGhvdXJzQ291bnQgPSB0aGlzLmJhc2VPbjEySG91cnMgPyAxMiA6IDI0CiAgICAgIGNvbnN0IGhvdXJzID0gW10KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBob3Vyc0NvdW50OyBpKyspIHsKICAgICAgICBpZiAodGhpcy5ob3VyVHlwZSA9PT0gJ2snIHx8IHRoaXMuaG91clR5cGUgPT09ICdraycpIHsKICAgICAgICAgIGhvdXJzLnB1c2godGhpcy5mb3JtYXRWYWx1ZSh0aGlzLmhvdXJUeXBlLCBpICsgMSkpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhvdXJzLnB1c2godGhpcy5mb3JtYXRWYWx1ZSh0aGlzLmhvdXJUeXBlLCBpKSkKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5ob3VycyA9IGhvdXJzCiAgICB9LAoKICAgIHJlbmRlckxpc3QgKGxpc3RUeXBlLCBpbnRlcnZhbCkgewogICAgICBpZiAoIXRoaXMuaXNNaW51dGVPclNlY29uZChsaXN0VHlwZSkpIHsgcmV0dXJuIH0KCiAgICAgIGNvbnN0IGlzTWludXRlID0gbGlzdFR5cGUgPT09ICdtaW51dGUnCiAgICAgIGludGVydmFsID0gaW50ZXJ2YWwgfHwgKGlzTWludXRlID8gKHRoaXMub3B0cy5taW51dGVJbnRlcnZhbCB8fCBERUZBVUxUX09QVElPTlMubWludXRlSW50ZXJ2YWwpIDogKHRoaXMub3B0cy5zZWNvbmRJbnRlcnZhbCB8fCBERUZBVUxUX09QVElPTlMuc2Vjb25kSW50ZXJ2YWwpKQoKICAgICAgY29uc3QgcmVzdWx0ID0gW10KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2MDsgaSArPSBpbnRlcnZhbCkgewogICAgICAgIHJlc3VsdC5wdXNoKHRoaXMuZm9ybWF0VmFsdWUoaXNNaW51dGUgPyB0aGlzLm1pbnV0ZVR5cGUgOiB0aGlzLnNlY29uZFR5cGUsIGkpKQogICAgICB9CiAgICAgIGlzTWludXRlID8gdGhpcy5taW51dGVzID0gcmVzdWx0IDogdGhpcy5zZWNvbmRzID0gcmVzdWx0CiAgICB9LAoKICAgIHJlbmRlckFwbUxpc3QgKCkgewogICAgICB0aGlzLmFwbXMgPSB0aGlzLmFwbVR5cGUgPT09ICdBJyA/IFsnQU0nLCAnUE0nXSA6IFsnYW0nLCAncG0nXQogICAgfSwKCiAgICByZWFkVmFsdWVzICgpIHsKICAgICAgaWYgKHRoaXMudXNlU3RyaW5nVmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFJlY2VpdmVkIGEgc3RyaW5nIHZhbHVlOiAiJHt0aGlzLnZhbHVlfSJgKQogICAgICAgIH0KICAgICAgICB0aGlzLnJlYWRTdHJpbmdWYWx1ZXModGhpcy52YWx1ZSkKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFJlY2VpdmVkIGFuIG9iamVjdCB2YWx1ZTogIiR7SlNPTi5zdHJpbmdpZnkodGhpcy52YWx1ZSB8fCB7fSl9ImApCiAgICAgICAgfQogICAgICAgIHRoaXMucmVhZE9iamVjdFZhbHVlcyh0aGlzLnZhbHVlKQogICAgICB9CiAgICB9LAoKICAgIHJlYWRPYmplY3RWYWx1ZXMgKG9ialZhbHVlKSB7CiAgICAgIGNvbnN0IHRpbWVWYWx1ZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqVmFsdWUgfHwge30pKQogICAgICBjb25zdCB2YWx1ZXMgPSBPYmplY3Qua2V5cyh0aW1lVmFsdWUpCgogICAgICAvLyBGYWlsc2FmZSBmb3IgZW1wdHkgYHYtbW9kZWxgIG9iamVjdAogICAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuYWRkRmFsbGJhY2tWYWx1ZXMoKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBDT05GSUcuQkFTSUNfVFlQRVMuZm9yRWFjaCh0eXBlID0+IHsKICAgICAgICBjb25zdCB0b2tlbiA9IHRoaXMuZ2V0VG9rZW5CeVR5cGUodHlwZSkKICAgICAgICBpZiAodmFsdWVzLmluZGV4T2YodG9rZW4pID4gLTEpIHsKICAgICAgICAgIGNvbnN0IHNhbml0aXplZFZhbHVlID0gdGhpcy5zYW5pdGl6ZWRWYWx1ZSh0b2tlbiwgdGltZVZhbHVlW3Rva2VuXSkKICAgICAgICAgIHRoaXNbdHlwZV0gPSBzYW5pdGl6ZWRWYWx1ZQogICAgICAgICAgdGltZVZhbHVlW3Rva2VuXSA9IHNhbml0aXplZFZhbHVlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbdHlwZV0gPSAnJwogICAgICAgIH0KICAgICAgfSkKICAgICAgdGhpcy50aW1lVmFsdWUgPSB0aW1lVmFsdWUKICAgIH0sCgogICAgZ2V0TWF0Y2hBbGxCeVJlZ2V4ICh0ZXN0U3RyaW5nLCByZWdleFN0cmluZykgewogICAgICBjb25zdCBzdHIgPSAncG9seWZpbGxUZXN0JwogICAgICBjb25zdCBuZWVkc1BvbHlmaWxsID0gQm9vbGVhbighc3RyLm1hdGNoQWxsIHx8IHR5cGVvZiBzdHIubWF0Y2hBbGwgIT09ICdmdW5jdGlvbicpCiAgICAgIHJldHVybiBuZWVkc1BvbHlmaWxsID8gdGhpcy5wb2x5ZmlsbE1hdGNoQWxsKHRlc3RTdHJpbmcsIHJlZ2V4U3RyaW5nKSA6IHRlc3RTdHJpbmcubWF0Y2hBbGwobmV3IFJlZ0V4cChyZWdleFN0cmluZywgJ2cnKSkKICAgIH0sCgogICAgcmVhZFN0cmluZ1ZhbHVlcyAoc3RyaW5nVmFsdWUpIHsKICAgICAgLy8gRmFpbHNhZmUgZm9yIGVtcHR5IGB2LW1vZGVsYCBzdHJpbmcKICAgICAgaWYgKCFzdHJpbmdWYWx1ZSB8fCAhc3RyaW5nVmFsdWUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5hZGRGYWxsYmFja1ZhbHVlcygpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGNvbnN0IGZvcm1hdFN0cmluZyA9IFN0cmluZyh0aGlzLmZvcm1hdFN0cmluZykKICAgICAgY29uc3QgdG9rZW5zUmVneFN0ciA9IGAoJHt0aGlzLnRva2VuUmVnZXhCYXNlfSkrP2AKICAgICAgY29uc3Qgb3RoZXJzUmVneFN0ciA9IGBbXigke3RoaXMudG9rZW5SZWdleEJhc2V9KV0rYAoKICAgICAgY29uc3QgdG9rZW5zTWF0Y2hBbGwgPSB0aGlzLmdldE1hdGNoQWxsQnlSZWdleChmb3JtYXRTdHJpbmcsIHRva2Vuc1JlZ3hTdHIpCiAgICAgIGNvbnN0IG90aGVyc01hdGNoQWxsID0gdGhpcy5nZXRNYXRjaEFsbEJ5UmVnZXgoZm9ybWF0U3RyaW5nLCBvdGhlcnNSZWd4U3RyKQoKICAgICAgY29uc3QgY2h1bmtzID0gW10KICAgICAgY29uc3QgdG9rZW5DaHVua3MgPSBbXQoKICAgICAgZm9yIChsZXQgdGtNYXRjaCBvZiB0b2tlbnNNYXRjaEFsbCkgewogICAgICAgIGNvbnN0IHRva2VuTWF0Y2hJdGVtID0gewogICAgICAgICAgaW5kZXg6IHRrTWF0Y2guaW5kZXgsCiAgICAgICAgICB0b2tlbjogdGtNYXRjaFswXSwKICAgICAgICAgIGlzVmFsdWVUb2tlbjogdHJ1ZQogICAgICAgIH0KICAgICAgICBjaHVua3MucHVzaCh0b2tlbk1hdGNoSXRlbSkKICAgICAgICB0b2tlbkNodW5rcy5wdXNoKHRva2VuTWF0Y2hJdGVtKQogICAgICB9CgogICAgICBmb3IgKGxldCBvdE1hdGNoIG9mIG90aGVyc01hdGNoQWxsKSB7CiAgICAgICAgY2h1bmtzLnB1c2goewogICAgICAgICAgaW5kZXg6IG90TWF0Y2guaW5kZXgsCiAgICAgICAgICB0b2tlbjogb3RNYXRjaFswXQogICAgICAgIH0pCiAgICAgIH0KCiAgICAgIGNodW5rcy5zb3J0KChsLCByKSA9PiBsLmluZGV4IDwgci5pbmRleCA/IC0xIDogMSkKCiAgICAgIGxldCByZWdleENvbWJvID0gJycKICAgICAgY2h1bmtzLmZvckVhY2goY2h1bmsgPT4gewogICAgICAgIGlmIChjaHVuay5pc1ZhbHVlVG9rZW4pIHsKICAgICAgICAgIGNvbnN0IHRva2VuUmVnZXggPSB0aGlzLmdldFRva2VuUmVnZXgoY2h1bmsudG9rZW4pIHx8ICcnCiAgICAgICAgICByZWdleENvbWJvICs9IHRva2VuUmVnZXgKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgc2FmZUNoYXJzID0gY2h1bmsudG9rZW4ucmVwbGFjZSgvXFx7MH0oXCp8XD98XC58XCspL2csICdcXCQxJykKICAgICAgICAgIHJlZ2V4Q29tYm8gKz0gYCg/OiR7c2FmZUNoYXJzfSlgCiAgICAgICAgfQogICAgICB9KQoKICAgICAgY29uc3QgY29tYm9SZWcgPSBuZXcgUmVnRXhwKHJlZ2V4Q29tYm8pCgogICAgICAvLyBEbyB0ZXN0IGJlZm9yZSBtYXRjaAogICAgICBpZiAoY29tYm9SZWcudGVzdChzdHJpbmdWYWx1ZSkpIHsKICAgICAgICBjb25zdCBtYXRjaFJlc3VsdHMgPSBzdHJpbmdWYWx1ZS5tYXRjaChuZXcgUmVnRXhwKHJlZ2V4Q29tYm8pKQogICAgICAgIGNvbnN0IHZhbHVlUmVzdWx0cyA9IG1hdGNoUmVzdWx0cy5zbGljZSgxLCB0b2tlbkNodW5rcy5sZW5ndGggKyAxKQogICAgICAgIGNvbnN0IHRpbWVWYWx1ZSA9IHt9CiAgICAgICAgdmFsdWVSZXN1bHRzLmZvckVhY2goKHZhbHVlLCB2ckluZGV4KSA9PiB7CiAgICAgICAgICBpZiAodG9rZW5DaHVua3NbdnJJbmRleF0pIHsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0VG9rZW4gPSB0b2tlbkNodW5rc1t2ckluZGV4XS50b2tlbgogICAgICAgICAgICB0aW1lVmFsdWVbdGFyZ2V0VG9rZW5dID0gdGhpcy5zZXRWYWx1ZUZyb21TdHJpbmcodmFsdWUsIHRhcmdldFRva2VuKQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgdGhpcy50aW1lVmFsdWUgPSB0aW1lVmFsdWUKCiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICBjb25zdCB0b2tlbkNodW5rc0ZvckxvZyA9IHRva2VuQ2h1bmtzLm1hcCh0Q2h1bmsgPT4gdENodW5rICYmIHRDaHVuay50b2tlbikKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFN1Y2Nlc3NmdWxseSBwYXJzZWQgdmFsdWVzICR7SlNPTi5zdHJpbmdpZnkodmFsdWVSZXN1bHRzKX1cbmZvciAke0pTT04uc3RyaW5naWZ5KHRva2VuQ2h1bmtzRm9yTG9nKX1cbmluIGZvcm1hdCBwYXR0ZXJuICcke3RoaXMuZm9ybWF0U3RyaW5nfSdgKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFRoZSBpbnB1dCBzdHJpbmcgaW4gInYtbW9kZWwiIGRvZXMgTk9UIG1hdGNoIHRoZSAiZm9ybWF0IiBwYXR0ZXJuXG5mb3JtYXQ6ICR7dGhpcy5mb3JtYXRTdHJpbmd9XG52LW1vZGVsOiAke3N0cmluZ1ZhbHVlfWApCiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHBvbHlmaWxsTWF0Y2hBbGwgKHRhcmdldFN0cmluZywgcmVneFN0cikgewogICAgICBjb25zdCBtYXRjaGVzTGlzdCA9IHRhcmdldFN0cmluZy5tYXRjaChuZXcgUmVnRXhwKHJlZ3hTdHIsICdnJykpCiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdCiAgICAgIGNvbnN0IGluZGljZXNSZWcgPSBbXQogICAgICBpZiAobWF0Y2hlc0xpc3QgJiYgbWF0Y2hlc0xpc3QubGVuZ3RoKSB7CiAgICAgICAgbWF0Y2hlc0xpc3QuZm9yRWFjaChtYXRjaGVkSXRlbSA9PiB7CiAgICAgICAgICBjb25zdCBleGlzdEluZGV4ID0gaW5kaWNlc1JlZy5maW5kSW5kZXgoaWR4SXRlbSA9PiBpZHhJdGVtLnN0ciA9PT0gbWF0Y2hlZEl0ZW0pCiAgICAgICAgICBsZXQgaW5kZXgKICAgICAgICAgIGlmIChleGlzdEluZGV4ID49IDApIHsKICAgICAgICAgICAgaWYgKGluZGljZXNSZWdbZXhpc3RJbmRleF0gJiYgaW5kaWNlc1JlZ1tleGlzdEluZGV4XS5yZWdleCkgewogICAgICAgICAgICAgIGluZGV4ID0gaW5kaWNlc1JlZ1tleGlzdEluZGV4XS5yZWdleC5leGVjKHRhcmdldFN0cmluZykuaW5kZXgKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgaXRlbUluZGljZXNSZWdleCA9IG5ldyBSZWdFeHAobWF0Y2hlZEl0ZW0sICdnJykKICAgICAgICAgICAgaW5kZXggPSBpdGVtSW5kaWNlc1JlZ2V4LmV4ZWModGFyZ2V0U3RyaW5nKS5pbmRleAogICAgICAgICAgICBpbmRpY2VzUmVnLnB1c2goewogICAgICAgICAgICAgIHN0cjogU3RyaW5nKG1hdGNoZWRJdGVtKSwKICAgICAgICAgICAgICByZWdleDogaXRlbUluZGljZXNSZWdleAogICAgICAgICAgICB9KQogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnB1c2goewogICAgICAgICAgICAwOiBTdHJpbmcobWF0Y2hlZEl0ZW0pLAogICAgICAgICAgICBpbmRleDogaW5kZXgKICAgICAgICAgIH0pCiAgICAgICAgfSkKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9LAoKICAgIGFkZEZhbGxiYWNrVmFsdWVzICgpIHsKICAgICAgY29uc3QgdGltZVZhbHVlID0ge30KICAgICAgdGhpcy5pblVzZS50eXBlcy5mb3JFYWNoKHR5cGUgPT4gewogICAgICAgIHRpbWVWYWx1ZVt0aGlzLmdldFRva2VuQnlUeXBlKHR5cGUpXSA9ICcnCiAgICAgIH0pCiAgICAgIHRoaXMudGltZVZhbHVlID0gdGltZVZhbHVlCiAgICB9LAoKICAgIHNldFZhbHVlRnJvbVN0cmluZyAocGFyc2VkVmFsdWUsIHRva2VuKSB7CiAgICAgIGlmICghdG9rZW4gfHwgIXBhcnNlZFZhbHVlKSB7IHJldHVybiAnJyB9CiAgICAgIGNvbnN0IHRva2VuVHlwZSA9IHRoaXMuZ2V0VG9rZW5UeXBlKHRva2VuKQogICAgICBpZiAoIXRva2VuVHlwZSB8fCAhdG9rZW5UeXBlLmxlbmd0aCkgeyByZXR1cm4gJycgfQogICAgICBjb25zdCBzdGRWYWx1ZSA9IChwYXJzZWRWYWx1ZSAhPT0gdGhpcy5nZXRUb2tlbkJ5VHlwZSh0b2tlblR5cGUpKSA/IHBhcnNlZFZhbHVlIDogJycKICAgICAgdGhpc1t0b2tlblR5cGVdID0gc3RkVmFsdWUKICAgICAgcmV0dXJuIHN0ZFZhbHVlCiAgICB9LAoKICAgIGZpbGxWYWx1ZXMgKGZvcmNlRW1pdCkgewogICAgICBjb25zdCBmdWxsVmFsdWVzID0ge30KCiAgICAgIGNvbnN0IGJhc2VIb3VyID0gdGhpcy5ob3VyCiAgICAgIGNvbnN0IGJhc2VIb3VyVHlwZSA9IHRoaXMuaG91clR5cGUKCiAgICAgIGxldCBhcG1WYWx1ZQoKICAgICAgLy8gSG91ciB0eXBlIG9yIGhvdXIgdmFsdWUgaXMgTk9UIHNldCBpbiB0aGUgImZvcm1hdCIgc3RyaW5nCiAgICAgIGlmICghYmFzZUhvdXJUeXBlIHx8ICF0aGlzLmlzTnVtYmVyKGJhc2VIb3VyKSkgewogICAgICAgIENPTkZJRy5IT1VSX1RPS0VOUy5mb3JFYWNoKHRva2VuID0+IGZ1bGxWYWx1ZXNbdG9rZW5dID0gJycpCiAgICAgICAgYXBtVmFsdWUgPSB0aGlzLmxvd2VyQ2FzZWRBcG0odGhpcy5hcG0gfHwgJycpCiAgICAgICAgZnVsbFZhbHVlcy5hID0gYXBtVmFsdWUKICAgICAgICBmdWxsVmFsdWVzLkEgPSBhcG1WYWx1ZS50b1VwcGVyQ2FzZSgpCgogICAgICAvLyBCb3RoIEhvdXIgdHlwZSBhbmQgdmFsdWUgYXJlIHNldAogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGhvdXJWYWx1ZSA9ICtiYXNlSG91cgogICAgICAgIGNvbnN0IGFwbVZhbHVlID0gKHRoaXMuYmFzZU9uMTJIb3VycyAmJiB0aGlzLmFwbSkgPyB0aGlzLmxvd2VyQ2FzZWRBcG0odGhpcy5hcG0pIDogZmFsc2UKCiAgICAgICAgQ09ORklHLkhPVVJfVE9LRU5TLmZvckVhY2goKHRva2VuKSA9PiB7CiAgICAgICAgICBpZiAodG9rZW4gPT09IGJhc2VIb3VyVHlwZSkgewogICAgICAgICAgICBmdWxsVmFsdWVzW3Rva2VuXSA9IGJhc2VIb3VyCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgfQoKICAgICAgICAgIGxldCB2YWx1ZQogICAgICAgICAgbGV0IGFwbQogICAgICAgICAgc3dpdGNoICh0b2tlbikgewogICAgICAgICAgICBjYXNlICdIJzoKICAgICAgICAgICAgY2FzZSAnSEgnOgogICAgICAgICAgICBjYXNlICdrJzoKICAgICAgICAgICAgY2FzZSAna2snOgogICAgICAgICAgICAgIGlmICh0aGlzLmJhc2VPbjEySG91cnMpIHsKICAgICAgICAgICAgICAgIGlmIChhcG1WYWx1ZSA9PT0gJ3BtJykgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvdXJWYWx1ZSA8IDEyID8gaG91clZhbHVlICsgMTIgOiBob3VyVmFsdWUKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoWydrJywgJ2trJ10uaW5jbHVkZXModG9rZW4pKSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gaG91clZhbHVlID09PSAxMiA/IDI0IDogaG91clZhbHVlCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvdXJWYWx1ZSAlIDEyCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChbJ2snLCAna2snXS5pbmNsdWRlcyh0b2tlbikpIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWUgPT09IDAgPyAyNCA6IGhvdXJWYWx1ZQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWUgJSAyNAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmdWxsVmFsdWVzW3Rva2VuXSA9IHRoaXMuZm9ybWF0VmFsdWUodG9rZW4sIHZhbHVlKQogICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGNhc2UgJ2gnOgogICAgICAgICAgICBjYXNlICdoaCc6CiAgICAgICAgICAgICAgLy8gaCA8LT4gaGgKICAgICAgICAgICAgICBpZiAodGhpcy5iYXNlT24xMkhvdXJzKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvdXJWYWx1ZQogICAgICAgICAgICAgICAgYXBtID0gYXBtVmFsdWUgfHwgJycKICAgICAgICAgICAgICAvLyBSZWFkIGZyb20gb3RoZXIgaG91ciBmb3JtYXRzCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChob3VyVmFsdWUgPiAxMSAmJiBob3VyVmFsdWUgPCAyNCkgewogICAgICAgICAgICAgICAgICBhcG0gPSAncG0nCiAgICAgICAgICAgICAgICAgIHZhbHVlID0gaG91clZhbHVlID09PSAxMiA/IDEyIDogaG91clZhbHVlICUgMTIKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGFwbSA9ICdhbScKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWUgJSAxMiA9PT0gMCA/IDEyIDogaG91clZhbHVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZ1bGxWYWx1ZXNbdG9rZW5dID0gdGhpcy5mb3JtYXRWYWx1ZSh0b2tlbiwgdmFsdWUpCiAgICAgICAgICAgICAgZnVsbFZhbHVlcy5hID0gYXBtCiAgICAgICAgICAgICAgZnVsbFZhbHVlcy5BID0gYXBtLnRvVXBwZXJDYXNlKCkKICAgICAgICAgICAgICBicmVhawogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0KCiAgICAgIGZ1bGxWYWx1ZXMubSA9IHRoaXMuZm9ybWF0VmFsdWUoJ20nLCB0aGlzLm1pbnV0ZSkKICAgICAgZnVsbFZhbHVlcy5tbSA9IHRoaXMuZm9ybWF0VmFsdWUoJ21tJywgdGhpcy5taW51dGUpCiAgICAgIGZ1bGxWYWx1ZXMucyA9IHRoaXMuZm9ybWF0VmFsdWUoJ3MnLCB0aGlzLnNlY29uZCkKICAgICAgZnVsbFZhbHVlcy5zcyA9IHRoaXMuZm9ybWF0VmFsdWUoJ3NzJywgdGhpcy5zZWNvbmQpCgogICAgICB0aGlzLmZ1bGxWYWx1ZXMgPSBmdWxsVmFsdWVzCgogICAgICAvLyBPbiBsYXp5IG1vZGUsIGVtaXQgYGlucHV0YCBhbmQgYGNoYW5nZWAgZXZlbnRzIG9ubHkgd2hlbjoKICAgICAgLy8gLSBUaGUgdXNlciBwaWNrIGEgbmV3IHZhbHVlIGFuZCB0aGVuIGNsb3NlIHRoZSBkcm9wZG93bgogICAgICAvLyAtIFRoZSB1c2VyIGNsaWNrIHRoZSAoIngiKSBjbGVhciBidXR0b24KICAgICAgaWYgKCF0aGlzLmxhenkgfHwgZm9yY2VFbWl0KSB7CiAgICAgICAgdGhpcy5lbWl0VGltZVZhbHVlKCkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuY2xvc2VPbkNvbXBsZXRlICYmIHRoaXMuYWxsVmFsdWVTZWxlY3RlZCAmJiB0aGlzLnNob3dEcm9wZG93bikgewogICAgICAgIHRoaXMudG9nZ2xlQWN0aXZlKCkKICAgICAgfQogICAgfSwKCiAgICBnZXRGdWxsRGF0YSAoKSB7CiAgICAgIGlmICghdGhpcy5mdWxsVmFsdWVzKSB7CiAgICAgICAgdGhpcy5maWxsVmFsdWVzKCkKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5mdWxsVmFsdWVzKSksCiAgICAgICAgZGlzcGxheVRpbWU6IHRoaXMuaW5wdXRJc0VtcHR5ID8gJycgOiBTdHJpbmcodGhpcy5kaXNwbGF5VGltZSkKICAgICAgfQogICAgfSwKCiAgICBlbWl0VGltZVZhbHVlICgpIHsKICAgICAgaWYgKHRoaXMubGF6eSAmJiB0aGlzLmJha0Rpc3BsYXlUaW1lID09PSB0aGlzLmRpc3BsYXlUaW1lKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdUaGUgdmFsdWUgZG9lcyBub3QgY2hhbmdlIG9uIGBsYXp5YCBtb2RlLiBTa2lwIHRoZSBlbWl0dGluZyBgaW5wdXRgIGFuZCBgY2hhbmdlYCBldmVudC4nKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgY29uc3QgZnVsbERhdGEgPSB0aGlzLmdldEZ1bGxEYXRhKCkKCiAgICAgIGlmICh0aGlzLnVzZVN0cmluZ1ZhbHVlKSB7CiAgICAgICAgdGhpcy4kZW1pdCgnaW5wdXQnLCBmdWxsRGF0YS5kaXNwbGF5VGltZSkKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBmdWxsVmFsdWVzID0gZnVsbERhdGEuZGF0YQogICAgICAgIGNvbnN0IHRva2Vuc0luVXNlID0gdGhpcy5pblVzZS50b2tlbnMgfHwgW10KICAgICAgICBjb25zdCB0aW1lVmFsdWUgPSB7fQogICAgICAgIHRva2Vuc0luVXNlLmZvckVhY2goKHRva2VuKSA9PiB7CiAgICAgICAgICB0aW1lVmFsdWVbdG9rZW5dID0gZnVsbFZhbHVlc1t0b2tlbl0gfHwgJycKICAgICAgICB9KQogICAgICAgIHRoaXMuJGVtaXQoJ2lucHV0JywgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aW1lVmFsdWUpKSkKICAgICAgfQoKICAgICAgdGhpcy4kZW1pdCgnY2hhbmdlJywgZnVsbERhdGEpCiAgICB9LAoKICAgIHRyYW5zbGF0ZTEyaFJhbmdlICh2YWx1ZSkgewogICAgICBjb25zdCB2YWx1ZVQgPSB0aGlzLm1hdGNoMTJoUmFuZ2UodmFsdWUpCiAgICAgIGlmICgrdmFsdWVUWzFdID09PSAxMikgewogICAgICAgIHJldHVybiArdmFsdWVUWzFdICsgKHZhbHVlVFsyXS50b0xvd2VyQ2FzZSgpID09PSAncCcgPyAwIDogMTIpCiAgICAgIH0KICAgICAgcmV0dXJuICt2YWx1ZVRbMV0gKyAodmFsdWVUWzJdLnRvTG93ZXJDYXNlKCkgPT09ICdwJyA/IDEyIDogMCkKICAgIH0sCgogICAgaXNEaXNhYmxlZCAodHlwZSwgdmFsdWUpIHsKICAgICAgaWYgKCF0aGlzLmlzQmFzaWNUeXBlKHR5cGUpIHx8ICF0aGlzLmluVXNlW3R5cGVdKSB7IHJldHVybiB0cnVlIH0KICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgY2FzZSAnaG91cic6CiAgICAgICAgICByZXR1cm4gdGhpcy5pc0Rpc2FibGVkSG91cih2YWx1ZSkKICAgICAgICBjYXNlICdtaW51dGUnOgogICAgICAgIGNhc2UgJ3NlY29uZCc6CiAgICAgICAgICBpZiAoIXRoaXNbYCR7dHlwZX1SYW5nZUxpc3RgXSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAhdGhpc1tgJHt0eXBlfVJhbmdlTGlzdGBdLmluY2x1ZGVzKHZhbHVlKQogICAgICAgIGNhc2UgJ2FwbSc6CiAgICAgICAgICBpZiAoIXRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAhdGhpcy5oYXNbdGhpcy5sb3dlckNhc2VkQXBtKHZhbHVlKV0KICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfSwKCiAgICBpc0Rpc2FibGVkSG91ciAodmFsdWUpIHsKICAgICAgaWYgKCF0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UpIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgaWYgKHRoaXMuYmFzZU9uMTJIb3VycykgewogICAgICAgIGlmICghdGhpcy5hcG0gfHwgIXRoaXMuYXBtLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHRva2VuID0gdGhpcy5hcG0udG9Mb3dlckNhc2UoKSA9PT0gJ2FtJyA/ICdhJyA6ICdwJwogICAgICAgICAgcmV0dXJuICF0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UuaW5jbHVkZXMoYCR7K3ZhbHVlfSR7dG9rZW59YCkKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRmFsbGJhY2sgZm9yICdISCcgYW5kICdIIGhvdXIgZm9ybWF0IHdpdGggYSBgaG91ci1yYW5nZWAgaW4gYSAxMi1ob3VyIGZvcm0KICAgICAgaWYgKAogICAgICAgICh0aGlzLmhvdXJUeXBlID09PSAnSEgnIHx8IHRoaXMuaG91clR5cGUgPT09ICdIJykgJiYKICAgICAgICArdmFsdWUgPT09IDAgJiYgdGhpcy5yZXN0cmljdGVkSG91clJhbmdlLmluY2x1ZGVzKDI0KQogICAgICApIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgICByZXR1cm4gIXRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZS5pbmNsdWRlcygrdmFsdWUpCiAgICB9LAoKICAgIG5vdEluSW50ZXJ2YWwgKHNlY3Rpb24sIHZhbHVlKSB7CiAgICAgIGlmICghc2VjdGlvbiB8fCAhdGhpcy5pc01pbnV0ZU9yU2Vjb25kKHNlY3Rpb24pKSB7IHJldHVybiB9CiAgICAgIGlmICh0aGlzLm9wdHNbYCR7c2VjdGlvbn1JbnRlcnZhbGBdID09PSAxKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIHJldHVybiArdmFsdWUgJSB0aGlzLm9wdHNbYCR7c2VjdGlvbn1JbnRlcnZhbGBdICE9PSAwCiAgICB9LAoKICAgIHJlbmRlclJhbmdlTGlzdCAocmF3UmFuZ2UsIHNlY3Rpb24pIHsKICAgICAgaWYgKCFyYXdSYW5nZSB8fCAhc2VjdGlvbiB8fCAhdGhpcy5pc01pbnV0ZU9yU2Vjb25kKHNlY3Rpb24pKSB7IHJldHVybiBbXSB9CiAgICAgIGNvbnN0IHJhbmdlID0gW10KICAgICAgbGV0IGZvcm1hdGVkVmFsdWUKICAgICAgcmF3UmFuZ2UuZm9yRWFjaCh2YWx1ZSA9PiB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAyICYmIHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYE5lc3RlZCBhcnJheSB3aXRoaW4gIiR7c2VjdGlvbn0tcmFuZ2UiIG11c3QgY29udGFpbiBubyBtb3JlIHRoYW4gdHdvIGl0ZW1zLiBPbmx5IHRoZSBmaXJzdCB0d28gaXRlbXMgb2YgJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9IHdpbGwgYmUgdGFrZW4gaW50byBhY2NvdW50LmApCiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBzdGFydCA9IHZhbHVlWzBdCiAgICAgICAgICBjb25zdCBlbmQgPSB2YWx1ZVsxXSB8fCB2YWx1ZVswXQogICAgICAgICAgZm9yIChsZXQgaSA9ICtzdGFydDsgaSA8PSArZW5kOyBpKyspIHsKICAgICAgICAgICAgaWYgKGkgPCAwIHx8IGkgPiA1OSkgeyBjb250aW51ZSB9CiAgICAgICAgICAgIGZvcm1hdGVkVmFsdWUgPSB0aGlzLmZvcm1hdFZhbHVlKHRoaXMuZ2V0VG9rZW5CeVR5cGUoc2VjdGlvbiksIGkpCiAgICAgICAgICAgIGlmICghcmFuZ2UuaW5jbHVkZXMoZm9ybWF0ZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICByYW5nZS5wdXNoKGZvcm1hdGVkVmFsdWUpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCt2YWx1ZSA8IDAgfHwgK3ZhbHVlID4gNTkpIHsgcmV0dXJuIH0KICAgICAgICAgIGZvcm1hdGVkVmFsdWUgPSB0aGlzLmZvcm1hdFZhbHVlKHRoaXMuZ2V0VG9rZW5CeVR5cGUoc2VjdGlvbiksIHZhbHVlKQogICAgICAgICAgaWYgKCFyYW5nZS5pbmNsdWRlcyhmb3JtYXRlZFZhbHVlKSkgewogICAgICAgICAgICByYW5nZS5wdXNoKGZvcm1hdGVkVmFsdWUpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgICByYW5nZS5zb3J0KChsLCByKSA9PiB7IHJldHVybiBsIC0gciB9KQogICAgICAvLyBEZWJ1ZyBNb2RlCiAgICAgIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgIGNvbnN0IGZ1bGxMaXN0ID0gKHNlY3Rpb24gPT09ICdtaW51dGUnID8gdGhpcy5taW51dGVzIDogdGhpcy5zZWNvbmRzKSB8fCBbXQogICAgICAgIGNvbnN0IHZhbGlkSXRlbXMgPSBmdWxsTGlzdC5maWx0ZXIoaXRlbSA9PiByYW5nZS5pbmNsdWRlcyhpdGVtKSkKICAgICAgICBpZiAoIXZhbGlkSXRlbXMgfHwgIXZhbGlkSXRlbXMubGVuZ3RoKSB7CiAgICAgICAgICBpZiAoc2VjdGlvbiA9PT0gJ21pbnV0ZScpIHsKICAgICAgICAgICAgdGhpcy5kZWJ1Z0xvZyhgVGhlIG1pbnV0ZSBsaXN0IGlzIGVtcHR5IGR1ZSB0byB0aGUgIm1pbnV0ZS1yYW5nZSIgY29uZmlnXG5taW51dGUtcmFuZ2U6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5taW51dGVSYW5nZSl9XG5taW51dGUtaW50ZXJ2YWw6ICR7dGhpcy5vcHRzLm1pbnV0ZUludGVydmFsfWApCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBUaGUgc2Vjb25kIGxpc3QgaXMgZW1wdHkgZHVlIHRvIHRoZSAic2Vjb25kLXJhbmdlIiBjb25maWdcbnNlY29uZC1yYW5nZTogJHtKU09OLnN0cmluZ2lmeSh0aGlzLnNlY29uZFJhbmdlKX1cbnNlY29uZC1pbnRlcnZhbDogJHt0aGlzLm9wdHMuc2Vjb25kSW50ZXJ2YWx9YCkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJhbmdlCiAgICB9LAoKICAgIGZvcmNlQXBtU2VsZWN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXQpIHsKICAgICAgICAvLyBTa2lwIHRoaXMgdG8gYWxsb3cgdXNlcnMgdG8gcGFzdGUgYSBzdHJpbmcgdmFsdWUgZnJvbSB0aGUgY2xpcGJvYXJkIGluIE1hbnVhbCBJbnB1dCBtb2RlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKHRoaXMuYXBtVHlwZSAmJiAhdGhpcy5hcG0pIHsKICAgICAgICBpZiAodGhpcy5oYXMuYW0gfHwgdGhpcy5oYXMucG0pIHsKICAgICAgICAgIHRoaXMuZG9DbGVhckFwbUNoZWNraW5nID0gdHJ1ZQogICAgICAgICAgY29uc3QgYXBtVmFsdWUgPSB0aGlzLmhhcy5hbSA/ICdhbScgOiAncG0nCiAgICAgICAgICB0aGlzLmFwbSA9IHRoaXMuYXBtVHlwZSA9PT0gJ0EnID8gYXBtVmFsdWUudG9VcHBlckNhc2UoKSA6IGFwbVZhbHVlCiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGVtcHR5QXBtU2VsZWN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuZG9DbGVhckFwbUNoZWNraW5nICYmIHRoaXMuaG91ciA9PT0gJycgJiYgdGhpcy5taW51dGUgPT09ICcnICYmIHRoaXMuc2Vjb25kID09PSAnJykgewogICAgICAgIHRoaXMuYXBtID0gJycKICAgICAgfQogICAgICB0aGlzLmRvQ2xlYXJBcG1DaGVja2luZyA9IGZhbHNlCiAgICB9LAoKICAgIGFwbURpc3BsYXlUZXh0IChhcG1WYWx1ZSkgewogICAgICBpZiAodGhpcy5hbVRleHQgJiYgdGhpcy5sb3dlckNhc2VkQXBtKGFwbVZhbHVlKSA9PT0gJ2FtJykgewogICAgICAgIHJldHVybiB0aGlzLmFtVGV4dAogICAgICB9CiAgICAgIGlmICh0aGlzLnBtVGV4dCAmJiB0aGlzLmxvd2VyQ2FzZWRBcG0oYXBtVmFsdWUpID09PSAncG0nKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG1UZXh0CiAgICAgIH0KICAgICAgcmV0dXJuIGFwbVZhbHVlCiAgICB9LAoKICAgIHRvZ2dsZUFjdGl2ZSAoKSB7CiAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB7IHJldHVybiB9CiAgICAgIHRoaXMuaXNBY3RpdmUgPSAhdGhpcy5pc0FjdGl2ZQoKICAgICAgaWYgKHRoaXMuaXNBY3RpdmUpIHsKICAgICAgICB0aGlzLmlzRm9jdXNpbmcgPSB0cnVlCiAgICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXQpIHsKICAgICAgICAgIHRoaXMuJGVtaXQoJ2ZvY3VzJykKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLm9wdHMuaGlkZURyb3Bkb3duKSB7CiAgICAgICAgICB0aGlzLnNldERyb3Bkb3duU3RhdGUodHJ1ZSkKICAgICAgICB9CiAgICAgICAgLy8gUmVjb3JkIHRvIGNoZWNrIGlmIHZhbHVlIGRpZCBjaGFuZ2UgaW4gdGhlIGxhdGVyIHBoYXNlCiAgICAgICAgaWYgKHRoaXMubGF6eSkgewogICAgICAgICAgdGhpcy5iYWtEaXNwbGF5VGltZSA9IFN0cmluZyh0aGlzLmRpc3BsYXlUaW1lIHx8ICcnKQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5tYW51YWxJbnB1dCAmJiAhdGhpcy5pbnB1dElzRW1wdHkpIHsKICAgICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJlZnMuaW5wdXQgJiYgdGhpcy4kcmVmcy5pbnB1dC5zZWxlY3Rpb25TdGFydCA9PT0gMCAmJiB0aGlzLiRyZWZzLmlucHV0LnNlbGVjdGlvbkVuZCA9PT0gdGhpcy5kaXNwbGF5VGltZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBTZWxlY3QgdGhlIGZpcnN0IHNsb3QgaW5zdGVhZCBvZiB0aGUgd2hvbGUgdmFsdWUgc3RyaW5nIHdoZW4gdGFiYmVkIGluCiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RGaXJzdFNsb3QoKQogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5zaG93RHJvcGRvd24pIHsKICAgICAgICAgIHRoaXMuc2V0RHJvcGRvd25TdGF0ZShmYWxzZSkKICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWFudWFsSW5wdXQpIHsKICAgICAgICAgIHRoaXMuJGVtaXQoJ2JsdXInLCB0aGlzLmdldEZ1bGxEYXRhKCkpCiAgICAgICAgfQogICAgICAgIHRoaXMuaXNGb2N1c2luZyA9IGZhbHNlCiAgICAgICAgaWYgKHRoaXMubGF6eSkgewogICAgICAgICAgdGhpcy5maWxsVmFsdWVzKHRydWUpCiAgICAgICAgICB0aGlzLmJha0Rpc3BsYXlUaW1lID0gdW5kZWZpbmVkCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5yZXN0cmljdGVkSG91clJhbmdlICYmIHRoaXMuYmFzZU9uMTJIb3VycykgewogICAgICAgIHRoaXMuc2hvd0Ryb3Bkb3duID8gdGhpcy5mb3JjZUFwbVNlbGVjdGlvbigpIDogdGhpcy5lbXB0eUFwbVNlbGVjdGlvbigpCiAgICAgIH0KICAgICAgaWYgKHRoaXMuc2hvd0Ryb3Bkb3duKSB7CiAgICAgICAgdGhpcy5jaGVja0ZvckF1dG9TY3JvbGwoKQogICAgICB9CiAgICB9LAoKICAgIHNldERyb3Bkb3duU3RhdGUgKHRvU2hvdywgZnJvbVVzZXJDbGljayA9IGZhbHNlKSB7CiAgICAgIGlmICh0b1Nob3cpIHsKICAgICAgICBpZiAodGhpcy5hcHBlbmRUb0JvZHkpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kRHJvcGRvd25Ub0JvZHkoKQogICAgICAgIH0KICAgICAgICB0aGlzLmtlZXBGb2N1c2luZygpCiAgICAgICAgaWYgKHRoaXMuYXV0b0RpcmVjdGlvbkVuYWJsZWQpIHsKICAgICAgICAgIHRoaXMuY2hlY2tEcm9wRGlyZWN0aW9uKCkKICAgICAgICB9CiAgICAgICAgdGhpcy5zaG93RHJvcGRvd24gPSB0cnVlCiAgICAgICAgdGhpcy4kZW1pdCgnb3BlbicpIAogICAgICAgIGlmIChmcm9tVXNlckNsaWNrKSB7CiAgICAgICAgICBpZiAodGhpcy5maXhlZERyb3Bkb3duQnV0dG9uKSB7CiAgICAgICAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlCiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLiRlbWl0KCdibHVyJywgdGhpcy5nZXRGdWxsRGF0YSgpKQogICAgICAgICAgdGhpcy5jaGVja0ZvckF1dG9TY3JvbGwoKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNob3dEcm9wZG93biA9IGZhbHNlCiAgICAgICAgdGhpcy4kZW1pdCgnY2xvc2UnLCB0aGlzLmdldEZ1bGxEYXRhKCkpCiAgICAgICAgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5KSB7CiAgICAgICAgICB0aGlzLnJlbW92ZURyb3Bkb3duRnJvbUJvZHkoKQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBhcHBlbmREcm9wZG93blRvQm9keSAoKSB7CiAgICAgIGNvbnN0IGRyb3Bkb3duID0gdGhpcy4kcmVmcyAmJiB0aGlzLiRyZWZzLmRyb3Bkb3duCiAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdCiAgICAgIGlmIChib2R5ICYmIGRyb3Bkb3duKSB7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMudXBkYXRlRHJvcGRvd25Qb3MpCiAgICAgICAgZHJvcGRvd24uY2xhc3NMaXN0LmFkZCgndnVlX190aW1lLXBpY2tlci1kcm9wZG93bicpCiAgICAgICAgdGhpcy51cGRhdGVEcm9wZG93blBvcygpCiAgICAgICAgYm9keS5hcHBlbmRDaGlsZChkcm9wZG93bikKICAgICAgfQogICAgfSwKCiAgICB1cGRhdGVEcm9wZG93blBvcyAoKSB7CiAgICAgIGlmICghdGhpcy5hcHBlbmRUb0JvZHkpIHsgcmV0dXJuIH0KICAgICAgY29uc3QgZHJvcGRvd24gPSB0aGlzLiRyZWZzICYmIHRoaXMuJHJlZnMuZHJvcGRvd24KICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0KICAgICAgaWYgKGJvZHkgJiYgZHJvcGRvd24pIHsKICAgICAgICBjb25zdCBib3ggPSB0aGlzLiRlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKQogICAgICAgIGlmICh0aGlzLmRyb3Bkb3duRGlyQ2xhc3MgPT09ICdkcm9wLXVwJykgewogICAgICAgICAgZHJvcGRvd24uc3R5bGUuYm90dG9tID0gYCR7d2luZG93LmlubmVySGVpZ2h0IC0gYm94Lnl9cHhgCiAgICAgICAgICBkcm9wZG93bi5zdHlsZS50b3AgPSAnYXV0bycKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZHJvcGRvd24uc3R5bGUudG9wID0gYCR7Ym94LnkgKyBib3guaGVpZ2h0fXB4YAogICAgICAgICAgZHJvcGRvd24uc3R5bGUuYm90dG9tID0gJ2F1dG8nCiAgICAgICAgfQogICAgICAgIGRyb3Bkb3duLnN0eWxlLmxlZnQgPSBgJHtib3gueH1weGAKICAgICAgfQogICAgfSwKCiAgICByZW1vdmVEcm9wZG93bkZyb21Cb2R5ICgpIHsKICAgICAgY29uc3QgZHJvcGRvd24gPSB0aGlzLiRyZWZzICYmIHRoaXMuJHJlZnMuZHJvcGRvd24KICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0KICAgICAgaWYgKGJvZHkgJiYgZHJvcGRvd24gJiYgYm9keS5jb250YWlucyhkcm9wZG93bikpIHsKICAgICAgICBib2R5LnJlbW92ZUNoaWxkKGRyb3Bkb3duKQogICAgICB9CiAgICAgIGlmIChkcm9wZG93bikgewogICAgICAgIGRyb3Bkb3duLmNsYXNzTGlzdC5yZW1vdmUoJ3Z1ZV9fdGltZS1waWNrZXItZHJvcGRvd24nKQogICAgICAgIGRyb3Bkb3duLnN0eWxlLnRvcCA9ICcnCiAgICAgICAgZHJvcGRvd24uc3R5bGUuYm90dG9tID0gJycKICAgICAgICBkcm9wZG93bi5zdHlsZS5sZWZ0ID0gJycKICAgICAgICB0aGlzLiRlbC5hcHBlbmRDaGlsZChkcm9wZG93bikKICAgICAgfQogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy51cGRhdGVEcm9wZG93blBvcykKICAgIH0sCgogICAgYmx1ckV2ZW50ICgpIHsKICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXQgJiYgIXRoaXMub3B0cy5oaWRlRHJvcGRvd24pIHsKICAgICAgICAvLyBoaWRlRHJvcGRvd24ncyBgYmx1cmAgZXZlbnQgaXMgaGFuZGxlZCBzb21ld2hlcmUgZWxzZQogICAgICAgIHRoaXMuJGVtaXQoJ2JsdXInLCB0aGlzLmdldEZ1bGxEYXRhKCkpCiAgICAgIH0KICAgIH0sCgogICAgc2VsZWN0ICh0eXBlLCB2YWx1ZSkgewogICAgICBpZiAodGhpcy5pc0Jhc2ljVHlwZSh0eXBlKSAmJiAhdGhpcy5pc0Rpc2FibGVkKHR5cGUsIHZhbHVlKSkgewogICAgICAgIHRoaXNbdHlwZV0gPSB2YWx1ZQogICAgICAgIGlmICh0aGlzLmRvQ2xlYXJBcG1DaGVja2luZykgewogICAgICAgICAgdGhpcy5kb0NsZWFyQXBtQ2hlY2tpbmcgPSBmYWxzZQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBjbGVhclRpbWUgKCkgewogICAgICBpZiAodGhpcy5kaXNhYmxlZCkgeyByZXR1cm4gfQogICAgICB0aGlzLmhvdXIgPSAnJwogICAgICB0aGlzLm1pbnV0ZSA9ICcnCiAgICAgIHRoaXMuc2Vjb25kID0gJycKICAgICAgdGhpcy5hcG0gPSAnJwoKICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXQgJiYgdGhpcy4kcmVmcyAmJiB0aGlzLiRyZWZzLmlucHV0ICYmIHRoaXMuJHJlZnMuaW5wdXQudmFsdWUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy4kcmVmcy5pbnB1dC52YWx1ZSA9ICcnCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmxhenkpIHsKICAgICAgICB0aGlzLmZpbGxWYWx1ZXModHJ1ZSkKICAgICAgfQogICAgfSwKCiAgICAvLwogICAgLy8gQXV0by1TY3JvbGwKICAgIC8vCgogICAgY2hlY2tGb3JBdXRvU2Nyb2xsICgpIHsKICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7IHJldHVybiB9CiAgICAgIGlmICh0aGlzLmF1dG9TY3JvbGwpIHsKICAgICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgICB0aGlzLnNjcm9sbFRvU2VsZWN0ZWRWYWx1ZXMoKQogICAgICAgIH0pCiAgICAgIH0gZWxzZSBpZiAodGhpcy5hZHZhbmNlZEtleWJvYXJkKSB7CiAgICAgICAgLy8gQXV0by1mb2N1cyBvbiBzZWxlY3RlZCB2YWx1ZSBpbiB0aGUgZmlyc3QgY29sdW1uIGZvciBhZHZhbmNlZC1rZXlib2FyZAogICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgIGNvbnN0IGZpcnN0Q29sdW1uID0gdGhpcy5pblVzZS50eXBlc1swXQogICAgICAgICAgdGhpcy5zY3JvbGxUb1NlbGVjdGVkKGZpcnN0Q29sdW1uLCB0cnVlKQogICAgICAgIH0pCiAgICAgIH0KICAgIH0sCgogICAgc2Nyb2xsVG9TZWxlY3RlZCAoY29sdW1uLCBhbGxvd0ZhbGxiYWNrID0gZmFsc2UpIHsKICAgICAgaWYgKCF0aGlzLnRpbWVWYWx1ZSB8fCB0aGlzLmlucHV0SXNFbXB0eSkgeyByZXR1cm4gfQogICAgICBsZXQgdGFyZ2V0TGlzdAogICAgICBpZiAodGhpcy5hcHBlbmRUb0JvZHkgJiYgdGhpcy4kcmVmcyAmJiB0aGlzLiRyZWZzLmRyb3Bkb3duKSB7CiAgICAgICAgdGFyZ2V0TGlzdCA9IHRoaXMuJHJlZnMuZHJvcGRvd24ucXVlcnlTZWxlY3RvckFsbChgdWwuJHtjb2x1bW59c2ApWzBdCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0TGlzdCA9IHRoaXMuJGVsLnF1ZXJ5U2VsZWN0b3JBbGwoYHVsLiR7Y29sdW1ufXNgKVswXQogICAgICB9CiAgICAgIGxldCB0YXJnZXRWYWx1ZSA9IHRoaXMuYWN0aXZlSXRlbUluQ29sKGNvbHVtbilbMF0KICAgICAgaWYgKCF0YXJnZXRWYWx1ZSAmJiBhbGxvd0ZhbGxiYWNrKSB7CiAgICAgICAgLy8gTm8gdmFsdWUgc2VsZWN0ZWQgaW4gdGhlIHRhcmdldCBjb2x1bW4sIGZhbGxiYWNrIHRvIHRoZSBmaXJzdCBmb3VuZCB2YWxpZCBpdGVtCiAgICAgICAgdGFyZ2V0VmFsdWUgPSB0aGlzLnZhbGlkSXRlbXNJbkNvbChjb2x1bW4pWzBdCiAgICAgIH0KICAgICAgaWYgKHRhcmdldExpc3QgJiYgdGFyZ2V0VmFsdWUpIHsKICAgICAgICB0YXJnZXRMaXN0LnNjcm9sbFRvcCA9IHRhcmdldFZhbHVlLm9mZnNldFRvcCB8fCAwCiAgICAgICAgaWYgKHRoaXMuYWR2YW5jZWRLZXlib2FyZCkgewogICAgICAgICAgdGFyZ2V0VmFsdWUuZm9jdXMoKQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBzY3JvbGxUb1NlbGVjdGVkVmFsdWVzICgpIHsKICAgICAgaWYgKCF0aGlzLnRpbWVWYWx1ZSB8fCB0aGlzLmlucHV0SXNFbXB0eSkgeyByZXR1cm4gfQogICAgICB0aGlzLmluVXNlLnR5cGVzLmZvckVhY2goc2VjdGlvbiA9PiB7CiAgICAgICAgdGhpcy5zY3JvbGxUb1NlbGVjdGVkKHNlY3Rpb24pCiAgICAgIH0pCiAgICB9LAoKICAgIC8vCiAgICAvLyBBZGRpdGlvbmFsIEtleWJvYXJkIE5hdmlnYXRpb24KICAgIC8vCgogICAgb25Gb2N1cyAoKSB7CiAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB7IHJldHVybiB9CiAgICAgIGlmICghdGhpcy5pc0ZvY3VzaW5nKSB7CiAgICAgICAgdGhpcy5pc0ZvY3VzaW5nID0gdHJ1ZQogICAgICB9CiAgICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgewogICAgICAgIHRoaXMudG9nZ2xlQWN0aXZlKCkKICAgICAgfQogICAgfSwKCiAgICBlc2NCbHVyICgpIHsKICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsgcmV0dXJuIH0KICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlYm91bmNlVGltZXIpCiAgICAgIHRoaXMuaXNGb2N1c2luZyA9IGZhbHNlCiAgICAgIGNvbnN0IGlucHV0Qm94ID0gdGhpcy4kZWwucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQuZGlzcGxheS10aW1lJylbMF0KICAgICAgaWYgKGlucHV0Qm94KSB7CiAgICAgICAgaW5wdXRCb3guYmx1cigpCiAgICAgIH0KICAgIH0sCgogICAgZGVib3VuY2VCbHVyICgpIHsKICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsgcmV0dXJuIH0KICAgICAgdGhpcy5pc0ZvY3VzaW5nID0gZmFsc2UKICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlYm91bmNlVGltZXIpCiAgICAgIHRoaXMuZGVib3VuY2VUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuZGVib3VuY2VUaW1lcikKICAgICAgICB0aGlzLm9uQmx1cigpCiAgICAgIH0sIHRoaXMub3B0cy5ibHVyRGVsYXkpCiAgICB9LAoKICAgIG9uQmx1ciAoKSB7CiAgICAgIGlmICghdGhpcy5kaXNhYmxlZCAmJiAhdGhpcy5pc0ZvY3VzaW5nICYmIHRoaXMuaXNBY3RpdmUpIHsKICAgICAgICB0aGlzLnRvZ2dsZUFjdGl2ZSgpCiAgICAgIH0KICAgIH0sCgogICAga2VlcEZvY3VzaW5nICgpIHsKICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsgcmV0dXJuIH0KICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlYm91bmNlVGltZXIpCiAgICAgIGlmICghdGhpcy5pc0ZvY3VzaW5nKSB7CiAgICAgICAgdGhpcy5pc0ZvY3VzaW5nID0gdHJ1ZQogICAgICB9CiAgICB9LAoKICAgIG9uVGFiIChjb2x1bW4sIHZhbHVlLCBldnQpIHsKICAgICAgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5ICYmIGV2dC5zaGlmdEtleSkgewogICAgICAgIGNvbnN0IGZpcnN0Q29sdW1uID0gdGhpcy5pblVzZS50eXBlc1swXQogICAgICAgIGlmIChjb2x1bW4gIT09IGZpcnN0Q29sdW1uKSB7IHJldHVybiB9CiAgICAgICAgY29uc3QgZmlyc3RWYWxpZFZhbHVlID0gdGhpcy52YWxpZEl0ZW1zSW5Db2woZmlyc3RDb2x1bW4pWzBdCiAgICAgICAgLy8gSXMgdGhlIGZpcnN0IHZhbGlkIGl0ZW0gaW4gdGhlIGZpcnN0IGNvbHVtbgogICAgICAgIGlmIChmaXJzdFZhbGlkVmFsdWUgJiYgZmlyc3RWYWxpZFZhbHVlLmdldEF0dHJpYnV0ZSgnZGF0YS1rZXknKSA9PT0gU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgIC8vIEZvY3VzIGJhY2sgb24gPGlucHV0PgogICAgICAgICAgaWYgKHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5pbnB1dCkgewogICAgICAgICAgICB0aGlzLiRyZWZzLmlucHV0LmZvY3VzKCkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgdmFsaWRJdGVtc0luQ29sIChjb2x1bW4pIHsKICAgICAgY29uc3QgY29sdW1uQ2xhc3MgPSBgJHtjb2x1bW59c2AKICAgICAgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5ICYmIHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5kcm9wZG93bikgewogICAgICAgIHJldHVybiB0aGlzLiRyZWZzLmRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoYHVsLiR7Y29sdW1uQ2xhc3N9ID4gbGk6bm90KC5oaW50KTpub3QoW2Rpc2FibGVkXSlgKQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLiRlbC5xdWVyeVNlbGVjdG9yQWxsKGB1bC4ke2NvbHVtbkNsYXNzfSA+IGxpOm5vdCguaGludCk6bm90KFtkaXNhYmxlZF0pYCkKICAgIH0sCgogICAgYWN0aXZlSXRlbUluQ29sIChjb2x1bW4pIHsKICAgICAgY29uc3QgY29sdW1uQ2xhc3MgPSBgJHtjb2x1bW59c2AKICAgICAgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5ICYmIHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5kcm9wZG93bikgewogICAgICAgIHJldHVybiB0aGlzLiRyZWZzLmRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoYHVsLiR7Y29sdW1uQ2xhc3N9ID4gbGkuYWN0aXZlOm5vdCguaGludClgKQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLiRlbC5xdWVyeVNlbGVjdG9yQWxsKGB1bC4ke2NvbHVtbkNsYXNzfSA+IGxpLmFjdGl2ZTpub3QoLmhpbnQpYCkKICAgIH0sCgogICAgZ2V0Q2xvc2VzdFNpYmxpbmcgKGNvbHVtbiwgZGF0YUtleSwgZ2V0UHJldmlvdXMgPSBmYWxzZSkgewogICAgICBjb25zdCBzaWJsaW5nc0luQ29sID0gdGhpcy52YWxpZEl0ZW1zSW5Db2woY29sdW1uKQogICAgICBjb25zdCBzZWxmSW5kZXggPSBBcnJheS5wcm90b3R5cGUuZmluZEluZGV4LmNhbGwoc2libGluZ3NJbkNvbCwgKHNibCkgPT4gewogICAgICAgIHJldHVybiBzYmwuZ2V0QXR0cmlidXRlKCdkYXRhLWtleScpID09PSBkYXRhS2V5CiAgICAgIH0pCgogICAgICAvLyBBbHJlYWR5IHRoZSBmaXJzdCBpdGVtCiAgICAgIGlmIChnZXRQcmV2aW91cyAmJiBzZWxmSW5kZXggPT09IDApIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFtzaWJsaW5nc0luQ29sLmxlbmd0aCAtIDFdCiAgICAgIH0KICAgICAgLy8gQWxyZWFkeSB0aGUgbGFzdCBpdGVtCiAgICAgIGlmICghZ2V0UHJldmlvdXMgJiYgc2VsZkluZGV4ID09PSBzaWJsaW5nc0luQ29sLmxlbmd0aCAtIDEpIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFswXQogICAgICB9CiAgICAgIC8vIFNlbGVjdGVkIHZhbHVlIG5vdCBpbiB0aGUgdmFsaWQgdmFsdWVzIGxpc3QKICAgICAgaWYgKHNlbGZJbmRleCA8IDApIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFswXQogICAgICB9CgogICAgICBpZiAoZ2V0UHJldmlvdXMpIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFtzZWxmSW5kZXggLSAxXQogICAgICB9CiAgICAgIHJldHVybiBzaWJsaW5nc0luQ29sW3NlbGZJbmRleCArIDFdCiAgICB9LAoKICAgIHByZXZJdGVtIChjb2x1bW4sIGRhdGFLZXksIGlzTWFudWFsSW5wdXQgPSBmYWxzZSkgewogICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGhpcy5nZXRDbG9zZXN0U2libGluZyhjb2x1bW4sIGRhdGFLZXksIHRydWUpCiAgICAgIGlmICh0YXJnZXRJdGVtKSB7CiAgICAgICAgcmV0dXJuIGlzTWFudWFsSW5wdXQgPyB0YXJnZXRJdGVtIDogdGFyZ2V0SXRlbS5mb2N1cygpCiAgICAgIH0KICAgIH0sCgogICAgbmV4dEl0ZW0gKGNvbHVtbiwgZGF0YUtleSwgaXNNYW51YWxJbnB1dCA9IGZhbHNlKSB7CiAgICAgIGNvbnN0IHRhcmdldEl0ZW0gPSB0aGlzLmdldENsb3Nlc3RTaWJsaW5nKGNvbHVtbiwgZGF0YUtleSwgZmFsc2UpCiAgICAgIGlmICh0YXJnZXRJdGVtKSB7CiAgICAgICAgcmV0dXJuIGlzTWFudWFsSW5wdXQgPyB0YXJnZXRJdGVtIDogdGFyZ2V0SXRlbS5mb2N1cygpCiAgICAgIH0KICAgIH0sCgogICAgZ2V0U2lkZUNvbHVtbk5hbWUgKGN1cnJlbnRDb2x1bW4sIHRvTGVmdCA9IGZhbHNlKSB7CiAgICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5JbmRleCA9IHRoaXMuaW5Vc2UudHlwZXMuaW5kZXhPZihjdXJyZW50Q29sdW1uKQogICAgICBpZiAodG9MZWZ0ICYmIGN1cnJlbnRDb2x1bW5JbmRleCA8PSAwKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdZb3VcJ3JlIGluIHRoZSBsZWZ0bW9zdCBsaXN0IGFscmVhZHknKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfSBlbHNlIGlmICghdG9MZWZ0ICYmIGN1cnJlbnRDb2x1bW5JbmRleCA9PT0gKHRoaXMuaW5Vc2UudHlwZXMubGVuZ3RoIC0gMSkpIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coJ1lvdVwncmUgaW4gdGhlIHJpZ2h0bW9zdCBsaXN0IGFscmVhZHknKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5pblVzZS50eXBlc1t0b0xlZnQgPyBjdXJyZW50Q29sdW1uSW5kZXggLSAxIDogY3VycmVudENvbHVtbkluZGV4ICsgMV0KICAgIH0sCgogICAgZ2V0Rmlyc3RJdGVtSW5TaWRlQ29sdW1uIChjdXJyZW50Q29sdW1uLCB0b0xlZnQgPSBmYWxzZSkgewogICAgICBjb25zdCB0YXJnZXRDb2x1bW4gPSB0aGlzLmdldFNpZGVDb2x1bW5OYW1lKGN1cnJlbnRDb2x1bW4sIHRvTGVmdCkKICAgICAgaWYgKCF0YXJnZXRDb2x1bW4pIHsgcmV0dXJuIH0KICAgICAgY29uc3QgbGlzdEl0ZW1zID0gdGhpcy52YWxpZEl0ZW1zSW5Db2wodGFyZ2V0Q29sdW1uKQogICAgICBpZiAobGlzdEl0ZW1zICYmIGxpc3RJdGVtc1swXSkgewogICAgICAgIHJldHVybiBsaXN0SXRlbXNbMF0KICAgICAgfQogICAgfSwKCiAgICBnZXRBY3RpdmVJdGVtSW5TaWRlQ29sdW1uIChjdXJyZW50Q29sdW1uLCB0b0xlZnQgPSBmYWxzZSkgewogICAgICBjb25zdCB0YXJnZXRDb2x1bW4gPSB0aGlzLmdldFNpZGVDb2x1bW5OYW1lKGN1cnJlbnRDb2x1bW4sIHRvTGVmdCkKICAgICAgaWYgKCF0YXJnZXRDb2x1bW4pIHsgcmV0dXJuIH0KICAgICAgY29uc3QgYWN0aXZlSXRlbXMgPSB0aGlzLmFjdGl2ZUl0ZW1JbkNvbCh0YXJnZXRDb2x1bW4pCiAgICAgIGlmIChhY3RpdmVJdGVtcyAmJiBhY3RpdmVJdGVtc1swXSkgewogICAgICAgIHJldHVybiBhY3RpdmVJdGVtc1swXQogICAgICB9CiAgICB9LAoKICAgIHRvTGVmdENvbHVtbiAoY3VycmVudENvbHVtbikgewogICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGhpcy5nZXRBY3RpdmVJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIHRydWUpIHx8IHRoaXMuZ2V0Rmlyc3RJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIHRydWUpCiAgICAgIGlmICh0YXJnZXRJdGVtKSB7CiAgICAgICAgdGFyZ2V0SXRlbS5mb2N1cygpCiAgICAgIH0KICAgIH0sCgogICAgdG9SaWdodENvbHVtbiAoY3VycmVudENvbHVtbikgewogICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGhpcy5nZXRBY3RpdmVJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIGZhbHNlKSB8fCB0aGlzLmdldEZpcnN0SXRlbUluU2lkZUNvbHVtbihjdXJyZW50Q29sdW1uLCBmYWxzZSkKICAgICAgaWYgKHRhcmdldEl0ZW0pIHsKICAgICAgICB0YXJnZXRJdGVtLmZvY3VzKCkKICAgICAgfQogICAgfSwKCiAgICAvLwogICAgLy8gTWFudWFsIElucHV0CiAgICAvLwoKICAgIG9uTW91c2VEb3duICgpIHsKICAgICAgaWYgKCF0aGlzLm1hbnVhbElucHV0KSB7IHJldHVybiB9CiAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5zZWxlY3Rpb25UaW1lcikKICAgICAgdGhpcy5zZWxlY3Rpb25UaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpCiAgICAgICAgaWYgKHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5pbnB1dCkgewogICAgICAgICAgY29uc3QgbmVhcmVzdFNsb3QgPSB0aGlzLmdldE5lYXJlc3RDaHVua0J5UG9zKHRoaXMuJHJlZnMuaW5wdXQuc2VsZWN0aW9uU3RhcnQgfHwgMCkKICAgICAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihuZWFyZXN0U2xvdCkKICAgICAgICB9CiAgICAgIH0sIDUwKQogICAgfSwKCiAgICBrZXlEb3duSGFuZGxlciAoZXZ0KSB7CiAgICAgIGlmIChldnQuaXNDb21wb3NpbmcgfHwgZXZ0LmtleUNvZGUgPT09IDIyOSkgewogICAgICAgIC8vIFNraXAgSU1FIGlucHV0cwogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgICAgLy8gTnVtYmVycwogICAgICBpZiAoKGV2dC5rZXlDb2RlID49IDQ4ICYmIGV2dC5rZXlDb2RlIDw9IDU3KSB8fCAoZXZ0LmtleUNvZGUgPj0gOTYgJiYgZXZ0LmtleUNvZGUgPD0gMTA1KSkgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgdGhpcy5rZXlib2FyZElucHV0KGV2dC5rZXkpCiAgICAgIC8vIEF8UHxNCiAgICAgIH0gZWxzZSBpZiAoWzY1LCA4MCwgNzddLmluY2x1ZGVzKGV2dC5rZXlDb2RlKSkgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgdGhpcy5rZXlib2FyZElucHV0KGV2dC5rZXksIHRydWUpCiAgICAgIC8vIEFycm93IGtleXMKICAgICAgfSBlbHNlIGlmIChldnQua2V5Q29kZSA+PSAzNyAmJiBldnQua2V5Q29kZSA8PSA0MCkgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgdGhpcy5jbGVhcktiSW5wdXRMb2coKQogICAgICAgIHRoaXMuYXJyb3dIYW5kbGVyKGV2dCkKICAgICAgLy8gRGVsZXRlfEJhY2tzcGFjZQogICAgICB9IGVsc2UgaWYgKGV2dC5rZXlDb2RlID09PSA4IHx8IGV2dC5rZXlDb2RlID09PSA0NikgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgdGhpcy5jbGVhcktiSW5wdXRMb2coKQogICAgICAgIHRoaXMuY2xlYXJUaW1lKCkKICAgICAgLy8gVGFiCiAgICAgIH0gZWxzZSBpZiAoZXZ0LmtleUNvZGUgPT09IDkpIHsKICAgICAgICB0aGlzLmNsZWFyS2JJbnB1dExvZygpCiAgICAgICAgdGhpcy50YWJIYW5kbGVyKGV2dCkKICAgICAgLy8gQ29sb258U3BhY2UKICAgICAgfSBlbHNlIGlmIChldnQua2V5Q29kZSA9PT0gMTg2IHx8IGV2dC5rZXlDb2RlID09PSAzMikgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgdGhpcy5jbGVhcktiSW5wdXRMb2coKQogICAgICAgIHRoaXMudG9OZXh0U2xvdCgpCiAgICAgIC8vIFByZXZlbnQgYW55IE5vbi1FU0MgYW5kIG5vbi1wYXN0aW5nIGlucHV0cwogICAgICB9IGVsc2UgaWYgKGV2dC5rZXlDb2RlICE9PSAyNyAmJiAhKGV2dC5tZXRhS2V5IHx8IGV2dC5jdHJsS2V5KSkgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgIH0KICAgIH0sCgogICAgb25Db21wb3N0aW9uU3RhcnQgKGV2dCkgewogICAgICBldnQucHJldmVudERlZmF1bHQoKQogICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCkKICAgICAgdGhpcy5iYWtDdXJyZW50UG9zID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpCiAgICAgIHJldHVybiBmYWxzZQogICAgfSwKCiAgICBvbkNvbXBvc3Rpb25FbmQgKGV2dCkgewogICAgICBldnQucHJldmVudERlZmF1bHQoKQogICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCkKCiAgICAgIGNvbnN0IGNwc0RhdGEgPSBldnQuZGF0YQogICAgICBsZXQgaW5wdXRJc0N1c3RvbUFwbVRleHQgPSBmYWxzZQogICAgICBpZiAodGhpcy5oYXMuY3VzdG9tQXBtVGV4dCkgewogICAgICAgIGlucHV0SXNDdXN0b21BcG1UZXh0ID0gdGhpcy5pc0N1c3RvbUFwbVRleHQoY3BzRGF0YSkKICAgICAgfQogICAgICBpZiAoaW5wdXRJc0N1c3RvbUFwbVRleHQpIHsKICAgICAgICB0aGlzLnNldFNhbml0aXplZFZhbHVlVG9TZWN0aW9uKCdhcG0nLCBpbnB1dElzQ3VzdG9tQXBtVGV4dCkKICAgICAgfQoKICAgICAgdGhpcy4kcmVmcy5pbnB1dC52YWx1ZSA9IHRoaXMuaGFzLmN1c3RvbUFwbVRleHQgPyB0aGlzLmN1c3RvbURpc3BsYXlUaW1lIDogdGhpcy5kaXNwbGF5VGltZQoKICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgIGlmICh0aGlzLmJha0N1cnJlbnRQb3MpIHsKICAgICAgICAgIGNvbnN0IGJha1BvcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5iYWtDdXJyZW50UG9zKSkKICAgICAgICAgIGlmIChpbnB1dElzQ3VzdG9tQXBtVGV4dCkgewogICAgICAgICAgICBiYWtQb3MuZW5kID0gKGJha1Bvcy5zdGFydCArIGNwc0RhdGEubGVuZ3RoKQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5kZWJvdW5jZVNldElucHV0U2VsZWN0aW9uKGJha1BvcykKICAgICAgICAgIHRoaXMuYmFrQ3VycmVudFBvcyA9IG51bGwKICAgICAgICB9CiAgICAgIH0pCiAgICAgIHJldHVybiBmYWxzZQogICAgfSwKCiAgICBwYXN0ZUhhbmRsZXIgKGV2dCkgewogICAgICBldnQucHJldmVudERlZmF1bHQoKQogICAgICBsZXQgcGFzdGluZ1RleHQgPSAoZXZ0LmNsaXBib2FyZERhdGEgfHwgd2luZG93LmNsaXBib2FyZERhdGEpLmdldERhdGEoJ3RleHQnKQogICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICB0aGlzLmRlYnVnTG9nKGBQYXN0aW5nIHZhbHVlICIke3Bhc3RpbmdUZXh0fSIgZnJvbSBjbGlwYm9hcmRgKQogICAgICB9CiAgICAgIGlmICghcGFzdGluZ1RleHQgfHwgIXBhc3RpbmdUZXh0Lmxlbmd0aCkgeyByZXR1cm4gfQoKICAgICAgLy8gUmVwbGFjZSBjdXN0b20gQU0vUE0gdGV4dCAoaWYgYW55KQogICAgICBpZiAodGhpcy5oYXMuY3VzdG9tQXBtVGV4dCkgewogICAgICAgIHBhc3RpbmdUZXh0ID0gdGhpcy5yZXBsYWNlQ3VzdG9tQXBtVGV4dChwYXN0aW5nVGV4dCkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgdGhpcy5yZWFkU3RyaW5nVmFsdWVzKHBhc3RpbmdUZXh0KQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMua2JJbnB1dExvZyA9IHBhc3RpbmdUZXh0LnN1YnN0cigtMiwgMikKICAgICAgICB0aGlzLnNldEtiSW5wdXQoKQogICAgICAgIHRoaXMuZGVib3VuY2VDbGVhcktiTG9nKCkKICAgICAgfQogICAgfSwKCiAgICBhcnJvd0hhbmRsZXIgKGV2dCkgewogICAgICBjb25zdCBkaXJlY3Rpb24gPSB7IDM3OiAnTCcsIDM4OiAnVScsIDM5OiAnUicsIDQwOiAnRCcgfVtldnQua2V5Q29kZV0KICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ1UnIHx8IGRpcmVjdGlvbiA9PT0gJ0QnKSB7CiAgICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgICB0aGlzLnNlbGVjdEZpcnN0VmFsaWRWYWx1ZSgpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGN1cnJlbnRDaHVuayA9IHRoaXMuZ2V0Q3VycmVudFRva2VuQ2h1bmsoKQogICAgICAgICAgaWYgKCFjdXJyZW50Q2h1bmspIHsKICAgICAgICAgICAgdGhpcy5zZWxlY3RGaXJzdFZhbGlkVmFsdWUoKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHRva2VuVHlwZSA9IGN1cnJlbnRDaHVuay50eXBlCiAgICAgICAgICB0aGlzLmdldENsb3Nlc3RWYWxpZEl0ZW1JbkNvbCh0b2tlblR5cGUsIHRoaXNbdG9rZW5UeXBlXSwgZGlyZWN0aW9uKQogICAgICAgICAgY29uc3QgbmV3Q2h1bmtQb3MgPSB0aGlzLmdldEN1cnJlbnRUb2tlbkNodW5rKCkKICAgICAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihuZXdDaHVua1BvcykKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnUicpIHsKICAgICAgICB0aGlzLnRvTGF0ZXJhbFRva2VuKGZhbHNlKQogICAgICB9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ0wnKSB7CiAgICAgICAgdGhpcy50b0xhdGVyYWxUb2tlbih0cnVlKQogICAgICB9CiAgICB9LAoKICAgIHRhYkhhbmRsZXIgKGV2dCkgewogICAgICBpZiAoIXRoaXMuaW5wdXRJc0VtcHR5ICYmIHRoaXMudG9rZW5DaHVua3NQb3MgJiYgdGhpcy50b2tlbkNodW5rc1Bvcy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjdXJyZW50Q2h1bmsgPSB0aGlzLmdldEN1cnJlbnRUb2tlbkNodW5rKCkKICAgICAgICBpZiAoIWN1cnJlbnRDaHVuaykgeyByZXR1cm4gfQogICAgICAgIGNvbnN0IGZpcnN0Q2h1bmsgPSB0aGlzLnRva2VuQ2h1bmtzUG9zWzBdCiAgICAgICAgY29uc3QgbGFzdENodW5rID0gdGhpcy50b2tlbkNodW5rc1Bvc1t0aGlzLnRva2VuQ2h1bmtzUG9zLmxlbmd0aCAtIDFdCiAgICAgICAgaWYgKChldnQuc2hpZnRLZXkgJiYgY3VycmVudENodW5rLnRva2VuICE9PSBmaXJzdENodW5rLnRva2VuKSB8fCAoIWV2dC5zaGlmdEtleSAmJiBjdXJyZW50Q2h1bmsudG9rZW4gIT09IGxhc3RDaHVuay50b2tlbikpIHsKICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICB0aGlzLnRvTGF0ZXJhbFRva2VuKGV2dC5zaGlmdEtleSkKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodGhpcy5hcHBlbmRUb0JvZHkgJiYgdGhpcy5hZHZhbmNlZEtleWJvYXJkKSB7CiAgICAgICAgaWYgKGV2dC5zaGlmdEtleSkgeyByZXR1cm4gfQogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgICBjb25zdCBmaXJzdENvbHVtbiA9IHRoaXMuaW5Vc2UudHlwZXNbMF0KICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gdGhpcy52YWxpZEl0ZW1zSW5Db2woZmlyc3RDb2x1bW4pWzBdCiAgICAgICAgICBpZiAodGFyZ2V0VmFsdWUpIHsKICAgICAgICAgICAgdGFyZ2V0VmFsdWUuZm9jdXMoKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBrZXlib2FyZElucHV0IChuZXdDaGFyLCBpc0FwbSA9IGZhbHNlKSB7CiAgICAgIGNvbnN0IGN1cnJlbnRDaHVuayA9IHRoaXMuZ2V0Q3VycmVudFRva2VuQ2h1bmsoKQogICAgICBpZiAoIWN1cnJlbnRDaHVuayB8fCAoY3VycmVudENodW5rLnR5cGUgIT09ICdhcG0nICYmIGlzQXBtKSB8fCAoY3VycmVudENodW5rLnR5cGUgPT09ICdhcG0nICYmICFpc0FwbSkpIHsgcmV0dXJuIH0KICAgICAgdGhpcy5rYklucHV0TG9nID0gYCR7dGhpcy5rYklucHV0TG9nLnN1YnN0cigtMSl9JHtuZXdDaGFyfWAKICAgICAgdGhpcy5zZXRLYklucHV0KCkKICAgICAgdGhpcy5kZWJvdW5jZUNsZWFyS2JMb2coKQogICAgfSwKCiAgICBjbGVhcktiSW5wdXRMb2cgKCkgewogICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMua2JJbnB1dFRpbWVyKQogICAgICB0aGlzLmtiSW5wdXRMb2cgPSAnJwogICAgfSwKCiAgICBkZWJvdW5jZUNsZWFyS2JMb2cgKCkgewogICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMua2JJbnB1dFRpbWVyKQogICAgICB0aGlzLmtiSW5wdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmNsZWFyS2JJbnB1dExvZygpCiAgICAgIH0sIHRoaXMub3B0cy5tYW51YWxJbnB1dFRpbWVvdXQpCiAgICB9LAoKICAgIHNldEtiSW5wdXQgKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdmFsdWUgfHwgdGhpcy5rYklucHV0TG9nCiAgICAgIGNvbnN0IGN1cnJlbnRDaHVuayA9IHRoaXMuZ2V0Q3VycmVudFRva2VuQ2h1bmsoKQogICAgICBpZiAoIWN1cnJlbnRDaHVuayB8fCAhdmFsdWUgfHwgIXZhbHVlLmxlbmd0aCkgeyByZXR1cm4gfQogICAgICBjb25zdCBjaHVua1R5cGUgPSBjdXJyZW50Q2h1bmsudHlwZQogICAgICBjb25zdCBjaHVua1Rva2VuID0gY3VycmVudENodW5rLnRva2VuCgogICAgICBsZXQgdmFsaWRWYWx1ZQogICAgICBpZiAoY2h1bmtUeXBlID09PSAnYXBtJykgewogICAgICAgIGlmICh0aGlzLmxvd2VyQ2FzZWRBcG0odmFsdWUpLmluY2x1ZGVzKCdhJykpIHsKICAgICAgICAgIHZhbGlkVmFsdWUgPSAnYW0nCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmxvd2VyQ2FzZWRBcG0odmFsdWUpLmluY2x1ZGVzKCdwJykpIHsKICAgICAgICAgIHZhbGlkVmFsdWUgPSAncG0nCiAgICAgICAgfQogICAgICAgIGlmICh2YWxpZFZhbHVlKSB7CiAgICAgICAgICB2YWxpZFZhbHVlID0gY2h1bmtUb2tlbiA9PT0gJ0EnID8gdmFsaWRWYWx1ZS50b1VwcGVyQ2FzZSgpIDogdmFsaWRWYWx1ZQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5pc1ZhbGlkVmFsdWUoY2h1bmtUb2tlbiwgdmFsdWUpKSB7CiAgICAgICAgICB2YWxpZFZhbHVlID0gdmFsdWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbGFzdElucHV0VmFsdWUgPSB0aGlzLmZvcm1hdFZhbHVlKGNodW5rVG9rZW4sIHZhbHVlLnN1YnN0cigtMSkpCiAgICAgICAgICBpZiAodGhpcy5pc1ZhbGlkVmFsdWUoY2h1bmtUb2tlbiwgbGFzdElucHV0VmFsdWUpKSB7CiAgICAgICAgICAgIHZhbGlkVmFsdWUgPSBsYXN0SW5wdXRWYWx1ZQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHZhbGlkVmFsdWUpIHsKICAgICAgICB0aGlzLnNldFNhbml0aXplZFZhbHVlVG9TZWN0aW9uKGNodW5rVHlwZSwgdmFsaWRWYWx1ZSkKICAgICAgICBjb25zdCBuZXdDaHVua1BvcyA9IHRoaXMuZ2V0Q3VycmVudFRva2VuQ2h1bmsoKQogICAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihuZXdDaHVua1BvcykgICAgICAKICAgICAgfQogICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICBpZiAodmFsaWRWYWx1ZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZyhgU3VjY2Vzc2Z1bGx5IHNldCB2YWx1ZSAiJHt2YWxpZFZhbHVlfSIgZnJvbSBsYXRlc3QgaW5wdXQgIiR7dmFsdWV9IiBmb3IgdGhlICIke2NodW5rVHlwZX0iIHNsb3RgKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBWYWx1ZSAiJHt2YWx1ZX0iIGlzIGludmFsaWQgaW4gdGhlICIke2NodW5rVHlwZX0iIHNsb3RgKQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvLyBGb3JtIEF1dG9maWxsCiAgICBvbkNoYW5nZSAoKSB7CiAgICAgIGlmICghdGhpcy5tYW51YWxJbnB1dCB8fCAhdGhpcy4kcmVmcyB8fCAhdGhpcy4kcmVmcy5pbnB1dCkgeyByZXR1cm4gfQogICAgICBjb25zdCBhdXRvRmlsbFZhbHVlID0gdGhpcy4kcmVmcy5pbnB1dC52YWx1ZSB8fCAnJwogICAgICBpZiAoYXV0b0ZpbGxWYWx1ZSAmJiBhdXRvRmlsbFZhbHVlLmxlbmd0aCkgewogICAgICAgIHRoaXMucmVhZFN0cmluZ1ZhbHVlcyhhdXRvRmlsbFZhbHVlKQogICAgICB9CiAgICB9LAoKICAgIGdldE5lYXJlc3RDaHVua0J5UG9zIChzdGFydFBvcykgewogICAgICBpZiAoIXRoaXMudG9rZW5DaHVua3NQb3MgfHwgIXRoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoKSB7IHJldHVybiB9CiAgICAgIGxldCBuZWFyZXN0CiAgICAgIGxldCBuZWFyZXN0RGVsdGEgPSAtMQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaHVuayA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy50b2tlbkNodW5rc1Bvc1tpXSkpCiAgICAgICAgaWYgKGNodW5rLnN0YXJ0ID09PSBzdGFydFBvcykgewogICAgICAgICAgcmV0dXJuIGNodW5rCiAgICAgICAgfQogICAgICAgIGNvbnN0IGRlbHRhID0gTWF0aC5hYnMoY2h1bmsuc3RhcnQgLSBzdGFydFBvcykKICAgICAgICBpZiAobmVhcmVzdERlbHRhIDwgMCkgewogICAgICAgICAgbmVhcmVzdCA9IGNodW5rCiAgICAgICAgICBuZWFyZXN0RGVsdGEgPSBkZWx0YQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobmVhcmVzdERlbHRhIDw9IGRlbHRhKSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0CiAgICAgICAgICB9CiAgICAgICAgICBuZWFyZXN0RGVsdGEgPSBkZWx0YQogICAgICAgICAgbmVhcmVzdCA9IGNodW5rCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZWFyZXN0CiAgICB9LAoKICAgIHNlbGVjdEZpcnN0VmFsaWRWYWx1ZSAoKSB7CiAgICAgIGlmICghdGhpcy50b2tlbkNodW5rc1BvcyB8fCAhdGhpcy50b2tlbkNodW5rc1Bvcy5sZW5ndGgpIHsgcmV0dXJuIH0KICAgICAgY29uc3QgZmlyc3RTbG90VHlwZSA9IHRoaXMudG9rZW5DaHVua3NQb3NbMF0udHlwZQogICAgICBpZiAoZmlyc3RTbG90VHlwZSA9PT0gJ2hvdXInKSB7CiAgICAgICAgdGhpcy5nZXRDbG9zZXN0SG91ckl0ZW0oKQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZ2V0Q2xvc2VzdFZhbGlkSXRlbUluQ29sKGZpcnN0U2xvdFR5cGUsIHRoaXNbZmlyc3RTbG90VHlwZV0pCiAgICAgIH0KICAgICAgdGhpcy5zZWxlY3RGaXJzdFNsb3QoKQogICAgfSwKCiAgICBnZXRDbG9zZXN0SG91ckl0ZW0gKGN1cnJlbnRWYWx1ZSwgZGlyZWN0aW9uID0gJ1UnKSB7CiAgICAgIGlmICghdGhpcy52YWxpZEhvdXJzTGlzdCB8fCAhdGhpcy52YWxpZEhvdXJzTGlzdC5sZW5ndGgpIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYE5vIHZhbGlkIGhvdXIgdmFsdWVzIGZvdW5kLCBwbGVhc2UgY2hlY2sgeW91ciAiaG91ci1yYW5nZSIgY29uZmlnXG5ob3VyLXJhbmdlOiAke0pTT04uc3RyaW5naWZ5KHRoaXMuaG91clJhbmdlKX1gKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBpZiAoIWN1cnJlbnRWYWx1ZSkgewogICAgICAgIHRoaXMuc2V0TWFudWFsSG91cih0aGlzLnZhbGlkSG91cnNMaXN0WzBdKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHRoaXMudmFsaWRIb3Vyc0xpc3QuZmluZEluZGV4KGl0ZW0gPT4gewogICAgICAgIGlmICghdGhpcy5iYXNlT24xMkhvdXJzKSB7CiAgICAgICAgICByZXR1cm4gaXRlbSA9PT0gY3VycmVudFZhbHVlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHZhbHVlS2V5ID0gYCR7Y3VycmVudFZhbHVlfSR7dGhpcy5sb3dlckNhc2VkQXBtKHRoaXMuYXBtKSA9PT0gJ3BtJyA/ICdwJyA6ICdhJ31gIAogICAgICAgICAgcmV0dXJuIGl0ZW0gPT09IHZhbHVlS2V5CiAgICAgICAgfQogICAgICB9KQogICAgICBsZXQgbmV4dEluZGV4CiAgICAgIGlmIChjdXJyZW50SW5kZXggPT09IC0xKSB7CiAgICAgICAgbmV4dEluZGV4ID0gMAogICAgICB9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ0QnKSB7CiAgICAgICAgbmV4dEluZGV4ID0gY3VycmVudEluZGV4ID09PSAwID8gdGhpcy52YWxpZEhvdXJzTGlzdC5sZW5ndGggLSAxIDogY3VycmVudEluZGV4IC0gMQogICAgICB9IGVsc2UgewogICAgICAgIG5leHRJbmRleCA9IChjdXJyZW50SW5kZXggKyAxKSAlIHRoaXMudmFsaWRIb3Vyc0xpc3QubGVuZ3RoCiAgICAgIH0KICAgICAgY29uc3QgbmV4dEl0ZW0gPSB0aGlzLnZhbGlkSG91cnNMaXN0W25leHRJbmRleF0KICAgICAgdGhpcy5zZXRNYW51YWxIb3VyKG5leHRJdGVtKQogICAgfSwKCiAgICBnZXRDbG9zZXN0VmFsaWRJdGVtSW5Db2wgKGNvbHVtbiwgY3VycmVudFZhbHVlLCBkaXJlY3Rpb24gPSAnVScpIHsKICAgICAgaWYgKGNvbHVtbiA9PT0gJ2hvdXInKSB7CiAgICAgICAgdGhpcy5nZXRDbG9zZXN0SG91ckl0ZW0oY3VycmVudFZhbHVlLCBkaXJlY3Rpb24pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbmV4dEl0ZW0gPSBkaXJlY3Rpb24gPT09ICdEJyA/IHRoaXMucHJldkl0ZW0oY29sdW1uLCB0aGlzW2NvbHVtbl0sIHRydWUpIDogdGhpcy5uZXh0SXRlbShjb2x1bW4sIHRoaXNbY29sdW1uXSwgdHJ1ZSkKICAgICAgICBpZiAobmV4dEl0ZW0pIHsKICAgICAgICAgIHRoaXMuc2VsZWN0KGNvbHVtbiwgbmV4dEl0ZW0uZ2V0QXR0cmlidXRlKCdkYXRhLWtleScpKQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBzZXRTYW5pdGl6ZWRWYWx1ZVRvU2VjdGlvbiAoc2VjdGlvbiwgaW5wdXRWYWx1ZSkgewogICAgICBpZiAoIXNlY3Rpb24gfHwgIXRoaXMuZ2V0VG9rZW5CeVR5cGUoc2VjdGlvbikpIHsgcmV0dXJuIH0KICAgICAgLy8gTk9URTogRGlzYWJsZWQgdmFsdWVzIGFyZSBhbGxvd2VkIGhlcmUsIGZvbGxvd2VkIGJ5IGFuICdlcnJvcicgZXZlbnQsIHRob3VnaAogICAgICBjb25zdCBzYW5pdGl6ZWRWYWx1ZSA9IHRoaXMuc2FuaXRpemVkVmFsdWUodGhpcy5nZXRUb2tlbkJ5VHlwZShzZWN0aW9uKSwgaW5wdXRWYWx1ZSkKICAgICAgdGhpc1tzZWN0aW9uXSA9IHNhbml0aXplZFZhbHVlCiAgICB9LAoKICAgIHNldE1hbnVhbEhvdXIgKG5leHRJdGVtKSB7CiAgICAgIGlmICh0aGlzLmlzMTJoUmFuZ2UobmV4dEl0ZW0pKSB7CiAgICAgICAgY29uc3QgaG91clQgPSB0aGlzLm1hdGNoMTJoUmFuZ2UobmV4dEl0ZW0pCiAgICAgICAgY29uc3QgYXBtVmFsdWUgPSBob3VyVFsyXSA9PT0gJ2EnID8gJ0FNJyA6ICdQTScKICAgICAgICB0aGlzLnNldFNhbml0aXplZFZhbHVlVG9TZWN0aW9uKCdhcG0nLCB0aGlzLmFwbVR5cGUgPT09ICdhJyA/IGFwbVZhbHVlLnRvTG93ZXJDYXNlKCkgOiBhcG1WYWx1ZSkKICAgICAgICB0aGlzLnNldFNhbml0aXplZFZhbHVlVG9TZWN0aW9uKCdob3VyJywgaG91clRbMV0pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRTYW5pdGl6ZWRWYWx1ZVRvU2VjdGlvbignaG91cicsIG5leHRJdGVtKQogICAgICB9CiAgICB9LAoKICAgIGRlYm91bmNlU2V0SW5wdXRTZWxlY3Rpb24gKHtzdGFydCA9IDAsIGVuZCA9IDAgfSkgewogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgdGhpcy5zZXRJbnB1dFNlbGVjdGlvblJhbmdlKHN0YXJ0LCBlbmQpCiAgICAgIH0pCiAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5zZWxlY3Rpb25UaW1lcikKICAgICAgdGhpcy5zZWxlY3Rpb25UaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpCiAgICAgICAgLy8gRG91YmxlLWNoZWNrIHNlbGVjdGlvbiBmb3IgMTJociBmb3JtYXQKICAgICAgICBpZiAodGhpcy4kcmVmcy5pbnB1dCAmJiAodGhpcy4kcmVmcy5pbnB1dC5zZWxlY3Rpb25TdGFydCAhPT0gc3RhcnQgfHwgdGhpcy4kcmVmcy5pbnB1dC5zZWxlY3Rpb25FbmQgIT09IGVuZCkpIHsKICAgICAgICAgIHRoaXMuc2V0SW5wdXRTZWxlY3Rpb25SYW5nZShzdGFydCwgZW5kKQogICAgICAgIH0KICAgICAgfSwgMzApCiAgICB9LAoKICAgIHNldElucHV0U2VsZWN0aW9uUmFuZ2UgKHN0YXJ0LCBlbmQpIHsKICAgICAgaWYgKHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5pbnB1dCkgewogICAgICAgIHRoaXMuJHJlZnMuaW5wdXQuc2V0U2VsZWN0aW9uUmFuZ2Uoc3RhcnQsIGVuZCkKICAgICAgfQogICAgfSwKCiAgICBnZXRDdXJyZW50VG9rZW5DaHVuayAoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE5lYXJlc3RDaHVua0J5UG9zKCh0aGlzLiRyZWZzLmlucHV0ICYmIHRoaXMuJHJlZnMuaW5wdXQuc2VsZWN0aW9uU3RhcnQpIHx8IDApCiAgICB9LAoKICAgIHNlbGVjdEZpcnN0U2xvdCAoKSB7CiAgICAgIGNvbnN0IGZpcnN0Q2h1bmtQb3MgPSB0aGlzLmdldE5lYXJlc3RDaHVua0J5UG9zKDApCiAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihmaXJzdENodW5rUG9zKQogICAgfSwKCiAgICB0b05leHRTbG90ICgpIHsKICAgICAgaWYgKCF0aGlzLmlucHV0SXNFbXB0eSAmJiB0aGlzLnRva2VuQ2h1bmtzUG9zICYmIHRoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgY3VycmVudENodW5rID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpCiAgICAgICAgaWYgKCFjdXJyZW50Q2h1bmspIHsgcmV0dXJuIH0KICAgICAgICBjb25zdCBsYXN0Q2h1bmsgPSB0aGlzLnRva2VuQ2h1bmtzUG9zW3RoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoIC0gMV0KICAgICAgICBpZiAoY3VycmVudENodW5rLnRva2VuICE9PSBsYXN0Q2h1bmsudG9rZW4pIHsKICAgICAgICAgIHRoaXMudG9MYXRlcmFsVG9rZW4oZmFsc2UpCiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHRvTGF0ZXJhbFRva2VuICh0b0xlZnQpIHsKICAgICAgY29uc3QgY3VycmVudENodW5rID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpCiAgICAgIGlmICghY3VycmVudENodW5rKSB7CiAgICAgICAgdGhpcy5zZWxlY3RGaXJzdFZhbGlkVmFsdWUoKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNvbnN0IGN1cnJlbnRDaHVua0luZGV4ID0gdGhpcy50b2tlbkNodW5rc1Bvcy5maW5kSW5kZXgoY2hrID0+IGNoay50b2tlbiA9PT0gY3VycmVudENodW5rLnRva2VuKQogICAgICBpZiAoKCF0b0xlZnQgJiYgY3VycmVudENodW5rSW5kZXggPj0gdGhpcy50b2tlbkNodW5rc1Bvcy5sZW5ndGggLSAxKSB8fCAodG9MZWZ0ICYmIGN1cnJlbnRDaHVua0luZGV4ID09PSAwKSkgewogICAgICAgIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgaWYgKHRvTGVmdCkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdZb3VcJ3JlIGluIHRoZSBsZWZ0bW9zdCBzbG90IGFscmVhZHknKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5kZWJ1Z0xvZygnWW91XCdyZSBpbiB0aGUgcmlnaHRtb3N0IHNsb3QgYWxyZWFkeScpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNvbnN0IHRhcmdldFNsb3RQb3MgPSB0b0xlZnQgPyB0aGlzLnRva2VuQ2h1bmtzUG9zW2N1cnJlbnRDaHVua0luZGV4IC0gMV0gOiB0aGlzLnRva2VuQ2h1bmtzUG9zW2N1cnJlbnRDaHVua0luZGV4ICsgMV0KICAgICAgdGhpcy5kZWJvdW5jZVNldElucHV0U2VsZWN0aW9uKHRhcmdldFNsb3RQb3MpCiAgICB9LAoKICAgIGlzQ3VzdG9tQXBtVGV4dCAoaW5wdXREYXRhKSB7CiAgICAgIGlmICghaW5wdXREYXRhIHx8ICFpbnB1dERhdGEubGVuZ3RoKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIGlmICh0aGlzLmFtVGV4dCAmJiB0aGlzLmFtVGV4dCA9PT0gaW5wdXREYXRhKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXBtVHlwZSA9PT0gJ0EnID8gJ0FNJyA6ICdhbScKICAgICAgfQogICAgICBpZiAodGhpcy5wbVRleHQgJiYgdGhpcy5wbVRleHQgPT09IGlucHV0RGF0YSkgewogICAgICAgIHJldHVybiB0aGlzLmFwbVR5cGUgPT09ICdBJyA/ICdQTScgOiAncG0nCiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlCiAgICB9LAoKICAgIHJlcGxhY2VDdXN0b21BcG1UZXh0IChpbnB1dFN0cmluZykgewogICAgICBpZiAodGhpcy5hbVRleHQgJiYgdGhpcy5hbVRleHQubGVuZ3RoICYmIGlucHV0U3RyaW5nLmluY2x1ZGVzKHRoaXMuYW1UZXh0KSkgewogICAgICAgIHJldHVybiBpbnB1dFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5hbVRleHQsICdnJyksIHRoaXMuYXBtVHlwZSA9PT0gJ0EnID8gJ0FNJyA6ICdhbScpCiAgICAgIH0gZWxzZSBpZiAodGhpcy5wbVRleHQgJiYgdGhpcy5wbVRleHQubGVuZ3RoICYmIGlucHV0U3RyaW5nLmluY2x1ZGVzKHRoaXMucG1UZXh0KSkgewogICAgICAgIHJldHVybiBpbnB1dFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5wbVRleHQsICdnJyksIHRoaXMuYXBtVHlwZSA9PT0gJ0EnID8gJ1BNJyA6ICdwbScpCiAgICAgIH0KICAgICAgcmV0dXJuIGlucHV0U3RyaW5nCiAgICB9LAoKICAgIGNoZWNrRHJvcERpcmVjdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcy4kZWwpIHsgcmV0dXJuIH0KICAgICAgbGV0IGNvbnRhaW5lcgogICAgICBpZiAodGhpcy5jb250YWluZXJJZCAmJiB0aGlzLmNvbnRhaW5lcklkLmxlbmd0aCkgewogICAgICAgIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuY29udGFpbmVySWQpCiAgICAgICAgaWYgKCFjb250YWluZXIgJiYgdGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYENvbnRhaW5lciB3aXRoIGlkICIke3RoaXMuY29udGFpbmVySWR9IiBub3QgZm91bmQuIEZhbGxiYWNrIHRvIGRvY3VtZW50IGJvZHkuYCkKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgZWwgPSB0aGlzLiRlbAogICAgICBsZXQgc3BhY2VEb3duCiAgICAgIGlmIChjb250YWluZXIgJiYgY29udGFpbmVyLm9mZnNldEhlaWdodCkgewogICAgICAgIC8vIFZhbGlkIGNvbnRhaW5lciBmb3VuZAogICAgICAgIHNwYWNlRG93biA9IChjb250YWluZXIub2Zmc2V0VG9wICsgY29udGFpbmVyLm9mZnNldEhlaWdodCkgLSAoZWwub2Zmc2V0VG9wICsgZWwub2Zmc2V0SGVpZ2h0KQogICAgICB9IGVsc2UgewogICAgICAgIC8vIEZhbGxiYWNrIHRvIGRvY3VtZW50IGJvZHkKICAgICAgICBjb25zdCBkb2NIZWlnaHQgPSBNYXRoLm1heChkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodCwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbEhlaWdodCwgZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQsIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0LCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQogICAgICAgIHNwYWNlRG93biA9IGRvY0hlaWdodCAtIChlbC5vZmZzZXRUb3AgKyBlbC5vZmZzZXRIZWlnaHQpCiAgICAgIH0KICAgICAgdGhpcy5mb3JjZURyb3BPblRvcCA9IHRoaXMub3B0cy5kcm9wT2Zmc2V0SGVpZ2h0ID4gc3BhY2VEb3duCiAgICB9LAoKICAgIC8vCiAgICAvLyBIZWxwZXJzCiAgICAvLwoKICAgIGlzMTJoUmFuZ2UgKHZhbHVlKSB7CiAgICAgIHJldHVybiAvXlxkezEsMn0oYXxwfEF8UCkkLy50ZXN0KHZhbHVlKQogICAgfSwKCiAgICBtYXRjaDEyaFJhbmdlICh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUubWF0Y2goL14oXGR7MSwyfSkoYXxwfEF8UCkkLykKICAgIH0sCgogICAgaXNOdW1iZXIgKHZhbHVlKSB7CiAgICAgIHJldHVybiAhaXNOYU4ocGFyc2VGbG9hdCh2YWx1ZSkpICYmIGlzRmluaXRlKHZhbHVlKQogICAgfSwKCiAgICBpc0Jhc2ljVHlwZSAodHlwZSkgewogICAgICByZXR1cm4gQ09ORklHLkJBU0lDX1RZUEVTLmluY2x1ZGVzKHR5cGUpCiAgICB9LAoKICAgIGxvd2VyQ2FzZWRBcG0gKGFwbVZhbHVlKSB7CiAgICAgIHJldHVybiAoYXBtVmFsdWUgfHwgJycpLnRvTG93ZXJDYXNlKCkKICAgIH0sCgogICAgZ2V0VG9rZW5SZWdleCAodG9rZW4pIHsKICAgICAgc3dpdGNoICh0b2tlbikgewogICAgICAgIGNhc2UgJ0hIJzoKICAgICAgICAgIHJldHVybiAnKFswMV1bMC05XXwyWzAtM118SHsyfSknCiAgICAgICAgY2FzZSAnSCc6CiAgICAgICAgICByZXR1cm4gJyhbMC05XXsxfXwxWzAtOV18MlswLTNdfEh7MX0pJwogICAgICAgIGNhc2UgJ2hoJzoKICAgICAgICAgIHJldHVybiAnKDBbMS05XXwxWzAtMl18aHsyfSknCiAgICAgICAgY2FzZSAnaCc6CiAgICAgICAgICByZXR1cm4gJyhbMS05XXsxfXwxWzAtMl18aHsxfSknCiAgICAgICAgY2FzZSAna2snOgogICAgICAgICAgcmV0dXJuICcoMFsxLTldfDFbMC05XXwyWzAtNF18a3syfSknCiAgICAgICAgY2FzZSAnayc6CiAgICAgICAgICByZXR1cm4gJyhbMS05XXsxfXwxWzAtOV18MlswLTRdfGt7MX0pJwogICAgICAgIGNhc2UgJ21tJzoKICAgICAgICAgIHJldHVybiAnKFswLTVdWzAtOV18bXsyfSknCiAgICAgICAgY2FzZSAnc3MnOgogICAgICAgICAgcmV0dXJuICcoWzAtNV1bMC05XXxzezJ9KScKICAgICAgICBjYXNlICdtJzoKICAgICAgICAgIHJldHVybiAnKFswLTldezF9fFsxLTVdWzAtOV18bXsxfSknCiAgICAgICAgY2FzZSAncyc6CiAgICAgICAgICByZXR1cm4gJyhbMC05XXsxfXxbMS01XVswLTldfHN7MX0pJwogICAgICAgIGNhc2UgJ0EnOgogICAgICAgICAgcmV0dXJuICcoQU18UE18QXsxfSknCiAgICAgICAgY2FzZSAnYSc6CiAgICAgICAgICByZXR1cm4gJyhhbXxwbXxhezF9KScKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuICcnCiAgICAgIH0KICAgIH0sCgogICAgaXNFbXB0eVZhbHVlICh0YXJnZXRUb2tlbiwgdGVzdFZhbHVlKSB7CiAgICAgIHJldHVybiAoIXRlc3RWYWx1ZSB8fCAhdGVzdFZhbHVlLmxlbmd0aCkgfHwgKHRlc3RWYWx1ZSAmJiB0ZXN0VmFsdWUgPT09IHRhcmdldFRva2VuKQogICAgfSwKCiAgICBpc1ZhbGlkVmFsdWUgKHRhcmdldFRva2VuLCB0ZXN0VmFsdWUpIHsKICAgICAgaWYgKCF0YXJnZXRUb2tlbiB8fCB0aGlzLmlzRW1wdHlWYWx1ZSh0YXJnZXRUb2tlbiwgdGVzdFZhbHVlKSkgeyByZXR1cm4gZmFsc2UgfQogICAgICBjb25zdCB0b2tlblJlZ2V4U3RyID0gdGhpcy5nZXRUb2tlblJlZ2V4KHRhcmdldFRva2VuKQogICAgICBpZiAoIXRva2VuUmVnZXhTdHIgfHwgIXRva2VuUmVnZXhTdHIubGVuZ3RoKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIHJldHVybiAobmV3IFJlZ0V4cChgXiR7dG9rZW5SZWdleFN0cn0kYCkpLnRlc3QodGVzdFZhbHVlKQogICAgfSwKCiAgICBzYW5pdGl6ZWRWYWx1ZSAodGFyZ2V0VG9rZW4sIGlucHV0VmFsdWUpIHsKICAgICAgaWYgKHRoaXMuaXNWYWxpZFZhbHVlKHRhcmdldFRva2VuLCBpbnB1dFZhbHVlKSkgewogICAgICAgIHJldHVybiBpbnB1dFZhbHVlCiAgICAgIH0KICAgICAgcmV0dXJuICcnCiAgICB9LAoKICAgIGdldFRva2VuVHlwZSAodG9rZW4pIHsKICAgICAgcmV0dXJuIHRoaXMuaW5Vc2UudHlwZXNbdGhpcy5pblVzZS50b2tlbnMuaW5kZXhPZih0b2tlbildIHx8ICcnCiAgICB9LAoKICAgIGdldFRva2VuQnlUeXBlICh0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzW2Ake3R5cGV9VHlwZWBdIHx8ICcnCiAgICB9LAoKICAgIGlzTWludXRlT3JTZWNvbmQgKHR5cGUpIHsKICAgICAgcmV0dXJuIFsnbWludXRlJywgJ3NlY29uZCddLmluY2x1ZGVzKHR5cGUpCiAgICB9LAoKICAgIGRlYnVnTG9nIChsb2dUZXh0KSB7CiAgICAgIGlmICghbG9nVGV4dCB8fCAhbG9nVGV4dC5sZW5ndGgpIHsgcmV0dXJuIH0KICAgICAgbGV0IGlkZW50aWZpZXIgPSAnJwogICAgICBpZiAodGhpcy5pZCkgewogICAgICAgIGlkZW50aWZpZXIgKz0gYCMke3RoaXMuaWR9YAogICAgICB9CiAgICAgIGlmICh0aGlzLm5hbWUpIHsKICAgICAgICBpZGVudGlmaWVyICs9IGBbbmFtZT0ke3RoaXMubmFtZX1dYAogICAgICB9CiAgICAgIGlmICh0aGlzLmlucHV0Q2xhc3MpIHsKICAgICAgICBsZXQgaW5wdXRDbGFzc2VzID0gW10KICAgICAgICBpZiAodHlwZW9mIHRoaXMuaW5wdXRDbGFzcyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlucHV0Q2xhc3NlcyA9IHRoaXMuaW5wdXRDbGFzcy5zcGxpdCgvXHMvZykKICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5pbnB1dENsYXNzKSkgewogICAgICAgICAgaW5wdXRDbGFzc2VzID0gW10uY29uY2F0KFtdLCB0aGlzLmlucHV0Q2xhc3MpCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5pbnB1dENsYXNzID09PSAnb2JqZWN0JykgewogICAgICAgICAgT2JqZWN0LmtleXModGhpcy5pbnB1dENsYXNzKS5mb3JFYWNoKGNsc05hbWUgPT4gewogICAgICAgICAgICBpZiAodGhpcy5pbnB1dENsYXNzW2Nsc05hbWVdKSB7CiAgICAgICAgICAgICAgaW5wdXRDbGFzc2VzLnB1c2goY2xzTmFtZSkKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaW5wdXRDbGFzcyBvZiBpbnB1dENsYXNzZXMpIHsKICAgICAgICAgIGlmIChpbnB1dENsYXNzICYmIGlucHV0Q2xhc3MudHJpbSgpLmxlbmd0aCkgewogICAgICAgICAgICBpZGVudGlmaWVyICs9IGAuJHtpbnB1dENsYXNzLnRyaW0oKX1gCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGZpbmFsTG9nVGV4dCA9IGBERUJVRzogJHtsb2dUZXh0fSR7aWRlbnRpZmllciA/IGBcblx0KCR7aWRlbnRpZmllcn0pYCA6ICcnIH1gCiAgICAgIGlmICh3aW5kb3cuY29uc29sZS5kZWJ1ZyAmJiB0eXBlb2Ygd2luZG93LmNvbnNvbGUuZGVidWcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS5kZWJ1ZyhmaW5hbExvZ1RleHQpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGZpbmFsTG9nVGV4dCkKICAgICAgfQogICAgfQogIH0sCgogIG1vdW50ZWQgKCkgewogICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlYm91bmNlVGltZXIpCiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpCiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMua2JJbnB1dFRpbWVyKQogICAgdGhpcy5yZW5kZXJGb3JtYXQoKQogIH0sCgogIGJlZm9yZURlc3Ryb3kgKCkgewogICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlYm91bmNlVGltZXIpCiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpCiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMua2JJbnB1dFRpbWVyKQogIH0KfQo="},null]}