{"remainingRequest":"/home/artur/programowanie/organiser/node_modules/babel-loader/lib/index.js!/home/artur/programowanie/organiser/node_modules/cache-loader/dist/cjs.js??ref--0-0!/home/artur/programowanie/organiser/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/artur/programowanie/organiser/node_modules/vue2-timepicker/src/vue-timepicker.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/artur/programowanie/organiser/node_modules/vue2-timepicker/src/vue-timepicker.vue","mtime":1638016037242},{"path":"/home/artur/programowanie/organiser/node_modules/cache-loader/dist/cjs.js","mtime":1638016032464},{"path":"/home/artur/programowanie/organiser/node_modules/babel-loader/lib/index.js","mtime":1638016034515},{"path":"/home/artur/programowanie/organiser/node_modules/cache-loader/dist/cjs.js","mtime":1638016032464},{"path":"/home/artur/programowanie/organiser/node_modules/vue-loader/lib/index.js","mtime":1638016035031}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Y29uc3QgQ09ORklHID0gewogIEhPVVJfVE9LRU5TOiBbJ0hIJywgJ0gnLCAnaGgnLCAnaCcsICdraycsICdrJ10sCiAgTUlOVVRFX1RPS0VOUzogWydtbScsICdtJ10sCiAgU0VDT05EX1RPS0VOUzogWydzcycsICdzJ10sCiAgQVBNX1RPS0VOUzogWydBJywgJ2EnXSwKICBCQVNJQ19UWVBFUzogWydob3VyJywgJ21pbnV0ZScsICdzZWNvbmQnLCAnYXBtJ10KfTsKY29uc3QgREVGQVVMVF9PUFRJT05TID0gewogIGZvcm1hdDogJ0hIOm1tJywKICBtaW51dGVJbnRlcnZhbDogMSwKICBzZWNvbmRJbnRlcnZhbDogMSwKICBob3VyUmFuZ2U6IG51bGwsCiAgbWludXRlUmFuZ2U6IG51bGwsCiAgc2Vjb25kUmFuZ2U6IG51bGwsCiAgaGlkZURpc2FibGVkSG91cnM6IGZhbHNlLAogIGhpZGVEaXNhYmxlZE1pbnV0ZXM6IGZhbHNlLAogIGhpZGVEaXNhYmxlZFNlY29uZHM6IGZhbHNlLAogIGhpZGVEaXNhYmxlZEl0ZW1zOiBmYWxzZSwKICBoaWRlRHJvcGRvd246IGZhbHNlLAogIGJsdXJEZWxheTogMzAwLAogIG1hbnVhbElucHV0VGltZW91dDogMTAwMCwKICBkcm9wT2Zmc2V0SGVpZ2h0OiAxNjAKfTsKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICdWdWVUaW1lcGlja2VyJywKICBwcm9wczogewogICAgdmFsdWU6IHsKICAgICAgdHlwZTogW09iamVjdCwgU3RyaW5nXQogICAgfSwKICAgIGZvcm1hdDogewogICAgICB0eXBlOiBTdHJpbmcKICAgIH0sCiAgICBtaW51dGVJbnRlcnZhbDogewogICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddCiAgICB9LAogICAgc2Vjb25kSW50ZXJ2YWw6IHsKICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXQogICAgfSwKICAgIGhvdXJSYW5nZTogewogICAgICB0eXBlOiBBcnJheQogICAgfSwKICAgIG1pbnV0ZVJhbmdlOiB7CiAgICAgIHR5cGU6IEFycmF5CiAgICB9LAogICAgc2Vjb25kUmFuZ2U6IHsKICAgICAgdHlwZTogQXJyYXkKICAgIH0sCiAgICBoaWRlRGlzYWJsZWRIb3VyczogewogICAgICB0eXBlOiBCb29sZWFuLAogICAgICBkZWZhdWx0OiBmYWxzZQogICAgfSwKICAgIGhpZGVEaXNhYmxlZE1pbnV0ZXM6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0sCiAgICBoaWRlRGlzYWJsZWRTZWNvbmRzOiB7CiAgICAgIHR5cGU6IEJvb2xlYW4sCiAgICAgIGRlZmF1bHQ6IGZhbHNlCiAgICB9LAogICAgaGlkZURpc2FibGVkSXRlbXM6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0sCiAgICBoaWRlQ2xlYXJCdXR0b246IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0sCiAgICBkaXNhYmxlZDogewogICAgICB0eXBlOiBCb29sZWFuLAogICAgICBkZWZhdWx0OiBmYWxzZQogICAgfSwKICAgIGNsb3NlT25Db21wbGV0ZTogewogICAgICB0eXBlOiBCb29sZWFuLAogICAgICBkZWZhdWx0OiBmYWxzZQogICAgfSwKICAgIGlkOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIG5hbWU6IHsKICAgICAgdHlwZTogU3RyaW5nCiAgICB9LAogICAgaW5wdXRDbGFzczogewogICAgICB0eXBlOiBbU3RyaW5nLCBPYmplY3QsIEFycmF5XQogICAgfSwKICAgIHBsYWNlaG9sZGVyOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIHRhYmluZGV4OiB7CiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sCiAgICAgIGRlZmF1bHQ6IDAKICAgIH0sCiAgICBpbnB1dFdpZHRoOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIGF1dG9jb21wbGV0ZTogewogICAgICB0eXBlOiBTdHJpbmcsCiAgICAgIGRlZmF1bHQ6ICdvZmYnCiAgICB9LAogICAgaG91ckxhYmVsOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIG1pbnV0ZUxhYmVsOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIHNlY29uZExhYmVsOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIGFwbUxhYmVsOiB7CiAgICAgIHR5cGU6IFN0cmluZwogICAgfSwKICAgIGFtVGV4dDogewogICAgICB0eXBlOiBTdHJpbmcKICAgIH0sCiAgICBwbVRleHQ6IHsKICAgICAgdHlwZTogU3RyaW5nCiAgICB9LAogICAgYmx1ckRlbGF5OiB7CiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10KICAgIH0sCiAgICBhZHZhbmNlZEtleWJvYXJkOiB7CiAgICAgIHR5cGU6IEJvb2xlYW4sCiAgICAgIGRlZmF1bHQ6IGZhbHNlCiAgICB9LAogICAgbGF6eTogewogICAgICB0eXBlOiBCb29sZWFuLAogICAgICBkZWZhdWx0OiBmYWxzZQogICAgfSwKICAgIGF1dG9TY3JvbGw6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0sCiAgICBkcm9wRGlyZWN0aW9uOiB7CiAgICAgIHR5cGU6IFN0cmluZywKICAgICAgZGVmYXVsdDogJ2Rvd24nCiAgICB9LAogICAgZHJvcE9mZnNldEhlaWdodDogewogICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddCiAgICB9LAogICAgY29udGFpbmVySWQ6IHsKICAgICAgdHlwZTogU3RyaW5nCiAgICB9LAogICAgYXBwZW5kVG9Cb2R5OiB7CiAgICAgIHR5cGU6IEJvb2xlYW4sCiAgICAgIGRlZmF1bHQ6IGZhbHNlCiAgICB9LAogICAgbWFudWFsSW5wdXQ6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0sCiAgICBtYW51YWxJbnB1dFRpbWVvdXQ6IHsKICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXQogICAgfSwKICAgIGhpZGVEcm9wZG93bjogewogICAgICB0eXBlOiBCb29sZWFuLAogICAgICBkZWZhdWx0OiBmYWxzZQogICAgfSwKICAgIGZpeGVkRHJvcGRvd25CdXR0b246IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0sCiAgICBkZWJ1Z01vZGU6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UKICAgIH0KICB9LAoKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgdGltZVZhbHVlOiB7fSwKICAgICAgaG91cnM6IFtdLAogICAgICBtaW51dGVzOiBbXSwKICAgICAgc2Vjb25kczogW10sCiAgICAgIGFwbXM6IFtdLAogICAgICBpc0FjdGl2ZTogZmFsc2UsCiAgICAgIHNob3dEcm9wZG93bjogZmFsc2UsCiAgICAgIGlzRm9jdXNpbmc6IGZhbHNlLAogICAgICBkZWJvdW5jZVRpbWVyOiB1bmRlZmluZWQsCiAgICAgIGhvdXJUeXBlOiAnSEgnLAogICAgICBtaW51dGVUeXBlOiAnbW0nLAogICAgICBzZWNvbmRUeXBlOiAnJywKICAgICAgYXBtVHlwZTogJycsCiAgICAgIGhvdXI6ICcnLAogICAgICBtaW51dGU6ICcnLAogICAgICBzZWNvbmQ6ICcnLAogICAgICBhcG06ICcnLAogICAgICBmdWxsVmFsdWVzOiB1bmRlZmluZWQsCiAgICAgIGJha0Rpc3BsYXlUaW1lOiB1bmRlZmluZWQsCiAgICAgIGRvQ2xlYXJBcG1DaGVja2luZzogZmFsc2UsCiAgICAgIHNlbGVjdGlvblRpbWVyOiB1bmRlZmluZWQsCiAgICAgIGtiSW5wdXRUaW1lcjogdW5kZWZpbmVkLAogICAgICBrYklucHV0TG9nOiAnJywKICAgICAgYmFrQ3VycmVudFBvczogdW5kZWZpbmVkLAogICAgICBmb3JjZURyb3BPblRvcDogZmFsc2UKICAgIH07CiAgfSwKCiAgY29tcHV0ZWQ6IHsKICAgIG9wdHMoKSB7CiAgICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX09QVElPTlMpOwoKICAgICAgaWYgKHRoaXMuZm9ybWF0ICYmIHRoaXMuZm9ybWF0Lmxlbmd0aCkgewogICAgICAgIG9wdGlvbnMuZm9ybWF0ID0gU3RyaW5nKHRoaXMuZm9ybWF0KTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaXNOdW1iZXIodGhpcy5taW51dGVJbnRlcnZhbCkpIHsKICAgICAgICBvcHRpb25zLm1pbnV0ZUludGVydmFsID0gK3RoaXMubWludXRlSW50ZXJ2YWw7CiAgICAgIH0gLy8gbWludXRlSW50ZXJ2YWwgZmFpbHNhZmUKCgogICAgICBpZiAoIW9wdGlvbnMubWludXRlSW50ZXJ2YWwgfHwgb3B0aW9ucy5taW51dGVJbnRlcnZhbCA8IDEgfHwgb3B0aW9ucy5taW51dGVJbnRlcnZhbCA+IDYwKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5taW51dGVJbnRlcnZhbCA+IDYwKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYCJtaW51dGUtaW50ZXJ2YWwiIHNob3VsZCBiZSBsZXNzIHRoYW4gNjAuIEN1cnJlbnQgdmFsdWUgaXMgJHt0aGlzLm1pbnV0ZUludGVydmFsfWApOwogICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLm1pbnV0ZUludGVydmFsID09PSAwIHx8IG9wdGlvbnMubWludXRlSW50ZXJ2YWwgPCAxKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYCJtaW51dGUtaW50ZXJ2YWwiIHNob3VsZCBiZSBOTyBsZXNzIHRoYW4gMS4gQ3VycmVudCB2YWx1ZSBpcyAke3RoaXMubWludXRlSW50ZXJ2YWx9YCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5taW51dGVJbnRlcnZhbCA9PT0gMCkgewogICAgICAgICAgb3B0aW9ucy5taW51dGVJbnRlcnZhbCA9IDYwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcHRpb25zLm1pbnV0ZUludGVydmFsID0gMTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmlzTnVtYmVyKHRoaXMuc2Vjb25kSW50ZXJ2YWwpKSB7CiAgICAgICAgb3B0aW9ucy5zZWNvbmRJbnRlcnZhbCA9ICt0aGlzLnNlY29uZEludGVydmFsOwogICAgICB9IC8vIHNlY29uZEludGVydmFsIGZhaWxzYWZlCgoKICAgICAgaWYgKCFvcHRpb25zLnNlY29uZEludGVydmFsIHx8IG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPCAxIHx8IG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPiA2MCkgewogICAgICAgIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgaWYgKG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPiA2MCkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKGAic2Vjb25kLWludGVydmFsIiBzaG91bGQgYmUgbGVzcyB0aGFuIDYwLiBDdXJyZW50IHZhbHVlIGlzICR7dGhpcy5zZWNvbmRJbnRlcnZhbH1gKTsKICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5zZWNvbmRJbnRlcnZhbCA9PT0gMCB8fCBvcHRpb25zLnNlY29uZEludGVydmFsIDwgMSkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKGAic2Vjb25kLWludGVydmFsIiBzaG91bGQgYmUgTk8gbGVzcyB0aGFuIDEuIEN1cnJlbnQgdmFsdWUgaXMgJHt0aGlzLnNlY29uZEludGVydmFsfWApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPT09IDApIHsKICAgICAgICAgIG9wdGlvbnMuc2Vjb25kSW50ZXJ2YWwgPSA2MDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9ucy5zZWNvbmRJbnRlcnZhbCA9IDE7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5ob3VyUmFuZ2UgJiYgQXJyYXkuaXNBcnJheSh0aGlzLmhvdXJSYW5nZSkpIHsKICAgICAgICBvcHRpb25zLmhvdXJSYW5nZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5ob3VyUmFuZ2UpKTsKCiAgICAgICAgaWYgKCF0aGlzLmhvdXJSYW5nZS5sZW5ndGggJiYgdGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coJ1RoZSAiaG91ci1yYW5nZSIgYXJyYXkgaXMgZW1wdHkgKGxlbmd0aCA9PT0gMCknKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm1pbnV0ZVJhbmdlICYmIEFycmF5LmlzQXJyYXkodGhpcy5taW51dGVSYW5nZSkpIHsKICAgICAgICBvcHRpb25zLm1pbnV0ZVJhbmdlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLm1pbnV0ZVJhbmdlKSk7CgogICAgICAgIGlmICghdGhpcy5taW51dGVSYW5nZS5sZW5ndGggJiYgdGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coJ1RoZSAibWludXRlLXJhbmdlIiBhcnJheSBpcyBlbXB0eSAobGVuZ3RoID09PSAwKScpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuc2Vjb25kUmFuZ2UgJiYgQXJyYXkuaXNBcnJheSh0aGlzLnNlY29uZFJhbmdlKSkgewogICAgICAgIG9wdGlvbnMuc2Vjb25kUmFuZ2UgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuc2Vjb25kUmFuZ2UpKTsKCiAgICAgICAgaWYgKCF0aGlzLnNlY29uZFJhbmdlLmxlbmd0aCAmJiB0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZygnVGhlICJzZWNvbmQtcmFuZ2UiIGFycmF5IGlzIGVtcHR5IChsZW5ndGggPT09IDApJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5oaWRlRGlzYWJsZWRJdGVtcykgewogICAgICAgIG9wdGlvbnMuaGlkZURpc2FibGVkSXRlbXMgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAodGhpcy5oaWRlRGlzYWJsZWRIb3VycyB8fCB0aGlzLmhpZGVEaXNhYmxlZEl0ZW1zKSB7CiAgICAgICAgb3B0aW9ucy5oaWRlRGlzYWJsZWRIb3VycyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmhpZGVEaXNhYmxlZE1pbnV0ZXMgfHwgdGhpcy5oaWRlRGlzYWJsZWRJdGVtcykgewogICAgICAgIG9wdGlvbnMuaGlkZURpc2FibGVkTWludXRlcyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmhpZGVEaXNhYmxlZFNlY29uZHMgfHwgdGhpcy5oaWRlRGlzYWJsZWRJdGVtcykgewogICAgICAgIG9wdGlvbnMuaGlkZURpc2FibGVkU2Vjb25kcyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmhpZGVEcm9wZG93bikgewogICAgICAgIGlmICh0aGlzLm1hbnVhbElucHV0KSB7CiAgICAgICAgICBvcHRpb25zLmhpZGVEcm9wZG93biA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZygnImhpZGUtZHJvcGRvd24iIG9ubHkgd29ya3Mgd2l0aCAibWFudWFsLWlucHV0IiBtb2RlJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5ibHVyRGVsYXkgJiYgK3RoaXMuYmx1ckRlbGF5ID4gMCkgewogICAgICAgIG9wdGlvbnMuYmx1ckRlbGF5ID0gK3RoaXMuYmx1ckRlbGF5OwogICAgICB9CgogICAgICBpZiAodGhpcy5tYW51YWxJbnB1dFRpbWVvdXQgJiYgK3RoaXMubWFudWFsSW5wdXRUaW1lb3V0ID4gMCkgewogICAgICAgIG9wdGlvbnMubWFudWFsSW5wdXRUaW1lb3V0ID0gK3RoaXMubWFudWFsSW5wdXRUaW1lb3V0OwogICAgICB9CgogICAgICBpZiAodGhpcy5kcm9wT2Zmc2V0SGVpZ2h0ICYmICt0aGlzLmRyb3BPZmZzZXRIZWlnaHQgPiAwKSB7CiAgICAgICAgb3B0aW9ucy5kcm9wT2Zmc2V0SGVpZ2h0ID0gK3RoaXMuZHJvcE9mZnNldEhlaWdodDsKICAgICAgfQoKICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9LAoKICAgIHVzZVN0cmluZ1ZhbHVlKCkgewogICAgICByZXR1cm4gdHlwZW9mIHRoaXMudmFsdWUgPT09ICdzdHJpbmcnOwogICAgfSwKCiAgICBmb3JtYXRTdHJpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLm9wdHMuZm9ybWF0IHx8IERFRkFVTFRfT1BUSU9OUy5mb3JtYXQ7CiAgICB9LAoKICAgIGluVXNlKCkgewogICAgICBjb25zdCB0eXBlc0luVXNlID0gQ09ORklHLkJBU0lDX1RZUEVTLmZpbHRlcih0eXBlID0+IHRoaXMuZ2V0VG9rZW5CeVR5cGUodHlwZSkpOyAvLyBTb3J0IHR5cGVzIGFuZCB0b2tlbnMgYnkgdGhlaXIgc2VxdWVuY2UgaW4gdGhlICJmb3JtYXQiIHN0cmluZwoKICAgICAgdHlwZXNJblVzZS5zb3J0KChsLCByKSA9PiB7CiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0U3RyaW5nLmluZGV4T2YodGhpcy5nZXRUb2tlbkJ5VHlwZShsKSB8fCBudWxsKSAtIHRoaXMuZm9ybWF0U3RyaW5nLmluZGV4T2YodGhpcy5nZXRUb2tlbkJ5VHlwZShyKSB8fCBudWxsKTsKICAgICAgfSk7CiAgICAgIGNvbnN0IHRva2Vuc0luVXNlID0gdHlwZXNJblVzZS5tYXAodHlwZSA9PiB0aGlzLmdldFRva2VuQnlUeXBlKHR5cGUpKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBob3VyOiAhIXRoaXMuaG91clR5cGUsCiAgICAgICAgbWludXRlOiAhIXRoaXMubWludXRlVHlwZSwKICAgICAgICBzZWNvbmQ6ICEhdGhpcy5zZWNvbmRUeXBlLAogICAgICAgIGFwbTogISF0aGlzLmFwbVR5cGUsCiAgICAgICAgdHlwZXM6IHR5cGVzSW5Vc2UgfHwgW10sCiAgICAgICAgdG9rZW5zOiB0b2tlbnNJblVzZSB8fCBbXQogICAgICB9OwogICAgfSwKCiAgICBkaXNwbGF5VGltZSgpIHsKICAgICAgbGV0IGZvcm1hdFN0cmluZyA9IFN0cmluZyh0aGlzLmZvcm1hdFN0cmluZyk7CgogICAgICBpZiAodGhpcy5ob3VyKSB7CiAgICAgICAgZm9ybWF0U3RyaW5nID0gZm9ybWF0U3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cCh0aGlzLmhvdXJUeXBlLCAnZycpLCB0aGlzLmhvdXIpOwogICAgICB9CgogICAgICBpZiAodGhpcy5taW51dGUpIHsKICAgICAgICBmb3JtYXRTdHJpbmcgPSBmb3JtYXRTdHJpbmcucmVwbGFjZShuZXcgUmVnRXhwKHRoaXMubWludXRlVHlwZSwgJ2cnKSwgdGhpcy5taW51dGUpOwogICAgICB9CgogICAgICBpZiAodGhpcy5zZWNvbmQgJiYgdGhpcy5zZWNvbmRUeXBlKSB7CiAgICAgICAgZm9ybWF0U3RyaW5nID0gZm9ybWF0U3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cCh0aGlzLnNlY29uZFR5cGUsICdnJyksIHRoaXMuc2Vjb25kKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuYXBtICYmIHRoaXMuYXBtVHlwZSkgewogICAgICAgIGZvcm1hdFN0cmluZyA9IGZvcm1hdFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5hcG1UeXBlLCAnZycpLCB0aGlzLmFwbSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmb3JtYXRTdHJpbmc7CiAgICB9LAoKICAgIGN1c3RvbURpc3BsYXlUaW1lKCkgewogICAgICBpZiAoIXRoaXMuYW1UZXh0ICYmICF0aGlzLnBtVGV4dCkgewogICAgICAgIHJldHVybiB0aGlzLmRpc3BsYXlUaW1lOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5kaXNwbGF5VGltZS5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5hcG0sICdnJyksIHRoaXMuYXBtRGlzcGxheVRleHQodGhpcy5hcG0pKTsKICAgIH0sCgogICAgaW5wdXRJc0VtcHR5KCkgewogICAgICByZXR1cm4gdGhpcy5mb3JtYXRTdHJpbmcgPT09IHRoaXMuZGlzcGxheVRpbWU7CiAgICB9LAoKICAgIGFsbFZhbHVlU2VsZWN0ZWQoKSB7CiAgICAgIGlmICh0aGlzLmluVXNlLmhvdXIgJiYgIXRoaXMuaG91ciB8fCB0aGlzLmluVXNlLm1pbnV0ZSAmJiAhdGhpcy5taW51dGUgfHwgdGhpcy5pblVzZS5zZWNvbmQgJiYgIXRoaXMuc2Vjb25kIHx8IHRoaXMuaW5Vc2UuYXBtICYmICF0aGlzLmFwbSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIGNvbHVtbnNTZXF1ZW5jZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuaW5Vc2UudHlwZXMubWFwKHR5cGUgPT4gdHlwZSkgfHwgW107CiAgICB9LAoKICAgIHNob3dDbGVhckJ0bigpIHsKICAgICAgaWYgKHRoaXMuaGlkZUNsZWFyQnV0dG9uIHx8IHRoaXMuZGlzYWJsZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiAhdGhpcy5pbnB1dElzRW1wdHk7CiAgICB9LAoKICAgIHNob3dEcm9wZG93bkJ0bigpIHsKICAgICAgaWYgKHRoaXMuZml4ZWREcm9wZG93bkJ1dHRvbikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRzLmhpZGVEcm9wZG93biAmJiB0aGlzLmlzQWN0aXZlICYmICF0aGlzLnNob3dEcm9wZG93bikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIGJhc2VPbjEySG91cnMoKSB7CiAgICAgIHJldHVybiB0aGlzLmhvdXJUeXBlID09PSAnaCcgfHwgdGhpcy5ob3VyVHlwZSA9PT0gJ2hoJzsKICAgIH0sCgogICAgaG91clJhbmdlSW4yNEhyRm9ybWF0KCkgewogICAgICBpZiAoIXRoaXMuaG91clR5cGUgfHwgIXRoaXMub3B0cy5ob3VyUmFuZ2UpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRzLmhvdXJSYW5nZS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KCiAgICAgIGNvbnN0IHJhbmdlID0gW107CiAgICAgIHRoaXMub3B0cy5ob3VyUmFuZ2UuZm9yRWFjaCh2YWx1ZSA9PiB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAyICYmIHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYE5lc3RlZCBhcnJheSB3aXRoaW4gImhvdXItcmFuZ2UiIG11c3QgY29udGFpbiBubyBtb3JlIHRoYW4gdHdvIGl0ZW1zLiBPbmx5IHRoZSBmaXJzdCB0d28gaXRlbXMgb2YgJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9IHdpbGwgYmUgdGFrZW4gaW50byBhY2NvdW50LmApOwogICAgICAgICAgfQoKICAgICAgICAgIGxldCBzdGFydCA9IHZhbHVlWzBdOwogICAgICAgICAgbGV0IGVuZCA9IHZhbHVlWzFdIHx8IHZhbHVlWzBdOwoKICAgICAgICAgIGlmICh0aGlzLmlzMTJoUmFuZ2Uoc3RhcnQpKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy50cmFuc2xhdGUxMmhSYW5nZShzdGFydCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRoaXMuaXMxMmhSYW5nZShlbmQpKSB7CiAgICAgICAgICAgIGVuZCA9IHRoaXMudHJhbnNsYXRlMTJoUmFuZ2UoZW5kKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmb3IgKGxldCBpID0gK3N0YXJ0OyBpIDw9ICtlbmQ7IGkrKykgewogICAgICAgICAgICBpZiAoaSA8IDAgfHwgaSA+IDI0KSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghcmFuZ2UuaW5jbHVkZXMoaSkpIHsKICAgICAgICAgICAgICByYW5nZS5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLmlzMTJoUmFuZ2UodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gdGhpcy50cmFuc2xhdGUxMmhSYW5nZSh2YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodmFsdWUgPCAwIHx8IHZhbHVlID4gMjQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghcmFuZ2UuaW5jbHVkZXModmFsdWUpKSB7CiAgICAgICAgICAgIHJhbmdlLnB1c2godmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJhbmdlLnNvcnQoKGwsIHIpID0+IHsKICAgICAgICByZXR1cm4gbCAtIHI7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmFuZ2U7CiAgICB9LAoKICAgIHJlc3RyaWN0ZWRIb3VyUmFuZ2UoKSB7CiAgICAgIC8vIE5vIHJlc3RyaWN0aW9uCiAgICAgIGlmICghdGhpcy5ob3VyUmFuZ2VJbjI0SHJGb3JtYXQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gMTItSG91cgoKCiAgICAgIGlmICh0aGlzLmJhc2VPbjEySG91cnMpIHsKICAgICAgICBjb25zdCByYW5nZSA9IHRoaXMuaG91clJhbmdlSW4yNEhyRm9ybWF0Lm1hcCh2YWx1ZSA9PiB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IDEyKSB7CiAgICAgICAgICAgIHJldHVybiAnMTJwJzsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IDI0IHx8IHZhbHVlID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAnMTJhJzsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdmFsdWUgPiAxMiA/IGAke3ZhbHVlICUgMTJ9cGAgOiBgJHt2YWx1ZX1hYDsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmFuZ2U7CiAgICAgIH0gLy8gMjQtSG91cgoKCiAgICAgIHJldHVybiB0aGlzLmhvdXJSYW5nZUluMjRIckZvcm1hdDsKICAgIH0sCgogICAgdmFsaWRIb3Vyc0xpc3QoKSB7CiAgICAgIGlmICghdGhpcy5tYW51YWxJbnB1dCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZSkgewogICAgICAgIGxldCBsaXN0ID0gW107CgogICAgICAgIGlmICh0aGlzLmJhc2VPbjEySG91cnMpIHsKICAgICAgICAgIGxpc3QgPSB0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UubWFwKGhyID0+IHsKICAgICAgICAgICAgY29uc3QgbCA9IGhyLnN1YnN0cigwLCBoci5sZW5ndGggLSAxKTsKICAgICAgICAgICAgY29uc3QgciA9IGhyLnN1YnN0cigtMSk7CiAgICAgICAgICAgIHJldHVybiBgJHt0aGlzLmZvcm1hdFZhbHVlKHRoaXMuaG91clR5cGUsIGwpfSR7cn1gOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBhbTEySW5kZXggPSBsaXN0LmluZGV4T2YoJzEyYScpOwoKICAgICAgICAgIGlmIChhbTEySW5kZXggPiAwKSB7CiAgICAgICAgICAgIC8vIE1ha2UgJzEyYScgdGhlIGZpcnN0IGl0ZW0gaW4gaC9oaAogICAgICAgICAgICBsaXN0LnVuc2hpZnQobGlzdC5zcGxpY2UoYW0xMkluZGV4LCAxKVswXSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgICAgfQoKICAgICAgICBsaXN0ID0gdGhpcy5yZXN0cmljdGVkSG91clJhbmdlLm1hcChociA9PiB7CiAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRWYWx1ZSh0aGlzLmhvdXJUeXBlLCBocik7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChsaXN0Lmxlbmd0aCA+IDEgJiYgbGlzdFswXSAmJiBsaXN0WzBdID09PSAnMjQnKSB7CiAgICAgICAgICAvLyBNYWtlICcyNCcgdGhlIGxhc3QgaXRlbSBpbiBrL2trCiAgICAgICAgICBsaXN0LnB1c2gobGlzdC5zaGlmdCgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsaXN0OwogICAgICB9CgogICAgICBpZiAodGhpcy5iYXNlT24xMkhvdXJzKSB7CiAgICAgICAgcmV0dXJuIFtdLmNvbmNhdChbXSwgdGhpcy5ob3Vycy5tYXAoaHIgPT4gYCR7aHJ9YWApLCB0aGlzLmhvdXJzLm1hcChociA9PiBgJHtocn1wYCkpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5ob3VyczsKICAgIH0sCgogICAgaGFzKCkgewogICAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgICAgY3VzdG9tQXBtVGV4dDogZmFsc2UKICAgICAgfTsKICAgICAgY29uc3QgYXBtRW5hYmxlZCA9ICEhdGhpcy5hcG1UeXBlOwoKICAgICAgaWYgKGFwbUVuYWJsZWQgJiYgdGhpcy5ob3VyUmFuZ2VJbjI0SHJGb3JtYXQgJiYgdGhpcy5ob3VyUmFuZ2VJbjI0SHJGb3JtYXQubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgcmFuZ2UgPSBbXS5jb25jYXQoW10sIHRoaXMuaG91clJhbmdlSW4yNEhyRm9ybWF0KTsKICAgICAgICByZXN1bHQuYW0gPSByYW5nZS5zb21lKHZhbHVlID0+IHZhbHVlIDwgMTIgfHwgdmFsdWUgPT09IDI0KTsKICAgICAgICByZXN1bHQucG0gPSByYW5nZS5zb21lKHZhbHVlID0+IHZhbHVlID49IDEyICYmIHZhbHVlIDwgMjQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5hbSA9IGFwbUVuYWJsZWQ7CiAgICAgICAgcmVzdWx0LnBtID0gYXBtRW5hYmxlZDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuYW1UZXh0ICYmIHRoaXMuYW1UZXh0Lmxlbmd0aCB8fCB0aGlzLnBtVGV4dCAmJiB0aGlzLnBtVGV4dC5sZW5ndGgpIHsKICAgICAgICByZXN1bHQuY3VzdG9tQXBtVGV4dCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIG1pbnV0ZVJhbmdlTGlzdCgpIHsKICAgICAgaWYgKCF0aGlzLm1pbnV0ZVR5cGUgfHwgIXRoaXMub3B0cy5taW51dGVSYW5nZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLm9wdHMubWludXRlUmFuZ2UubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5yZW5kZXJSYW5nZUxpc3QodGhpcy5vcHRzLm1pbnV0ZVJhbmdlLCAnbWludXRlJyk7CiAgICB9LAoKICAgIHNlY29uZFJhbmdlTGlzdCgpIHsKICAgICAgaWYgKCF0aGlzLnNlY29uZFR5cGUgfHwgIXRoaXMub3B0cy5zZWNvbmRSYW5nZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLm9wdHMuc2Vjb25kUmFuZ2UubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5yZW5kZXJSYW5nZUxpc3QodGhpcy5vcHRzLnNlY29uZFJhbmdlLCAnc2Vjb25kJyk7CiAgICB9LAoKICAgIGhvdXJMYWJlbFRleHQoKSB7CiAgICAgIHJldHVybiB0aGlzLmhvdXJMYWJlbCB8fCB0aGlzLmhvdXJUeXBlOwogICAgfSwKCiAgICBtaW51dGVMYWJlbFRleHQoKSB7CiAgICAgIHJldHVybiB0aGlzLm1pbnV0ZUxhYmVsIHx8IHRoaXMubWludXRlVHlwZTsKICAgIH0sCgogICAgc2Vjb25kTGFiZWxUZXh0KCkgewogICAgICByZXR1cm4gdGhpcy5zZWNvbmRMYWJlbCB8fCB0aGlzLnNlY29uZFR5cGU7CiAgICB9LAoKICAgIGFwbUxhYmVsVGV4dCgpIHsKICAgICAgcmV0dXJuIHRoaXMuYXBtTGFiZWwgfHwgdGhpcy5hcG1UeXBlOwogICAgfSwKCiAgICBpbnB1dFdpZHRoU3R5bGUoKSB7CiAgICAgIGlmICghdGhpcy5pbnB1dFdpZHRoIHx8ICF0aGlzLmlucHV0V2lkdGgubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiB0aGlzLmlucHV0V2lkdGgKICAgICAgfTsKICAgIH0sCgogICAgdG9rZW5SZWdleEJhc2UoKSB7CiAgICAgIHJldHVybiB0aGlzLmluVXNlLnRva2Vucy5qb2luKCd8Jyk7CiAgICB9LAoKICAgIHRva2VuQ2h1bmtzKCkgewogICAgICBpZiAoIXRoaXMubWFudWFsSW5wdXQgJiYgIXRoaXMudXNlU3RyaW5nVmFsdWUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGNvbnN0IGZvcm1hdFN0cmluZyA9IFN0cmluZyh0aGlzLmZvcm1hdFN0cmluZyk7CiAgICAgIGNvbnN0IHRva2Vuc1JlZ3hTdHIgPSBgKCR7dGhpcy50b2tlblJlZ2V4QmFzZX0pKz9gOwogICAgICBjb25zdCB0b2tlbnNNYXRjaEFsbCA9IHRoaXMuZ2V0TWF0Y2hBbGxCeVJlZ2V4KGZvcm1hdFN0cmluZywgdG9rZW5zUmVneFN0cik7CiAgICAgIGNvbnN0IHRva2VuQ2h1bmtzID0gW107CgogICAgICBmb3IgKGxldCB0a01hdGNoIG9mIHRva2Vuc01hdGNoQWxsKSB7CiAgICAgICAgY29uc3QgcmF3VG9rZW4gPSB0a01hdGNoWzBdOwogICAgICAgIGNvbnN0IHRva2VuTWF0Y2hJdGVtID0gewogICAgICAgICAgaW5kZXg6IHRrTWF0Y2guaW5kZXgsCiAgICAgICAgICB0b2tlbjogcmF3VG9rZW4sCiAgICAgICAgICB0eXBlOiB0aGlzLmdldFRva2VuVHlwZShyYXdUb2tlbiksCiAgICAgICAgICBuZWVkc0NhbGlicmF0ZTogcmF3VG9rZW4ubGVuZ3RoIDwgMiwKICAgICAgICAgIGxlbjogKHJhd1Rva2VuIHx8ICcnKS5sZW5ndGgKICAgICAgICB9OwogICAgICAgIHRva2VuQ2h1bmtzLnB1c2godG9rZW5NYXRjaEl0ZW0pOwogICAgICB9CgogICAgICByZXR1cm4gdG9rZW5DaHVua3M7CiAgICB9LAoKICAgIG5lZWRzUG9zQ2FsaWJyYXRlKCkgewogICAgICBpZiAoIXRoaXMubWFudWFsSW5wdXQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLnRva2VuQ2h1bmtzLnNvbWUoY2hrID0+IGNoay5uZWVkc0NhbGlicmF0ZSk7CiAgICB9LAoKICAgIHRva2VuQ2h1bmtzUG9zKCkgewogICAgICBpZiAoIXRoaXMubWFudWFsSW5wdXQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5uZWVkc1Bvc0NhbGlicmF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLnRva2VuQ2h1bmtzLm1hcChjaGsgPT4gewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdG9rZW46IGNoay50b2tlbiwKICAgICAgICAgICAgdHlwZTogY2hrLnR5cGUsCiAgICAgICAgICAgIHN0YXJ0OiBjaGsuaW5kZXgsCiAgICAgICAgICAgIGVuZDogY2hrLmluZGV4ICsgY2hrLmxlbgogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdCA9IFtdOwogICAgICBsZXQgY2FsaWJyYXRlTGVuID0gMDsKICAgICAgdGhpcy50b2tlbkNodW5rcy5mb3JFYWNoKGNoayA9PiB7CiAgICAgICAgbGV0IGNodW5rQ3VycmVudExlbjsgLy8gQWRqdXN0IGZvciBjdXN0b21pemVkIEFNL1BNIHRleHQKCiAgICAgICAgaWYgKGNoay50eXBlID09PSAnYXBtJyAmJiB0aGlzLmhhcy5jdXN0b21BcG1UZXh0KSB7CiAgICAgICAgICBpZiAodGhpcy5hcG0gJiYgdGhpcy5hcG0ubGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnN0IGN1c3RvbUFwbVRleHQgPSB0aGlzLmFwbS50b0xvd2VyQ2FzZSgpID09PSAnYW0nID8gdGhpcy5hbVRleHQgOiB0aGlzLnBtVGV4dDsKICAgICAgICAgICAgY2h1bmtDdXJyZW50TGVuID0gY3VzdG9tQXBtVGV4dCAmJiBjdXN0b21BcG1UZXh0Lmxlbmd0aCA/IGN1c3RvbUFwbVRleHQubGVuZ3RoIDogY2hrLmxlbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNodW5rQ3VycmVudExlbiA9IGNoay5sZW47CiAgICAgICAgICB9IC8vIE90aGVycwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2h1bmtDdXJyZW50TGVuID0gdGhpc1tjaGsudHlwZV0gJiYgdGhpc1tjaGsudHlwZV0ubGVuZ3RoID8gdGhpc1tjaGsudHlwZV0ubGVuZ3RoIDogY2hrLmxlbjsKICAgICAgICB9CgogICAgICAgIGxpc3QucHVzaCh7CiAgICAgICAgICB0b2tlbjogY2hrLnRva2VuLAogICAgICAgICAgdHlwZTogY2hrLnR5cGUsCiAgICAgICAgICBzdGFydDogY2hrLmluZGV4ICsgY2FsaWJyYXRlTGVuLAogICAgICAgICAgZW5kOiBjaGsuaW5kZXggKyBjYWxpYnJhdGVMZW4gKyBjaHVua0N1cnJlbnRMZW4KICAgICAgICB9KTsKCiAgICAgICAgaWYgKGNoay5uZWVkc0NhbGlicmF0ZSAmJiBjaHVua0N1cnJlbnRMZW4gPiBjaGsubGVuKSB7CiAgICAgICAgICBjYWxpYnJhdGVMZW4gKz0gY2h1bmtDdXJyZW50TGVuIC0gY2hrLmxlbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbGlzdDsKICAgIH0sCgogICAgaW52YWxpZFZhbHVlcygpIHsKICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CgogICAgICBpZiAoIXRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZSAmJiAhdGhpcy5taW51dGVSYW5nZUxpc3QgJiYgIXRoaXMuc2Vjb25kUmFuZ2VMaXN0ICYmIHRoaXMub3B0cy5taW51dGVJbnRlcnZhbCA9PT0gMSAmJiB0aGlzLm9wdHMuc2Vjb25kSW50ZXJ2YWwgPT09IDEpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KCiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwoKICAgICAgaWYgKHRoaXMuaW5Vc2UuaG91ciAmJiAhdGhpcy5pc0VtcHR5VmFsdWUodGhpcy5ob3VyVHlwZSwgdGhpcy5ob3VyKSAmJiAoIXRoaXMuaXNWYWxpZFZhbHVlKHRoaXMuaG91clR5cGUsIHRoaXMuaG91cikgfHwgdGhpcy5pc0Rpc2FibGVkKCdob3VyJywgdGhpcy5ob3VyKSkpIHsKICAgICAgICByZXN1bHQucHVzaCgnaG91cicpOwogICAgICB9CgogICAgICBpZiAodGhpcy5pblVzZS5taW51dGUgJiYgIXRoaXMuaXNFbXB0eVZhbHVlKHRoaXMubWludXRlVHlwZSwgdGhpcy5taW51dGUpICYmICghdGhpcy5pc1ZhbGlkVmFsdWUodGhpcy5taW51dGVUeXBlLCB0aGlzLm1pbnV0ZSkgfHwgdGhpcy5pc0Rpc2FibGVkKCdtaW51dGUnLCB0aGlzLm1pbnV0ZSkgfHwgdGhpcy5ub3RJbkludGVydmFsKCdtaW51dGUnLCB0aGlzLm1pbnV0ZSkpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goJ21pbnV0ZScpOwogICAgICB9CgogICAgICBpZiAodGhpcy5pblVzZS5zZWNvbmQgJiYgIXRoaXMuaXNFbXB0eVZhbHVlKHRoaXMuc2Vjb25kVHlwZSwgdGhpcy5zZWNvbmQpICYmICghdGhpcy5pc1ZhbGlkVmFsdWUodGhpcy5zZWNvbmRUeXBlLCB0aGlzLnNlY29uZCkgfHwgdGhpcy5pc0Rpc2FibGVkKCdzZWNvbmQnLCB0aGlzLnNlY29uZCkgfHwgdGhpcy5ub3RJbkludGVydmFsKCdzZWNvbmQnLCB0aGlzLnNlY29uZCkpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goJ3NlY29uZCcpOwogICAgICB9CgogICAgICBpZiAodGhpcy5pblVzZS5hcG0gJiYgIXRoaXMuaXNFbXB0eVZhbHVlKHRoaXMuYXBtVHlwZSwgdGhpcy5hcG0pICYmICghdGhpcy5pc1ZhbGlkVmFsdWUodGhpcy5hcG1UeXBlLCB0aGlzLmFwbSkgfHwgdGhpcy5pc0Rpc2FibGVkKCdhcG0nLCB0aGlzLmFwbSkpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goJ2FwbScpOwogICAgICB9CgogICAgICBpZiAocmVzdWx0Lmxlbmd0aCkgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBbXTsKICAgIH0sCgogICAgaGFzSW52YWxpZElucHV0KCkgewogICAgICByZXR1cm4gQm9vbGVhbih0aGlzLmludmFsaWRWYWx1ZXMgJiYgdGhpcy5pbnZhbGlkVmFsdWVzLmxlbmd0aCk7CiAgICB9LAoKICAgIGF1dG9EaXJlY3Rpb25FbmFibGVkKCkgewogICAgICByZXR1cm4gdGhpcy5kcm9wRGlyZWN0aW9uID09PSAnYXV0byc7CiAgICB9LAoKICAgIGRyb3Bkb3duRGlyQ2xhc3MoKSB7CiAgICAgIGlmICh0aGlzLmF1dG9EaXJlY3Rpb25FbmFibGVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZm9yY2VEcm9wT25Ub3AgPyAnZHJvcC11cCcgOiAnZHJvcC1kb3duJzsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuZHJvcERpcmVjdGlvbiA9PT0gJ3VwJyA/ICdkcm9wLXVwJyA6ICdkcm9wLWRvd24nOwogICAgfQoKICB9LAogIHdhdGNoOiB7CiAgICAnb3B0cy5mb3JtYXQnKG5ld1ZhbHVlKSB7CiAgICAgIHRoaXMucmVuZGVyRm9ybWF0KG5ld1ZhbHVlKTsKICAgIH0sCgogICAgJ29wdHMubWludXRlSW50ZXJ2YWwnKG5ld0ludGV2YWwpIHsKICAgICAgdGhpcy5yZW5kZXJMaXN0KCdtaW51dGUnLCBuZXdJbnRldmFsKTsKICAgIH0sCgogICAgJ29wdHMuc2Vjb25kSW50ZXJ2YWwnKG5ld0ludGV2YWwpIHsKICAgICAgdGhpcy5yZW5kZXJMaXN0KCdzZWNvbmQnLCBuZXdJbnRldmFsKTsKICAgIH0sCgogICAgdmFsdWU6IHsKICAgICAgZGVlcDogdHJ1ZSwKCiAgICAgIGhhbmRsZXIoKSB7CiAgICAgICAgdGhpcy5yZWFkVmFsdWVzKCk7CiAgICAgIH0KCiAgICB9LAoKICAgIGRpc3BsYXlUaW1lKCkgewogICAgICB0aGlzLmZpbGxWYWx1ZXMoKTsKICAgIH0sCgogICAgZGlzYWJsZWQodG9EaXNhYmxlZCkgewogICAgICBpZiAodG9EaXNhYmxlZCkgewogICAgICAgIC8vIEZvcmNlIGNsb3NlIGRyb3Bkb3duIGFuZCByZXNldCBzdGF0dXMgd2hlbiBkaXNhYmxlZAogICAgICAgIGlmICh0aGlzLmlzQWN0aXZlKSB7CiAgICAgICAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5zaG93RHJvcGRvd24pIHsKICAgICAgICAgIHRoaXMuc2hvd0Ryb3Bkb3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgICdpbnZhbGlkVmFsdWVzLmxlbmd0aCcobmV3TGVuZ3RoLCBvbGRMZW5ndGgpIHsKICAgICAgaWYgKG5ld0xlbmd0aCAmJiBuZXdMZW5ndGggPj0gMSkgewogICAgICAgIHRoaXMuJGVtaXQoJ2Vycm9yJywgdGhpcy5pbnZhbGlkVmFsdWVzKTsKICAgICAgfSBlbHNlIGlmIChvbGRMZW5ndGggJiYgb2xkTGVuZ3RoID49IDEpIHsKICAgICAgICB0aGlzLiRlbWl0KCdlcnJvcicsIFtdKTsKICAgICAgfQogICAgfQoKICB9LAogIG1ldGhvZHM6IHsKICAgIGZvcm1hdFZhbHVlKHRva2VuLCBpKSB7CiAgICAgIGlmICghdGhpcy5pc051bWJlcihpKSkgewogICAgICAgIHJldHVybiAnJzsKICAgICAgfQoKICAgICAgaSA9ICtpOwoKICAgICAgc3dpdGNoICh0b2tlbikgewogICAgICAgIGNhc2UgJ0gnOgogICAgICAgIGNhc2UgJ2gnOgogICAgICAgIGNhc2UgJ2snOgogICAgICAgIGNhc2UgJ20nOgogICAgICAgIGNhc2UgJ3MnOgogICAgICAgICAgaWYgKFsnaCcsICdrJ10uaW5jbHVkZXModG9rZW4pICYmIGkgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRva2VuID09PSAnaycgPyAnMjQnIDogJzEyJzsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gU3RyaW5nKGkpOwoKICAgICAgICBjYXNlICdISCc6CiAgICAgICAgY2FzZSAnbW0nOgogICAgICAgIGNhc2UgJ3NzJzoKICAgICAgICBjYXNlICdoaCc6CiAgICAgICAgY2FzZSAna2snOgogICAgICAgICAgaWYgKFsnaGgnLCAna2snXS5pbmNsdWRlcyh0b2tlbikgJiYgaSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gdG9rZW4gPT09ICdraycgPyAnMjQnIDogJzEyJzsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gaSA8IDEwID8gYDAke2l9YCA6IFN0cmluZyhpKTsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgfQogICAgfSwKCiAgICBjaGVja0FjY2VwdGluZ1R5cGUodmFsaWRWYWx1ZXMsIGZvcm1hdFN0cmluZykgewogICAgICBpZiAoIXZhbGlkVmFsdWVzIHx8ICFmb3JtYXRTdHJpbmcgfHwgIWZvcm1hdFN0cmluZy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsaWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoZm9ybWF0U3RyaW5nLmluZGV4T2YodmFsaWRWYWx1ZXNbaV0pID4gLTEpIHsKICAgICAgICAgIHJldHVybiB2YWxpZFZhbHVlc1tpXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiAnJzsKICAgIH0sCgogICAgcmVuZGVyRm9ybWF0KG5ld0Zvcm1hdCkgewogICAgICBuZXdGb3JtYXQgPSBuZXdGb3JtYXQgfHwgdGhpcy5vcHRzLmZvcm1hdCB8fCBERUZBVUxUX09QVElPTlMuZm9ybWF0OwogICAgICBsZXQgaG91clR5cGUgPSB0aGlzLmNoZWNrQWNjZXB0aW5nVHlwZShDT05GSUcuSE9VUl9UT0tFTlMsIG5ld0Zvcm1hdCk7CiAgICAgIGxldCBtaW51dGVUeXBlID0gdGhpcy5jaGVja0FjY2VwdGluZ1R5cGUoQ09ORklHLk1JTlVURV9UT0tFTlMsIG5ld0Zvcm1hdCk7CiAgICAgIHRoaXMuc2Vjb25kVHlwZSA9IHRoaXMuY2hlY2tBY2NlcHRpbmdUeXBlKENPTkZJRy5TRUNPTkRfVE9LRU5TLCBuZXdGb3JtYXQpOwogICAgICB0aGlzLmFwbVR5cGUgPSB0aGlzLmNoZWNrQWNjZXB0aW5nVHlwZShDT05GSUcuQVBNX1RPS0VOUywgbmV3Rm9ybWF0KTsgLy8gRmFpbHNhZmUgY2hlY2tpbmcKCiAgICAgIGlmICghaG91clR5cGUgJiYgIW1pbnV0ZVR5cGUgJiYgIXRoaXMuc2Vjb25kVHlwZSAmJiAhdGhpcy5hcG1UeXBlKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlICYmIHRoaXMuZm9ybWF0KSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBObyB2YWxpZCB0b2tlbnMgZm91bmQgaW4geW91ciBkZWZpbmVkICJmb3JtYXQiIHN0cmluZyAiJHt0aGlzLmZvcm1hdH0iLiBGYWxsYmFjayB0byB0aGUgZGVmYXVsdCAiSEg6bW0iIGZvcm1hdC5gKTsKICAgICAgICB9CgogICAgICAgIGhvdXJUeXBlID0gJ0hIJzsKICAgICAgICBtaW51dGVUeXBlID0gJ21tJzsKICAgICAgfQoKICAgICAgdGhpcy5ob3VyVHlwZSA9IGhvdXJUeXBlOwogICAgICB0aGlzLm1pbnV0ZVR5cGUgPSBtaW51dGVUeXBlOwogICAgICB0aGlzLmhvdXJUeXBlID8gdGhpcy5yZW5kZXJIb3Vyc0xpc3QoKSA6IHRoaXMuaG91cnMgPSBbXTsKICAgICAgdGhpcy5taW51dGVUeXBlID8gdGhpcy5yZW5kZXJMaXN0KCdtaW51dGUnKSA6IHRoaXMubWludXRlcyA9IFtdOwogICAgICB0aGlzLnNlY29uZFR5cGUgPyB0aGlzLnJlbmRlckxpc3QoJ3NlY29uZCcpIDogdGhpcy5zZWNvbmRzID0gW107CiAgICAgIHRoaXMuYXBtVHlwZSA/IHRoaXMucmVuZGVyQXBtTGlzdCgpIDogdGhpcy5hcG1zID0gW107CiAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICB0aGlzLnJlYWRWYWx1ZXMoKTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlbmRlckhvdXJzTGlzdCgpIHsKICAgICAgY29uc3QgaG91cnNDb3VudCA9IHRoaXMuYmFzZU9uMTJIb3VycyA/IDEyIDogMjQ7CiAgICAgIGNvbnN0IGhvdXJzID0gW107CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhvdXJzQ291bnQ7IGkrKykgewogICAgICAgIGlmICh0aGlzLmhvdXJUeXBlID09PSAnaycgfHwgdGhpcy5ob3VyVHlwZSA9PT0gJ2trJykgewogICAgICAgICAgaG91cnMucHVzaCh0aGlzLmZvcm1hdFZhbHVlKHRoaXMuaG91clR5cGUsIGkgKyAxKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhvdXJzLnB1c2godGhpcy5mb3JtYXRWYWx1ZSh0aGlzLmhvdXJUeXBlLCBpKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmhvdXJzID0gaG91cnM7CiAgICB9LAoKICAgIHJlbmRlckxpc3QobGlzdFR5cGUsIGludGVydmFsKSB7CiAgICAgIGlmICghdGhpcy5pc01pbnV0ZU9yU2Vjb25kKGxpc3RUeXBlKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgaXNNaW51dGUgPSBsaXN0VHlwZSA9PT0gJ21pbnV0ZSc7CiAgICAgIGludGVydmFsID0gaW50ZXJ2YWwgfHwgKGlzTWludXRlID8gdGhpcy5vcHRzLm1pbnV0ZUludGVydmFsIHx8IERFRkFVTFRfT1BUSU9OUy5taW51dGVJbnRlcnZhbCA6IHRoaXMub3B0cy5zZWNvbmRJbnRlcnZhbCB8fCBERUZBVUxUX09QVElPTlMuc2Vjb25kSW50ZXJ2YWwpOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjA7IGkgKz0gaW50ZXJ2YWwpIHsKICAgICAgICByZXN1bHQucHVzaCh0aGlzLmZvcm1hdFZhbHVlKGlzTWludXRlID8gdGhpcy5taW51dGVUeXBlIDogdGhpcy5zZWNvbmRUeXBlLCBpKSk7CiAgICAgIH0KCiAgICAgIGlzTWludXRlID8gdGhpcy5taW51dGVzID0gcmVzdWx0IDogdGhpcy5zZWNvbmRzID0gcmVzdWx0OwogICAgfSwKCiAgICByZW5kZXJBcG1MaXN0KCkgewogICAgICB0aGlzLmFwbXMgPSB0aGlzLmFwbVR5cGUgPT09ICdBJyA/IFsnQU0nLCAnUE0nXSA6IFsnYW0nLCAncG0nXTsKICAgIH0sCgogICAgcmVhZFZhbHVlcygpIHsKICAgICAgaWYgKHRoaXMudXNlU3RyaW5nVmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFJlY2VpdmVkIGEgc3RyaW5nIHZhbHVlOiAiJHt0aGlzLnZhbHVlfSJgKTsKICAgICAgICB9CgogICAgICAgIHRoaXMucmVhZFN0cmluZ1ZhbHVlcyh0aGlzLnZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFJlY2VpdmVkIGFuIG9iamVjdCB2YWx1ZTogIiR7SlNPTi5zdHJpbmdpZnkodGhpcy52YWx1ZSB8fCB7fSl9ImApOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZWFkT2JqZWN0VmFsdWVzKHRoaXMudmFsdWUpOwogICAgICB9CiAgICB9LAoKICAgIHJlYWRPYmplY3RWYWx1ZXMob2JqVmFsdWUpIHsKICAgICAgY29uc3QgdGltZVZhbHVlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmpWYWx1ZSB8fCB7fSkpOwogICAgICBjb25zdCB2YWx1ZXMgPSBPYmplY3Qua2V5cyh0aW1lVmFsdWUpOyAvLyBGYWlsc2FmZSBmb3IgZW1wdHkgYHYtbW9kZWxgIG9iamVjdAoKICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLmFkZEZhbGxiYWNrVmFsdWVzKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBDT05GSUcuQkFTSUNfVFlQRVMuZm9yRWFjaCh0eXBlID0+IHsKICAgICAgICBjb25zdCB0b2tlbiA9IHRoaXMuZ2V0VG9rZW5CeVR5cGUodHlwZSk7CgogICAgICAgIGlmICh2YWx1ZXMuaW5kZXhPZih0b2tlbikgPiAtMSkgewogICAgICAgICAgY29uc3Qgc2FuaXRpemVkVmFsdWUgPSB0aGlzLnNhbml0aXplZFZhbHVlKHRva2VuLCB0aW1lVmFsdWVbdG9rZW5dKTsKICAgICAgICAgIHRoaXNbdHlwZV0gPSBzYW5pdGl6ZWRWYWx1ZTsKICAgICAgICAgIHRpbWVWYWx1ZVt0b2tlbl0gPSBzYW5pdGl6ZWRWYWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpc1t0eXBlXSA9ICcnOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMudGltZVZhbHVlID0gdGltZVZhbHVlOwogICAgfSwKCiAgICBnZXRNYXRjaEFsbEJ5UmVnZXgodGVzdFN0cmluZywgcmVnZXhTdHJpbmcpIHsKICAgICAgY29uc3Qgc3RyID0gJ3BvbHlmaWxsVGVzdCc7CiAgICAgIGNvbnN0IG5lZWRzUG9seWZpbGwgPSBCb29sZWFuKCFzdHIubWF0Y2hBbGwgfHwgdHlwZW9mIHN0ci5tYXRjaEFsbCAhPT0gJ2Z1bmN0aW9uJyk7CiAgICAgIHJldHVybiBuZWVkc1BvbHlmaWxsID8gdGhpcy5wb2x5ZmlsbE1hdGNoQWxsKHRlc3RTdHJpbmcsIHJlZ2V4U3RyaW5nKSA6IHRlc3RTdHJpbmcubWF0Y2hBbGwobmV3IFJlZ0V4cChyZWdleFN0cmluZywgJ2cnKSk7CiAgICB9LAoKICAgIHJlYWRTdHJpbmdWYWx1ZXMoc3RyaW5nVmFsdWUpIHsKICAgICAgLy8gRmFpbHNhZmUgZm9yIGVtcHR5IGB2LW1vZGVsYCBzdHJpbmcKICAgICAgaWYgKCFzdHJpbmdWYWx1ZSB8fCAhc3RyaW5nVmFsdWUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5hZGRGYWxsYmFja1ZhbHVlcygpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgZm9ybWF0U3RyaW5nID0gU3RyaW5nKHRoaXMuZm9ybWF0U3RyaW5nKTsKICAgICAgY29uc3QgdG9rZW5zUmVneFN0ciA9IGAoJHt0aGlzLnRva2VuUmVnZXhCYXNlfSkrP2A7CiAgICAgIGNvbnN0IG90aGVyc1JlZ3hTdHIgPSBgW14oJHt0aGlzLnRva2VuUmVnZXhCYXNlfSldK2A7CiAgICAgIGNvbnN0IHRva2Vuc01hdGNoQWxsID0gdGhpcy5nZXRNYXRjaEFsbEJ5UmVnZXgoZm9ybWF0U3RyaW5nLCB0b2tlbnNSZWd4U3RyKTsKICAgICAgY29uc3Qgb3RoZXJzTWF0Y2hBbGwgPSB0aGlzLmdldE1hdGNoQWxsQnlSZWdleChmb3JtYXRTdHJpbmcsIG90aGVyc1JlZ3hTdHIpOwogICAgICBjb25zdCBjaHVua3MgPSBbXTsKICAgICAgY29uc3QgdG9rZW5DaHVua3MgPSBbXTsKCiAgICAgIGZvciAobGV0IHRrTWF0Y2ggb2YgdG9rZW5zTWF0Y2hBbGwpIHsKICAgICAgICBjb25zdCB0b2tlbk1hdGNoSXRlbSA9IHsKICAgICAgICAgIGluZGV4OiB0a01hdGNoLmluZGV4LAogICAgICAgICAgdG9rZW46IHRrTWF0Y2hbMF0sCiAgICAgICAgICBpc1ZhbHVlVG9rZW46IHRydWUKICAgICAgICB9OwogICAgICAgIGNodW5rcy5wdXNoKHRva2VuTWF0Y2hJdGVtKTsKICAgICAgICB0b2tlbkNodW5rcy5wdXNoKHRva2VuTWF0Y2hJdGVtKTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgb3RNYXRjaCBvZiBvdGhlcnNNYXRjaEFsbCkgewogICAgICAgIGNodW5rcy5wdXNoKHsKICAgICAgICAgIGluZGV4OiBvdE1hdGNoLmluZGV4LAogICAgICAgICAgdG9rZW46IG90TWF0Y2hbMF0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY2h1bmtzLnNvcnQoKGwsIHIpID0+IGwuaW5kZXggPCByLmluZGV4ID8gLTEgOiAxKTsKICAgICAgbGV0IHJlZ2V4Q29tYm8gPSAnJzsKICAgICAgY2h1bmtzLmZvckVhY2goY2h1bmsgPT4gewogICAgICAgIGlmIChjaHVuay5pc1ZhbHVlVG9rZW4pIHsKICAgICAgICAgIGNvbnN0IHRva2VuUmVnZXggPSB0aGlzLmdldFRva2VuUmVnZXgoY2h1bmsudG9rZW4pIHx8ICcnOwogICAgICAgICAgcmVnZXhDb21ibyArPSB0b2tlblJlZ2V4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBzYWZlQ2hhcnMgPSBjaHVuay50b2tlbi5yZXBsYWNlKC9cXHswfShcKnxcP3xcLnxcKykvZywgJ1xcJDEnKTsKICAgICAgICAgIHJlZ2V4Q29tYm8gKz0gYCg/OiR7c2FmZUNoYXJzfSlgOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGNvbnN0IGNvbWJvUmVnID0gbmV3IFJlZ0V4cChyZWdleENvbWJvKTsgLy8gRG8gdGVzdCBiZWZvcmUgbWF0Y2gKCiAgICAgIGlmIChjb21ib1JlZy50ZXN0KHN0cmluZ1ZhbHVlKSkgewogICAgICAgIGNvbnN0IG1hdGNoUmVzdWx0cyA9IHN0cmluZ1ZhbHVlLm1hdGNoKG5ldyBSZWdFeHAocmVnZXhDb21ibykpOwogICAgICAgIGNvbnN0IHZhbHVlUmVzdWx0cyA9IG1hdGNoUmVzdWx0cy5zbGljZSgxLCB0b2tlbkNodW5rcy5sZW5ndGggKyAxKTsKICAgICAgICBjb25zdCB0aW1lVmFsdWUgPSB7fTsKICAgICAgICB2YWx1ZVJlc3VsdHMuZm9yRWFjaCgodmFsdWUsIHZySW5kZXgpID0+IHsKICAgICAgICAgIGlmICh0b2tlbkNodW5rc1t2ckluZGV4XSkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRUb2tlbiA9IHRva2VuQ2h1bmtzW3ZySW5kZXhdLnRva2VuOwogICAgICAgICAgICB0aW1lVmFsdWVbdGFyZ2V0VG9rZW5dID0gdGhpcy5zZXRWYWx1ZUZyb21TdHJpbmcodmFsdWUsIHRhcmdldFRva2VuKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLnRpbWVWYWx1ZSA9IHRpbWVWYWx1ZTsKCiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICBjb25zdCB0b2tlbkNodW5rc0ZvckxvZyA9IHRva2VuQ2h1bmtzLm1hcCh0Q2h1bmsgPT4gdENodW5rICYmIHRDaHVuay50b2tlbik7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBTdWNjZXNzZnVsbHkgcGFyc2VkIHZhbHVlcyAke0pTT04uc3RyaW5naWZ5KHZhbHVlUmVzdWx0cyl9XG5mb3IgJHtKU09OLnN0cmluZ2lmeSh0b2tlbkNodW5rc0ZvckxvZyl9XG5pbiBmb3JtYXQgcGF0dGVybiAnJHt0aGlzLmZvcm1hdFN0cmluZ30nYCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgdGhpcy5kZWJ1Z0xvZyhgVGhlIGlucHV0IHN0cmluZyBpbiAidi1tb2RlbCIgZG9lcyBOT1QgbWF0Y2ggdGhlICJmb3JtYXQiIHBhdHRlcm5cbmZvcm1hdDogJHt0aGlzLmZvcm1hdFN0cmluZ31cbnYtbW9kZWw6ICR7c3RyaW5nVmFsdWV9YCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHBvbHlmaWxsTWF0Y2hBbGwodGFyZ2V0U3RyaW5nLCByZWd4U3RyKSB7CiAgICAgIGNvbnN0IG1hdGNoZXNMaXN0ID0gdGFyZ2V0U3RyaW5nLm1hdGNoKG5ldyBSZWdFeHAocmVneFN0ciwgJ2cnKSk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICBjb25zdCBpbmRpY2VzUmVnID0gW107CgogICAgICBpZiAobWF0Y2hlc0xpc3QgJiYgbWF0Y2hlc0xpc3QubGVuZ3RoKSB7CiAgICAgICAgbWF0Y2hlc0xpc3QuZm9yRWFjaChtYXRjaGVkSXRlbSA9PiB7CiAgICAgICAgICBjb25zdCBleGlzdEluZGV4ID0gaW5kaWNlc1JlZy5maW5kSW5kZXgoaWR4SXRlbSA9PiBpZHhJdGVtLnN0ciA9PT0gbWF0Y2hlZEl0ZW0pOwogICAgICAgICAgbGV0IGluZGV4OwoKICAgICAgICAgIGlmIChleGlzdEluZGV4ID49IDApIHsKICAgICAgICAgICAgaWYgKGluZGljZXNSZWdbZXhpc3RJbmRleF0gJiYgaW5kaWNlc1JlZ1tleGlzdEluZGV4XS5yZWdleCkgewogICAgICAgICAgICAgIGluZGV4ID0gaW5kaWNlc1JlZ1tleGlzdEluZGV4XS5yZWdleC5leGVjKHRhcmdldFN0cmluZykuaW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW1JbmRpY2VzUmVnZXggPSBuZXcgUmVnRXhwKG1hdGNoZWRJdGVtLCAnZycpOwogICAgICAgICAgICBpbmRleCA9IGl0ZW1JbmRpY2VzUmVnZXguZXhlYyh0YXJnZXRTdHJpbmcpLmluZGV4OwogICAgICAgICAgICBpbmRpY2VzUmVnLnB1c2goewogICAgICAgICAgICAgIHN0cjogU3RyaW5nKG1hdGNoZWRJdGVtKSwKICAgICAgICAgICAgICByZWdleDogaXRlbUluZGljZXNSZWdleAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXN1bHQucHVzaCh7CiAgICAgICAgICAgIDA6IFN0cmluZyhtYXRjaGVkSXRlbSksCiAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIGFkZEZhbGxiYWNrVmFsdWVzKCkgewogICAgICBjb25zdCB0aW1lVmFsdWUgPSB7fTsKICAgICAgdGhpcy5pblVzZS50eXBlcy5mb3JFYWNoKHR5cGUgPT4gewogICAgICAgIHRpbWVWYWx1ZVt0aGlzLmdldFRva2VuQnlUeXBlKHR5cGUpXSA9ICcnOwogICAgICB9KTsKICAgICAgdGhpcy50aW1lVmFsdWUgPSB0aW1lVmFsdWU7CiAgICB9LAoKICAgIHNldFZhbHVlRnJvbVN0cmluZyhwYXJzZWRWYWx1ZSwgdG9rZW4pIHsKICAgICAgaWYgKCF0b2tlbiB8fCAhcGFyc2VkVmFsdWUpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KCiAgICAgIGNvbnN0IHRva2VuVHlwZSA9IHRoaXMuZ2V0VG9rZW5UeXBlKHRva2VuKTsKCiAgICAgIGlmICghdG9rZW5UeXBlIHx8ICF0b2tlblR5cGUubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CgogICAgICBjb25zdCBzdGRWYWx1ZSA9IHBhcnNlZFZhbHVlICE9PSB0aGlzLmdldFRva2VuQnlUeXBlKHRva2VuVHlwZSkgPyBwYXJzZWRWYWx1ZSA6ICcnOwogICAgICB0aGlzW3Rva2VuVHlwZV0gPSBzdGRWYWx1ZTsKICAgICAgcmV0dXJuIHN0ZFZhbHVlOwogICAgfSwKCiAgICBmaWxsVmFsdWVzKGZvcmNlRW1pdCkgewogICAgICBjb25zdCBmdWxsVmFsdWVzID0ge307CiAgICAgIGNvbnN0IGJhc2VIb3VyID0gdGhpcy5ob3VyOwogICAgICBjb25zdCBiYXNlSG91clR5cGUgPSB0aGlzLmhvdXJUeXBlOwogICAgICBsZXQgYXBtVmFsdWU7IC8vIEhvdXIgdHlwZSBvciBob3VyIHZhbHVlIGlzIE5PVCBzZXQgaW4gdGhlICJmb3JtYXQiIHN0cmluZwoKICAgICAgaWYgKCFiYXNlSG91clR5cGUgfHwgIXRoaXMuaXNOdW1iZXIoYmFzZUhvdXIpKSB7CiAgICAgICAgQ09ORklHLkhPVVJfVE9LRU5TLmZvckVhY2godG9rZW4gPT4gZnVsbFZhbHVlc1t0b2tlbl0gPSAnJyk7CiAgICAgICAgYXBtVmFsdWUgPSB0aGlzLmxvd2VyQ2FzZWRBcG0odGhpcy5hcG0gfHwgJycpOwogICAgICAgIGZ1bGxWYWx1ZXMuYSA9IGFwbVZhbHVlOwogICAgICAgIGZ1bGxWYWx1ZXMuQSA9IGFwbVZhbHVlLnRvVXBwZXJDYXNlKCk7IC8vIEJvdGggSG91ciB0eXBlIGFuZCB2YWx1ZSBhcmUgc2V0CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaG91clZhbHVlID0gK2Jhc2VIb3VyOwogICAgICAgIGNvbnN0IGFwbVZhbHVlID0gdGhpcy5iYXNlT24xMkhvdXJzICYmIHRoaXMuYXBtID8gdGhpcy5sb3dlckNhc2VkQXBtKHRoaXMuYXBtKSA6IGZhbHNlOwogICAgICAgIENPTkZJRy5IT1VSX1RPS0VOUy5mb3JFYWNoKHRva2VuID0+IHsKICAgICAgICAgIGlmICh0b2tlbiA9PT0gYmFzZUhvdXJUeXBlKSB7CiAgICAgICAgICAgIGZ1bGxWYWx1ZXNbdG9rZW5dID0gYmFzZUhvdXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBsZXQgdmFsdWU7CiAgICAgICAgICBsZXQgYXBtOwoKICAgICAgICAgIHN3aXRjaCAodG9rZW4pIHsKICAgICAgICAgICAgY2FzZSAnSCc6CiAgICAgICAgICAgIGNhc2UgJ0hIJzoKICAgICAgICAgICAgY2FzZSAnayc6CiAgICAgICAgICAgIGNhc2UgJ2trJzoKICAgICAgICAgICAgICBpZiAodGhpcy5iYXNlT24xMkhvdXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXBtVmFsdWUgPT09ICdwbScpIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWUgPCAxMiA/IGhvdXJWYWx1ZSArIDEyIDogaG91clZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChbJ2snLCAna2snXS5pbmNsdWRlcyh0b2tlbikpIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWUgPT09IDEyID8gMjQgOiBob3VyVmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvdXJWYWx1ZSAlIDEyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoWydrJywgJ2trJ10uaW5jbHVkZXModG9rZW4pKSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gaG91clZhbHVlID09PSAwID8gMjQgOiBob3VyVmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvdXJWYWx1ZSAlIDI0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZnVsbFZhbHVlc1t0b2tlbl0gPSB0aGlzLmZvcm1hdFZhbHVlKHRva2VuLCB2YWx1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdoJzoKICAgICAgICAgICAgY2FzZSAnaGgnOgogICAgICAgICAgICAgIC8vIGggPC0+IGhoCiAgICAgICAgICAgICAgaWYgKHRoaXMuYmFzZU9uMTJIb3VycykgewogICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWU7CiAgICAgICAgICAgICAgICBhcG0gPSBhcG1WYWx1ZSB8fCAnJzsgLy8gUmVhZCBmcm9tIG90aGVyIGhvdXIgZm9ybWF0cwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaG91clZhbHVlID4gMTEgJiYgaG91clZhbHVlIDwgMjQpIHsKICAgICAgICAgICAgICAgICAgYXBtID0gJ3BtJzsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob3VyVmFsdWUgPT09IDEyID8gMTIgOiBob3VyVmFsdWUgJSAxMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGFwbSA9ICdhbSc7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gaG91clZhbHVlICUgMTIgPT09IDAgPyAxMiA6IGhvdXJWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGZ1bGxWYWx1ZXNbdG9rZW5dID0gdGhpcy5mb3JtYXRWYWx1ZSh0b2tlbiwgdmFsdWUpOwogICAgICAgICAgICAgIGZ1bGxWYWx1ZXMuYSA9IGFwbTsKICAgICAgICAgICAgICBmdWxsVmFsdWVzLkEgPSBhcG0udG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVsbFZhbHVlcy5tID0gdGhpcy5mb3JtYXRWYWx1ZSgnbScsIHRoaXMubWludXRlKTsKICAgICAgZnVsbFZhbHVlcy5tbSA9IHRoaXMuZm9ybWF0VmFsdWUoJ21tJywgdGhpcy5taW51dGUpOwogICAgICBmdWxsVmFsdWVzLnMgPSB0aGlzLmZvcm1hdFZhbHVlKCdzJywgdGhpcy5zZWNvbmQpOwogICAgICBmdWxsVmFsdWVzLnNzID0gdGhpcy5mb3JtYXRWYWx1ZSgnc3MnLCB0aGlzLnNlY29uZCk7CiAgICAgIHRoaXMuZnVsbFZhbHVlcyA9IGZ1bGxWYWx1ZXM7IC8vIE9uIGxhenkgbW9kZSwgZW1pdCBgaW5wdXRgIGFuZCBgY2hhbmdlYCBldmVudHMgb25seSB3aGVuOgogICAgICAvLyAtIFRoZSB1c2VyIHBpY2sgYSBuZXcgdmFsdWUgYW5kIHRoZW4gY2xvc2UgdGhlIGRyb3Bkb3duCiAgICAgIC8vIC0gVGhlIHVzZXIgY2xpY2sgdGhlICgieCIpIGNsZWFyIGJ1dHRvbgoKICAgICAgaWYgKCF0aGlzLmxhenkgfHwgZm9yY2VFbWl0KSB7CiAgICAgICAgdGhpcy5lbWl0VGltZVZhbHVlKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNsb3NlT25Db21wbGV0ZSAmJiB0aGlzLmFsbFZhbHVlU2VsZWN0ZWQgJiYgdGhpcy5zaG93RHJvcGRvd24pIHsKICAgICAgICB0aGlzLnRvZ2dsZUFjdGl2ZSgpOwogICAgICB9CiAgICB9LAoKICAgIGdldEZ1bGxEYXRhKCkgewogICAgICBpZiAoIXRoaXMuZnVsbFZhbHVlcykgewogICAgICAgIHRoaXMuZmlsbFZhbHVlcygpOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5mdWxsVmFsdWVzKSksCiAgICAgICAgZGlzcGxheVRpbWU6IHRoaXMuaW5wdXRJc0VtcHR5ID8gJycgOiBTdHJpbmcodGhpcy5kaXNwbGF5VGltZSkKICAgICAgfTsKICAgIH0sCgogICAgZW1pdFRpbWVWYWx1ZSgpIHsKICAgICAgaWYgKHRoaXMubGF6eSAmJiB0aGlzLmJha0Rpc3BsYXlUaW1lID09PSB0aGlzLmRpc3BsYXlUaW1lKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdUaGUgdmFsdWUgZG9lcyBub3QgY2hhbmdlIG9uIGBsYXp5YCBtb2RlLiBTa2lwIHRoZSBlbWl0dGluZyBgaW5wdXRgIGFuZCBgY2hhbmdlYCBldmVudC4nKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgZnVsbERhdGEgPSB0aGlzLmdldEZ1bGxEYXRhKCk7CgogICAgICBpZiAodGhpcy51c2VTdHJpbmdWYWx1ZSkgewogICAgICAgIHRoaXMuJGVtaXQoJ2lucHV0JywgZnVsbERhdGEuZGlzcGxheVRpbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGZ1bGxWYWx1ZXMgPSBmdWxsRGF0YS5kYXRhOwogICAgICAgIGNvbnN0IHRva2Vuc0luVXNlID0gdGhpcy5pblVzZS50b2tlbnMgfHwgW107CiAgICAgICAgY29uc3QgdGltZVZhbHVlID0ge307CiAgICAgICAgdG9rZW5zSW5Vc2UuZm9yRWFjaCh0b2tlbiA9PiB7CiAgICAgICAgICB0aW1lVmFsdWVbdG9rZW5dID0gZnVsbFZhbHVlc1t0b2tlbl0gfHwgJyc7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy4kZW1pdCgnaW5wdXQnLCBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRpbWVWYWx1ZSkpKTsKICAgICAgfQoKICAgICAgdGhpcy4kZW1pdCgnY2hhbmdlJywgZnVsbERhdGEpOwogICAgfSwKCiAgICB0cmFuc2xhdGUxMmhSYW5nZSh2YWx1ZSkgewogICAgICBjb25zdCB2YWx1ZVQgPSB0aGlzLm1hdGNoMTJoUmFuZ2UodmFsdWUpOwoKICAgICAgaWYgKCt2YWx1ZVRbMV0gPT09IDEyKSB7CiAgICAgICAgcmV0dXJuICt2YWx1ZVRbMV0gKyAodmFsdWVUWzJdLnRvTG93ZXJDYXNlKCkgPT09ICdwJyA/IDAgOiAxMik7CiAgICAgIH0KCiAgICAgIHJldHVybiArdmFsdWVUWzFdICsgKHZhbHVlVFsyXS50b0xvd2VyQ2FzZSgpID09PSAncCcgPyAxMiA6IDApOwogICAgfSwKCiAgICBpc0Rpc2FibGVkKHR5cGUsIHZhbHVlKSB7CiAgICAgIGlmICghdGhpcy5pc0Jhc2ljVHlwZSh0eXBlKSB8fCAhdGhpcy5pblVzZVt0eXBlXSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICBjYXNlICdob3VyJzoKICAgICAgICAgIHJldHVybiB0aGlzLmlzRGlzYWJsZWRIb3VyKHZhbHVlKTsKCiAgICAgICAgY2FzZSAnbWludXRlJzoKICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgaWYgKCF0aGlzW2Ake3R5cGV9UmFuZ2VMaXN0YF0pIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiAhdGhpc1tgJHt0eXBlfVJhbmdlTGlzdGBdLmluY2x1ZGVzKHZhbHVlKTsKCiAgICAgICAgY2FzZSAnYXBtJzoKICAgICAgICAgIGlmICghdGhpcy5yZXN0cmljdGVkSG91clJhbmdlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gIXRoaXMuaGFzW3RoaXMubG93ZXJDYXNlZEFwbSh2YWx1ZSldOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0sCgogICAgaXNEaXNhYmxlZEhvdXIodmFsdWUpIHsKICAgICAgaWYgKCF0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmJhc2VPbjEySG91cnMpIHsKICAgICAgICBpZiAoIXRoaXMuYXBtIHx8ICF0aGlzLmFwbS5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmFwbS50b0xvd2VyQ2FzZSgpID09PSAnYW0nID8gJ2EnIDogJ3AnOwogICAgICAgICAgcmV0dXJuICF0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UuaW5jbHVkZXMoYCR7K3ZhbHVlfSR7dG9rZW59YCk7CiAgICAgICAgfQogICAgICB9IC8vIEZhbGxiYWNrIGZvciAnSEgnIGFuZCAnSCBob3VyIGZvcm1hdCB3aXRoIGEgYGhvdXItcmFuZ2VgIGluIGEgMTItaG91ciBmb3JtCgoKICAgICAgaWYgKCh0aGlzLmhvdXJUeXBlID09PSAnSEgnIHx8IHRoaXMuaG91clR5cGUgPT09ICdIJykgJiYgK3ZhbHVlID09PSAwICYmIHRoaXMucmVzdHJpY3RlZEhvdXJSYW5nZS5pbmNsdWRlcygyNCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiAhdGhpcy5yZXN0cmljdGVkSG91clJhbmdlLmluY2x1ZGVzKCt2YWx1ZSk7CiAgICB9LAoKICAgIG5vdEluSW50ZXJ2YWwoc2VjdGlvbiwgdmFsdWUpIHsKICAgICAgaWYgKCFzZWN0aW9uIHx8ICF0aGlzLmlzTWludXRlT3JTZWNvbmQoc2VjdGlvbikpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm9wdHNbYCR7c2VjdGlvbn1JbnRlcnZhbGBdID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gK3ZhbHVlICUgdGhpcy5vcHRzW2Ake3NlY3Rpb259SW50ZXJ2YWxgXSAhPT0gMDsKICAgIH0sCgogICAgcmVuZGVyUmFuZ2VMaXN0KHJhd1JhbmdlLCBzZWN0aW9uKSB7CiAgICAgIGlmICghcmF3UmFuZ2UgfHwgIXNlY3Rpb24gfHwgIXRoaXMuaXNNaW51dGVPclNlY29uZChzZWN0aW9uKSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQoKICAgICAgY29uc3QgcmFuZ2UgPSBbXTsKICAgICAgbGV0IGZvcm1hdGVkVmFsdWU7CiAgICAgIHJhd1JhbmdlLmZvckVhY2godmFsdWUgPT4gewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICBpZiAodmFsdWUubGVuZ3RoID4gMiAmJiB0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBOZXN0ZWQgYXJyYXkgd2l0aGluICIke3NlY3Rpb259LXJhbmdlIiBtdXN0IGNvbnRhaW4gbm8gbW9yZSB0aGFuIHR3byBpdGVtcy4gT25seSB0aGUgZmlyc3QgdHdvIGl0ZW1zIG9mICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfSB3aWxsIGJlIHRha2VuIGludG8gYWNjb3VudC5gKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCBzdGFydCA9IHZhbHVlWzBdOwogICAgICAgICAgY29uc3QgZW5kID0gdmFsdWVbMV0gfHwgdmFsdWVbMF07CgogICAgICAgICAgZm9yIChsZXQgaSA9ICtzdGFydDsgaSA8PSArZW5kOyBpKyspIHsKICAgICAgICAgICAgaWYgKGkgPCAwIHx8IGkgPiA1OSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JtYXRlZFZhbHVlID0gdGhpcy5mb3JtYXRWYWx1ZSh0aGlzLmdldFRva2VuQnlUeXBlKHNlY3Rpb24pLCBpKTsKCiAgICAgICAgICAgIGlmICghcmFuZ2UuaW5jbHVkZXMoZm9ybWF0ZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICByYW5nZS5wdXNoKGZvcm1hdGVkVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICgrdmFsdWUgPCAwIHx8ICt2YWx1ZSA+IDU5KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBmb3JtYXRlZFZhbHVlID0gdGhpcy5mb3JtYXRWYWx1ZSh0aGlzLmdldFRva2VuQnlUeXBlKHNlY3Rpb24pLCB2YWx1ZSk7CgogICAgICAgICAgaWYgKCFyYW5nZS5pbmNsdWRlcyhmb3JtYXRlZFZhbHVlKSkgewogICAgICAgICAgICByYW5nZS5wdXNoKGZvcm1hdGVkVmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJhbmdlLnNvcnQoKGwsIHIpID0+IHsKICAgICAgICByZXR1cm4gbCAtIHI7CiAgICAgIH0pOyAvLyBEZWJ1ZyBNb2RlCgogICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHsKICAgICAgICBjb25zdCBmdWxsTGlzdCA9IChzZWN0aW9uID09PSAnbWludXRlJyA/IHRoaXMubWludXRlcyA6IHRoaXMuc2Vjb25kcykgfHwgW107CiAgICAgICAgY29uc3QgdmFsaWRJdGVtcyA9IGZ1bGxMaXN0LmZpbHRlcihpdGVtID0+IHJhbmdlLmluY2x1ZGVzKGl0ZW0pKTsKCiAgICAgICAgaWYgKCF2YWxpZEl0ZW1zIHx8ICF2YWxpZEl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgaWYgKHNlY3Rpb24gPT09ICdtaW51dGUnKSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYFRoZSBtaW51dGUgbGlzdCBpcyBlbXB0eSBkdWUgdG8gdGhlICJtaW51dGUtcmFuZ2UiIGNvbmZpZ1xubWludXRlLXJhbmdlOiAke0pTT04uc3RyaW5naWZ5KHRoaXMubWludXRlUmFuZ2UpfVxubWludXRlLWludGVydmFsOiAke3RoaXMub3B0cy5taW51dGVJbnRlcnZhbH1gKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coYFRoZSBzZWNvbmQgbGlzdCBpcyBlbXB0eSBkdWUgdG8gdGhlICJzZWNvbmQtcmFuZ2UiIGNvbmZpZ1xuc2Vjb25kLXJhbmdlOiAke0pTT04uc3RyaW5naWZ5KHRoaXMuc2Vjb25kUmFuZ2UpfVxuc2Vjb25kLWludGVydmFsOiAke3RoaXMub3B0cy5zZWNvbmRJbnRlcnZhbH1gKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByYW5nZTsKICAgIH0sCgogICAgZm9yY2VBcG1TZWxlY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLm1hbnVhbElucHV0KSB7CiAgICAgICAgLy8gU2tpcCB0aGlzIHRvIGFsbG93IHVzZXJzIHRvIHBhc3RlIGEgc3RyaW5nIHZhbHVlIGZyb20gdGhlIGNsaXBib2FyZCBpbiBNYW51YWwgSW5wdXQgbW9kZQogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuYXBtVHlwZSAmJiAhdGhpcy5hcG0pIHsKICAgICAgICBpZiAodGhpcy5oYXMuYW0gfHwgdGhpcy5oYXMucG0pIHsKICAgICAgICAgIHRoaXMuZG9DbGVhckFwbUNoZWNraW5nID0gdHJ1ZTsKICAgICAgICAgIGNvbnN0IGFwbVZhbHVlID0gdGhpcy5oYXMuYW0gPyAnYW0nIDogJ3BtJzsKICAgICAgICAgIHRoaXMuYXBtID0gdGhpcy5hcG1UeXBlID09PSAnQScgPyBhcG1WYWx1ZS50b1VwcGVyQ2FzZSgpIDogYXBtVmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGVtcHR5QXBtU2VsZWN0aW9uKCkgewogICAgICBpZiAodGhpcy5kb0NsZWFyQXBtQ2hlY2tpbmcgJiYgdGhpcy5ob3VyID09PSAnJyAmJiB0aGlzLm1pbnV0ZSA9PT0gJycgJiYgdGhpcy5zZWNvbmQgPT09ICcnKSB7CiAgICAgICAgdGhpcy5hcG0gPSAnJzsKICAgICAgfQoKICAgICAgdGhpcy5kb0NsZWFyQXBtQ2hlY2tpbmcgPSBmYWxzZTsKICAgIH0sCgogICAgYXBtRGlzcGxheVRleHQoYXBtVmFsdWUpIHsKICAgICAgaWYgKHRoaXMuYW1UZXh0ICYmIHRoaXMubG93ZXJDYXNlZEFwbShhcG1WYWx1ZSkgPT09ICdhbScpIHsKICAgICAgICByZXR1cm4gdGhpcy5hbVRleHQ7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnBtVGV4dCAmJiB0aGlzLmxvd2VyQ2FzZWRBcG0oYXBtVmFsdWUpID09PSAncG0nKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG1UZXh0OwogICAgICB9CgogICAgICByZXR1cm4gYXBtVmFsdWU7CiAgICB9LAoKICAgIHRvZ2dsZUFjdGl2ZSgpIHsKICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuaXNBY3RpdmUgPSAhdGhpcy5pc0FjdGl2ZTsKCiAgICAgIGlmICh0aGlzLmlzQWN0aXZlKSB7CiAgICAgICAgdGhpcy5pc0ZvY3VzaW5nID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXQpIHsKICAgICAgICAgIHRoaXMuJGVtaXQoJ2ZvY3VzJyk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoaXMub3B0cy5oaWRlRHJvcGRvd24pIHsKICAgICAgICAgIHRoaXMuc2V0RHJvcGRvd25TdGF0ZSh0cnVlKTsKICAgICAgICB9IC8vIFJlY29yZCB0byBjaGVjayBpZiB2YWx1ZSBkaWQgY2hhbmdlIGluIHRoZSBsYXRlciBwaGFzZQoKCiAgICAgICAgaWYgKHRoaXMubGF6eSkgewogICAgICAgICAgdGhpcy5iYWtEaXNwbGF5VGltZSA9IFN0cmluZyh0aGlzLmRpc3BsYXlUaW1lIHx8ICcnKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm1hbnVhbElucHV0ICYmICF0aGlzLmlucHV0SXNFbXB0eSkgewogICAgICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgICAgICBpZiAodGhpcy4kcmVmcy5pbnB1dCAmJiB0aGlzLiRyZWZzLmlucHV0LnNlbGVjdGlvblN0YXJ0ID09PSAwICYmIHRoaXMuJHJlZnMuaW5wdXQuc2VsZWN0aW9uRW5kID09PSB0aGlzLmRpc3BsYXlUaW1lLmxlbmd0aCkgewogICAgICAgICAgICAgIC8vIFNlbGVjdCB0aGUgZmlyc3Qgc2xvdCBpbnN0ZWFkIG9mIHRoZSB3aG9sZSB2YWx1ZSBzdHJpbmcgd2hlbiB0YWJiZWQgaW4KICAgICAgICAgICAgICB0aGlzLnNlbGVjdEZpcnN0U2xvdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRoaXMuc2hvd0Ryb3Bkb3duKSB7CiAgICAgICAgICB0aGlzLnNldERyb3Bkb3duU3RhdGUoZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5tYW51YWxJbnB1dCkgewogICAgICAgICAgdGhpcy4kZW1pdCgnYmx1cicsIHRoaXMuZ2V0RnVsbERhdGEoKSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmlzRm9jdXNpbmcgPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMubGF6eSkgewogICAgICAgICAgdGhpcy5maWxsVmFsdWVzKHRydWUpOwogICAgICAgICAgdGhpcy5iYWtEaXNwbGF5VGltZSA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnJlc3RyaWN0ZWRIb3VyUmFuZ2UgJiYgdGhpcy5iYXNlT24xMkhvdXJzKSB7CiAgICAgICAgdGhpcy5zaG93RHJvcGRvd24gPyB0aGlzLmZvcmNlQXBtU2VsZWN0aW9uKCkgOiB0aGlzLmVtcHR5QXBtU2VsZWN0aW9uKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNob3dEcm9wZG93bikgewogICAgICAgIHRoaXMuY2hlY2tGb3JBdXRvU2Nyb2xsKCk7CiAgICAgIH0KICAgIH0sCgogICAgc2V0RHJvcGRvd25TdGF0ZSh0b1Nob3csIGZyb21Vc2VyQ2xpY2sgPSBmYWxzZSkgewogICAgICBpZiAodG9TaG93KSB7CiAgICAgICAgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5KSB7CiAgICAgICAgICB0aGlzLmFwcGVuZERyb3Bkb3duVG9Cb2R5KCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmtlZXBGb2N1c2luZygpOwoKICAgICAgICBpZiAodGhpcy5hdXRvRGlyZWN0aW9uRW5hYmxlZCkgewogICAgICAgICAgdGhpcy5jaGVja0Ryb3BEaXJlY3Rpb24oKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2hvd0Ryb3Bkb3duID0gdHJ1ZTsKICAgICAgICB0aGlzLiRlbWl0KCdvcGVuJyk7CgogICAgICAgIGlmIChmcm9tVXNlckNsaWNrKSB7CiAgICAgICAgICBpZiAodGhpcy5maXhlZERyb3Bkb3duQnV0dG9uKSB7CiAgICAgICAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuJGVtaXQoJ2JsdXInLCB0aGlzLmdldEZ1bGxEYXRhKCkpOwogICAgICAgICAgdGhpcy5jaGVja0ZvckF1dG9TY3JvbGwoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zaG93RHJvcGRvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLiRlbWl0KCdjbG9zZScsIHRoaXMuZ2V0RnVsbERhdGEoKSk7CgogICAgICAgIGlmICh0aGlzLmFwcGVuZFRvQm9keSkgewogICAgICAgICAgdGhpcy5yZW1vdmVEcm9wZG93bkZyb21Cb2R5KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZERyb3Bkb3duVG9Cb2R5KCkgewogICAgICBjb25zdCBkcm9wZG93biA9IHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5kcm9wZG93bjsKICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF07CgogICAgICBpZiAoYm9keSAmJiBkcm9wZG93bikgewogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLnVwZGF0ZURyb3Bkb3duUG9zKTsKICAgICAgICBkcm9wZG93bi5jbGFzc0xpc3QuYWRkKCd2dWVfX3RpbWUtcGlja2VyLWRyb3Bkb3duJyk7CiAgICAgICAgdGhpcy51cGRhdGVEcm9wZG93blBvcygpOwogICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoZHJvcGRvd24pOwogICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZURyb3Bkb3duUG9zKCkgewogICAgICBpZiAoIXRoaXMuYXBwZW5kVG9Cb2R5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBkcm9wZG93biA9IHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5kcm9wZG93bjsKICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF07CgogICAgICBpZiAoYm9keSAmJiBkcm9wZG93bikgewogICAgICAgIGNvbnN0IGJveCA9IHRoaXMuJGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICBpZiAodGhpcy5kcm9wZG93bkRpckNsYXNzID09PSAnZHJvcC11cCcpIHsKICAgICAgICAgIGRyb3Bkb3duLnN0eWxlLmJvdHRvbSA9IGAke3dpbmRvdy5pbm5lckhlaWdodCAtIGJveC55fXB4YDsKICAgICAgICAgIGRyb3Bkb3duLnN0eWxlLnRvcCA9ICdhdXRvJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZHJvcGRvd24uc3R5bGUudG9wID0gYCR7Ym94LnkgKyBib3guaGVpZ2h0fXB4YDsKICAgICAgICAgIGRyb3Bkb3duLnN0eWxlLmJvdHRvbSA9ICdhdXRvJzsKICAgICAgICB9CgogICAgICAgIGRyb3Bkb3duLnN0eWxlLmxlZnQgPSBgJHtib3gueH1weGA7CiAgICAgIH0KICAgIH0sCgogICAgcmVtb3ZlRHJvcGRvd25Gcm9tQm9keSgpIHsKICAgICAgY29uc3QgZHJvcGRvd24gPSB0aGlzLiRyZWZzICYmIHRoaXMuJHJlZnMuZHJvcGRvd247CiAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdOwoKICAgICAgaWYgKGJvZHkgJiYgZHJvcGRvd24gJiYgYm9keS5jb250YWlucyhkcm9wZG93bikpIHsKICAgICAgICBib2R5LnJlbW92ZUNoaWxkKGRyb3Bkb3duKTsKICAgICAgfQoKICAgICAgaWYgKGRyb3Bkb3duKSB7CiAgICAgICAgZHJvcGRvd24uY2xhc3NMaXN0LnJlbW92ZSgndnVlX190aW1lLXBpY2tlci1kcm9wZG93bicpOwogICAgICAgIGRyb3Bkb3duLnN0eWxlLnRvcCA9ICcnOwogICAgICAgIGRyb3Bkb3duLnN0eWxlLmJvdHRvbSA9ICcnOwogICAgICAgIGRyb3Bkb3duLnN0eWxlLmxlZnQgPSAnJzsKICAgICAgICB0aGlzLiRlbC5hcHBlbmRDaGlsZChkcm9wZG93bik7CiAgICAgIH0KCiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLnVwZGF0ZURyb3Bkb3duUG9zKTsKICAgIH0sCgogICAgYmx1ckV2ZW50KCkgewogICAgICBpZiAodGhpcy5tYW51YWxJbnB1dCAmJiAhdGhpcy5vcHRzLmhpZGVEcm9wZG93bikgewogICAgICAgIC8vIGhpZGVEcm9wZG93bidzIGBibHVyYCBldmVudCBpcyBoYW5kbGVkIHNvbWV3aGVyZSBlbHNlCiAgICAgICAgdGhpcy4kZW1pdCgnYmx1cicsIHRoaXMuZ2V0RnVsbERhdGEoKSk7CiAgICAgIH0KICAgIH0sCgogICAgc2VsZWN0KHR5cGUsIHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLmlzQmFzaWNUeXBlKHR5cGUpICYmICF0aGlzLmlzRGlzYWJsZWQodHlwZSwgdmFsdWUpKSB7CiAgICAgICAgdGhpc1t0eXBlXSA9IHZhbHVlOwoKICAgICAgICBpZiAodGhpcy5kb0NsZWFyQXBtQ2hlY2tpbmcpIHsKICAgICAgICAgIHRoaXMuZG9DbGVhckFwbUNoZWNraW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGNsZWFyVGltZSgpIHsKICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuaG91ciA9ICcnOwogICAgICB0aGlzLm1pbnV0ZSA9ICcnOwogICAgICB0aGlzLnNlY29uZCA9ICcnOwogICAgICB0aGlzLmFwbSA9ICcnOwoKICAgICAgaWYgKHRoaXMubWFudWFsSW5wdXQgJiYgdGhpcy4kcmVmcyAmJiB0aGlzLiRyZWZzLmlucHV0ICYmIHRoaXMuJHJlZnMuaW5wdXQudmFsdWUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy4kcmVmcy5pbnB1dC52YWx1ZSA9ICcnOwogICAgICB9CgogICAgICBpZiAodGhpcy5sYXp5KSB7CiAgICAgICAgdGhpcy5maWxsVmFsdWVzKHRydWUpOwogICAgICB9CiAgICB9LAoKICAgIC8vCiAgICAvLyBBdXRvLVNjcm9sbAogICAgLy8KICAgIGNoZWNrRm9yQXV0b1Njcm9sbCgpIHsKICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5hdXRvU2Nyb2xsKSB7CiAgICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgICAgdGhpcy5zY3JvbGxUb1NlbGVjdGVkVmFsdWVzKCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5hZHZhbmNlZEtleWJvYXJkKSB7CiAgICAgICAgLy8gQXV0by1mb2N1cyBvbiBzZWxlY3RlZCB2YWx1ZSBpbiB0aGUgZmlyc3QgY29sdW1uIGZvciBhZHZhbmNlZC1rZXlib2FyZAogICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgIGNvbnN0IGZpcnN0Q29sdW1uID0gdGhpcy5pblVzZS50eXBlc1swXTsKICAgICAgICAgIHRoaXMuc2Nyb2xsVG9TZWxlY3RlZChmaXJzdENvbHVtbiwgdHJ1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgc2Nyb2xsVG9TZWxlY3RlZChjb2x1bW4sIGFsbG93RmFsbGJhY2sgPSBmYWxzZSkgewogICAgICBpZiAoIXRoaXMudGltZVZhbHVlIHx8IHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBsZXQgdGFyZ2V0TGlzdDsKCiAgICAgIGlmICh0aGlzLmFwcGVuZFRvQm9keSAmJiB0aGlzLiRyZWZzICYmIHRoaXMuJHJlZnMuZHJvcGRvd24pIHsKICAgICAgICB0YXJnZXRMaXN0ID0gdGhpcy4kcmVmcy5kcm9wZG93bi5xdWVyeVNlbGVjdG9yQWxsKGB1bC4ke2NvbHVtbn1zYClbMF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0TGlzdCA9IHRoaXMuJGVsLnF1ZXJ5U2VsZWN0b3JBbGwoYHVsLiR7Y29sdW1ufXNgKVswXTsKICAgICAgfQoKICAgICAgbGV0IHRhcmdldFZhbHVlID0gdGhpcy5hY3RpdmVJdGVtSW5Db2woY29sdW1uKVswXTsKCiAgICAgIGlmICghdGFyZ2V0VmFsdWUgJiYgYWxsb3dGYWxsYmFjaykgewogICAgICAgIC8vIE5vIHZhbHVlIHNlbGVjdGVkIGluIHRoZSB0YXJnZXQgY29sdW1uLCBmYWxsYmFjayB0byB0aGUgZmlyc3QgZm91bmQgdmFsaWQgaXRlbQogICAgICAgIHRhcmdldFZhbHVlID0gdGhpcy52YWxpZEl0ZW1zSW5Db2woY29sdW1uKVswXTsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldExpc3QgJiYgdGFyZ2V0VmFsdWUpIHsKICAgICAgICB0YXJnZXRMaXN0LnNjcm9sbFRvcCA9IHRhcmdldFZhbHVlLm9mZnNldFRvcCB8fCAwOwoKICAgICAgICBpZiAodGhpcy5hZHZhbmNlZEtleWJvYXJkKSB7CiAgICAgICAgICB0YXJnZXRWYWx1ZS5mb2N1cygpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBzY3JvbGxUb1NlbGVjdGVkVmFsdWVzKCkgewogICAgICBpZiAoIXRoaXMudGltZVZhbHVlIHx8IHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmluVXNlLnR5cGVzLmZvckVhY2goc2VjdGlvbiA9PiB7CiAgICAgICAgdGhpcy5zY3JvbGxUb1NlbGVjdGVkKHNlY3Rpb24pOwogICAgICB9KTsKICAgIH0sCgogICAgLy8KICAgIC8vIEFkZGl0aW9uYWwgS2V5Ym9hcmQgTmF2aWdhdGlvbgogICAgLy8KICAgIG9uRm9jdXMoKSB7CiAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuaXNGb2N1c2luZykgewogICAgICAgIHRoaXMuaXNGb2N1c2luZyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgewogICAgICAgIHRoaXMudG9nZ2xlQWN0aXZlKCk7CiAgICAgIH0KICAgIH0sCgogICAgZXNjQmx1cigpIHsKICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5kZWJvdW5jZVRpbWVyKTsKICAgICAgdGhpcy5pc0ZvY3VzaW5nID0gZmFsc2U7CiAgICAgIGNvbnN0IGlucHV0Qm94ID0gdGhpcy4kZWwucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQuZGlzcGxheS10aW1lJylbMF07CgogICAgICBpZiAoaW5wdXRCb3gpIHsKICAgICAgICBpbnB1dEJveC5ibHVyKCk7CiAgICAgIH0KICAgIH0sCgogICAgZGVib3VuY2VCbHVyKCkgewogICAgICBpZiAodGhpcy5kaXNhYmxlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5pc0ZvY3VzaW5nID0gZmFsc2U7CiAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5kZWJvdW5jZVRpbWVyKTsKICAgICAgdGhpcy5kZWJvdW5jZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5kZWJvdW5jZVRpbWVyKTsKICAgICAgICB0aGlzLm9uQmx1cigpOwogICAgICB9LCB0aGlzLm9wdHMuYmx1ckRlbGF5KTsKICAgIH0sCgogICAgb25CbHVyKCkgewogICAgICBpZiAoIXRoaXMuZGlzYWJsZWQgJiYgIXRoaXMuaXNGb2N1c2luZyAmJiB0aGlzLmlzQWN0aXZlKSB7CiAgICAgICAgdGhpcy50b2dnbGVBY3RpdmUoKTsKICAgICAgfQogICAgfSwKCiAgICBrZWVwRm9jdXNpbmcoKSB7CiAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuZGVib3VuY2VUaW1lcik7CgogICAgICBpZiAoIXRoaXMuaXNGb2N1c2luZykgewogICAgICAgIHRoaXMuaXNGb2N1c2luZyA9IHRydWU7CiAgICAgIH0KICAgIH0sCgogICAgb25UYWIoY29sdW1uLCB2YWx1ZSwgZXZ0KSB7CiAgICAgIGlmICh0aGlzLmFwcGVuZFRvQm9keSAmJiBldnQuc2hpZnRLZXkpIHsKICAgICAgICBjb25zdCBmaXJzdENvbHVtbiA9IHRoaXMuaW5Vc2UudHlwZXNbMF07CgogICAgICAgIGlmIChjb2x1bW4gIT09IGZpcnN0Q29sdW1uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmaXJzdFZhbGlkVmFsdWUgPSB0aGlzLnZhbGlkSXRlbXNJbkNvbChmaXJzdENvbHVtbilbMF07IC8vIElzIHRoZSBmaXJzdCB2YWxpZCBpdGVtIGluIHRoZSBmaXJzdCBjb2x1bW4KCiAgICAgICAgaWYgKGZpcnN0VmFsaWRWYWx1ZSAmJiBmaXJzdFZhbGlkVmFsdWUuZ2V0QXR0cmlidXRlKCdkYXRhLWtleScpID09PSBTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsgLy8gRm9jdXMgYmFjayBvbiA8aW5wdXQ+CgogICAgICAgICAgaWYgKHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5pbnB1dCkgewogICAgICAgICAgICB0aGlzLiRyZWZzLmlucHV0LmZvY3VzKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHZhbGlkSXRlbXNJbkNvbChjb2x1bW4pIHsKICAgICAgY29uc3QgY29sdW1uQ2xhc3MgPSBgJHtjb2x1bW59c2A7CgogICAgICBpZiAodGhpcy5hcHBlbmRUb0JvZHkgJiYgdGhpcy4kcmVmcyAmJiB0aGlzLiRyZWZzLmRyb3Bkb3duKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuJHJlZnMuZHJvcGRvd24ucXVlcnlTZWxlY3RvckFsbChgdWwuJHtjb2x1bW5DbGFzc30gPiBsaTpub3QoLmhpbnQpOm5vdChbZGlzYWJsZWRdKWApOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy4kZWwucXVlcnlTZWxlY3RvckFsbChgdWwuJHtjb2x1bW5DbGFzc30gPiBsaTpub3QoLmhpbnQpOm5vdChbZGlzYWJsZWRdKWApOwogICAgfSwKCiAgICBhY3RpdmVJdGVtSW5Db2woY29sdW1uKSB7CiAgICAgIGNvbnN0IGNvbHVtbkNsYXNzID0gYCR7Y29sdW1ufXNgOwoKICAgICAgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5ICYmIHRoaXMuJHJlZnMgJiYgdGhpcy4kcmVmcy5kcm9wZG93bikgewogICAgICAgIHJldHVybiB0aGlzLiRyZWZzLmRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoYHVsLiR7Y29sdW1uQ2xhc3N9ID4gbGkuYWN0aXZlOm5vdCguaGludClgKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuJGVsLnF1ZXJ5U2VsZWN0b3JBbGwoYHVsLiR7Y29sdW1uQ2xhc3N9ID4gbGkuYWN0aXZlOm5vdCguaGludClgKTsKICAgIH0sCgogICAgZ2V0Q2xvc2VzdFNpYmxpbmcoY29sdW1uLCBkYXRhS2V5LCBnZXRQcmV2aW91cyA9IGZhbHNlKSB7CiAgICAgIGNvbnN0IHNpYmxpbmdzSW5Db2wgPSB0aGlzLnZhbGlkSXRlbXNJbkNvbChjb2x1bW4pOwogICAgICBjb25zdCBzZWxmSW5kZXggPSBBcnJheS5wcm90b3R5cGUuZmluZEluZGV4LmNhbGwoc2libGluZ3NJbkNvbCwgc2JsID0+IHsKICAgICAgICByZXR1cm4gc2JsLmdldEF0dHJpYnV0ZSgnZGF0YS1rZXknKSA9PT0gZGF0YUtleTsKICAgICAgfSk7IC8vIEFscmVhZHkgdGhlIGZpcnN0IGl0ZW0KCiAgICAgIGlmIChnZXRQcmV2aW91cyAmJiBzZWxmSW5kZXggPT09IDApIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFtzaWJsaW5nc0luQ29sLmxlbmd0aCAtIDFdOwogICAgICB9IC8vIEFscmVhZHkgdGhlIGxhc3QgaXRlbQoKCiAgICAgIGlmICghZ2V0UHJldmlvdXMgJiYgc2VsZkluZGV4ID09PSBzaWJsaW5nc0luQ29sLmxlbmd0aCAtIDEpIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFswXTsKICAgICAgfSAvLyBTZWxlY3RlZCB2YWx1ZSBub3QgaW4gdGhlIHZhbGlkIHZhbHVlcyBsaXN0CgoKICAgICAgaWYgKHNlbGZJbmRleCA8IDApIHsKICAgICAgICByZXR1cm4gc2libGluZ3NJbkNvbFswXTsKICAgICAgfQoKICAgICAgaWYgKGdldFByZXZpb3VzKSB7CiAgICAgICAgcmV0dXJuIHNpYmxpbmdzSW5Db2xbc2VsZkluZGV4IC0gMV07CiAgICAgIH0KCiAgICAgIHJldHVybiBzaWJsaW5nc0luQ29sW3NlbGZJbmRleCArIDFdOwogICAgfSwKCiAgICBwcmV2SXRlbShjb2x1bW4sIGRhdGFLZXksIGlzTWFudWFsSW5wdXQgPSBmYWxzZSkgewogICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGhpcy5nZXRDbG9zZXN0U2libGluZyhjb2x1bW4sIGRhdGFLZXksIHRydWUpOwoKICAgICAgaWYgKHRhcmdldEl0ZW0pIHsKICAgICAgICByZXR1cm4gaXNNYW51YWxJbnB1dCA/IHRhcmdldEl0ZW0gOiB0YXJnZXRJdGVtLmZvY3VzKCk7CiAgICAgIH0KICAgIH0sCgogICAgbmV4dEl0ZW0oY29sdW1uLCBkYXRhS2V5LCBpc01hbnVhbElucHV0ID0gZmFsc2UpIHsKICAgICAgY29uc3QgdGFyZ2V0SXRlbSA9IHRoaXMuZ2V0Q2xvc2VzdFNpYmxpbmcoY29sdW1uLCBkYXRhS2V5LCBmYWxzZSk7CgogICAgICBpZiAodGFyZ2V0SXRlbSkgewogICAgICAgIHJldHVybiBpc01hbnVhbElucHV0ID8gdGFyZ2V0SXRlbSA6IHRhcmdldEl0ZW0uZm9jdXMoKTsKICAgICAgfQogICAgfSwKCiAgICBnZXRTaWRlQ29sdW1uTmFtZShjdXJyZW50Q29sdW1uLCB0b0xlZnQgPSBmYWxzZSkgewogICAgICBjb25zdCBjdXJyZW50Q29sdW1uSW5kZXggPSB0aGlzLmluVXNlLnR5cGVzLmluZGV4T2YoY3VycmVudENvbHVtbik7CgogICAgICBpZiAodG9MZWZ0ICYmIGN1cnJlbnRDb2x1bW5JbmRleCA8PSAwKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdZb3VcJ3JlIGluIHRoZSBsZWZ0bW9zdCBsaXN0IGFscmVhZHknKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmICghdG9MZWZ0ICYmIGN1cnJlbnRDb2x1bW5JbmRleCA9PT0gdGhpcy5pblVzZS50eXBlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdZb3VcJ3JlIGluIHRoZSByaWdodG1vc3QgbGlzdCBhbHJlYWR5Jyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmluVXNlLnR5cGVzW3RvTGVmdCA/IGN1cnJlbnRDb2x1bW5JbmRleCAtIDEgOiBjdXJyZW50Q29sdW1uSW5kZXggKyAxXTsKICAgIH0sCgogICAgZ2V0Rmlyc3RJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIHRvTGVmdCA9IGZhbHNlKSB7CiAgICAgIGNvbnN0IHRhcmdldENvbHVtbiA9IHRoaXMuZ2V0U2lkZUNvbHVtbk5hbWUoY3VycmVudENvbHVtbiwgdG9MZWZ0KTsKCiAgICAgIGlmICghdGFyZ2V0Q29sdW1uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBsaXN0SXRlbXMgPSB0aGlzLnZhbGlkSXRlbXNJbkNvbCh0YXJnZXRDb2x1bW4pOwoKICAgICAgaWYgKGxpc3RJdGVtcyAmJiBsaXN0SXRlbXNbMF0pIHsKICAgICAgICByZXR1cm4gbGlzdEl0ZW1zWzBdOwogICAgICB9CiAgICB9LAoKICAgIGdldEFjdGl2ZUl0ZW1JblNpZGVDb2x1bW4oY3VycmVudENvbHVtbiwgdG9MZWZ0ID0gZmFsc2UpIHsKICAgICAgY29uc3QgdGFyZ2V0Q29sdW1uID0gdGhpcy5nZXRTaWRlQ29sdW1uTmFtZShjdXJyZW50Q29sdW1uLCB0b0xlZnQpOwoKICAgICAgaWYgKCF0YXJnZXRDb2x1bW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IGFjdGl2ZUl0ZW1zID0gdGhpcy5hY3RpdmVJdGVtSW5Db2wodGFyZ2V0Q29sdW1uKTsKCiAgICAgIGlmIChhY3RpdmVJdGVtcyAmJiBhY3RpdmVJdGVtc1swXSkgewogICAgICAgIHJldHVybiBhY3RpdmVJdGVtc1swXTsKICAgICAgfQogICAgfSwKCiAgICB0b0xlZnRDb2x1bW4oY3VycmVudENvbHVtbikgewogICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGhpcy5nZXRBY3RpdmVJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIHRydWUpIHx8IHRoaXMuZ2V0Rmlyc3RJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIHRydWUpOwoKICAgICAgaWYgKHRhcmdldEl0ZW0pIHsKICAgICAgICB0YXJnZXRJdGVtLmZvY3VzKCk7CiAgICAgIH0KICAgIH0sCgogICAgdG9SaWdodENvbHVtbihjdXJyZW50Q29sdW1uKSB7CiAgICAgIGNvbnN0IHRhcmdldEl0ZW0gPSB0aGlzLmdldEFjdGl2ZUl0ZW1JblNpZGVDb2x1bW4oY3VycmVudENvbHVtbiwgZmFsc2UpIHx8IHRoaXMuZ2V0Rmlyc3RJdGVtSW5TaWRlQ29sdW1uKGN1cnJlbnRDb2x1bW4sIGZhbHNlKTsKCiAgICAgIGlmICh0YXJnZXRJdGVtKSB7CiAgICAgICAgdGFyZ2V0SXRlbS5mb2N1cygpOwogICAgICB9CiAgICB9LAoKICAgIC8vCiAgICAvLyBNYW51YWwgSW5wdXQKICAgIC8vCiAgICBvbk1vdXNlRG93bigpIHsKICAgICAgaWYgKCF0aGlzLm1hbnVhbElucHV0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpOwogICAgICB0aGlzLnNlbGVjdGlvblRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5zZWxlY3Rpb25UaW1lcik7CgogICAgICAgIGlmICh0aGlzLiRyZWZzICYmIHRoaXMuJHJlZnMuaW5wdXQpIHsKICAgICAgICAgIGNvbnN0IG5lYXJlc3RTbG90ID0gdGhpcy5nZXROZWFyZXN0Q2h1bmtCeVBvcyh0aGlzLiRyZWZzLmlucHV0LnNlbGVjdGlvblN0YXJ0IHx8IDApOwogICAgICAgICAgdGhpcy5kZWJvdW5jZVNldElucHV0U2VsZWN0aW9uKG5lYXJlc3RTbG90KTsKICAgICAgICB9CiAgICAgIH0sIDUwKTsKICAgIH0sCgogICAga2V5RG93bkhhbmRsZXIoZXZ0KSB7CiAgICAgIGlmIChldnQuaXNDb21wb3NpbmcgfHwgZXZ0LmtleUNvZGUgPT09IDIyOSkgewogICAgICAgIC8vIFNraXAgSU1FIGlucHV0cwogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gTnVtYmVycwoKCiAgICAgIGlmIChldnQua2V5Q29kZSA+PSA0OCAmJiBldnQua2V5Q29kZSA8PSA1NyB8fCBldnQua2V5Q29kZSA+PSA5NiAmJiBldnQua2V5Q29kZSA8PSAxMDUpIHsKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB0aGlzLmtleWJvYXJkSW5wdXQoZXZ0LmtleSk7IC8vIEF8UHxNCiAgICAgIH0gZWxzZSBpZiAoWzY1LCA4MCwgNzddLmluY2x1ZGVzKGV2dC5rZXlDb2RlKSkgewogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHRoaXMua2V5Ym9hcmRJbnB1dChldnQua2V5LCB0cnVlKTsgLy8gQXJyb3cga2V5cwogICAgICB9IGVsc2UgaWYgKGV2dC5rZXlDb2RlID49IDM3ICYmIGV2dC5rZXlDb2RlIDw9IDQwKSB7CiAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdGhpcy5jbGVhcktiSW5wdXRMb2coKTsKICAgICAgICB0aGlzLmFycm93SGFuZGxlcihldnQpOyAvLyBEZWxldGV8QmFja3NwYWNlCiAgICAgIH0gZWxzZSBpZiAoZXZ0LmtleUNvZGUgPT09IDggfHwgZXZ0LmtleUNvZGUgPT09IDQ2KSB7CiAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdGhpcy5jbGVhcktiSW5wdXRMb2coKTsKICAgICAgICB0aGlzLmNsZWFyVGltZSgpOyAvLyBUYWIKICAgICAgfSBlbHNlIGlmIChldnQua2V5Q29kZSA9PT0gOSkgewogICAgICAgIHRoaXMuY2xlYXJLYklucHV0TG9nKCk7CiAgICAgICAgdGhpcy50YWJIYW5kbGVyKGV2dCk7IC8vIENvbG9ufFNwYWNlCiAgICAgIH0gZWxzZSBpZiAoZXZ0LmtleUNvZGUgPT09IDE4NiB8fCBldnQua2V5Q29kZSA9PT0gMzIpIHsKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB0aGlzLmNsZWFyS2JJbnB1dExvZygpOwogICAgICAgIHRoaXMudG9OZXh0U2xvdCgpOyAvLyBQcmV2ZW50IGFueSBOb24tRVNDIGFuZCBub24tcGFzdGluZyBpbnB1dHMKICAgICAgfSBlbHNlIGlmIChldnQua2V5Q29kZSAhPT0gMjcgJiYgIShldnQubWV0YUtleSB8fCBldnQuY3RybEtleSkpIHsKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfSwKCiAgICBvbkNvbXBvc3Rpb25TdGFydChldnQpIHsKICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgdGhpcy5iYWtDdXJyZW50UG9zID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIG9uQ29tcG9zdGlvbkVuZChldnQpIHsKICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgY29uc3QgY3BzRGF0YSA9IGV2dC5kYXRhOwogICAgICBsZXQgaW5wdXRJc0N1c3RvbUFwbVRleHQgPSBmYWxzZTsKCiAgICAgIGlmICh0aGlzLmhhcy5jdXN0b21BcG1UZXh0KSB7CiAgICAgICAgaW5wdXRJc0N1c3RvbUFwbVRleHQgPSB0aGlzLmlzQ3VzdG9tQXBtVGV4dChjcHNEYXRhKTsKICAgICAgfQoKICAgICAgaWYgKGlucHV0SXNDdXN0b21BcG1UZXh0KSB7CiAgICAgICAgdGhpcy5zZXRTYW5pdGl6ZWRWYWx1ZVRvU2VjdGlvbignYXBtJywgaW5wdXRJc0N1c3RvbUFwbVRleHQpOwogICAgICB9CgogICAgICB0aGlzLiRyZWZzLmlucHV0LnZhbHVlID0gdGhpcy5oYXMuY3VzdG9tQXBtVGV4dCA/IHRoaXMuY3VzdG9tRGlzcGxheVRpbWUgOiB0aGlzLmRpc3BsYXlUaW1lOwogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgaWYgKHRoaXMuYmFrQ3VycmVudFBvcykgewogICAgICAgICAgY29uc3QgYmFrUG9zID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmJha0N1cnJlbnRQb3MpKTsKCiAgICAgICAgICBpZiAoaW5wdXRJc0N1c3RvbUFwbVRleHQpIHsKICAgICAgICAgICAgYmFrUG9zLmVuZCA9IGJha1Bvcy5zdGFydCArIGNwc0RhdGEubGVuZ3RoOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihiYWtQb3MpOwogICAgICAgICAgdGhpcy5iYWtDdXJyZW50UG9zID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIHBhc3RlSGFuZGxlcihldnQpIHsKICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGxldCBwYXN0aW5nVGV4dCA9IChldnQuY2xpcGJvYXJkRGF0YSB8fCB3aW5kb3cuY2xpcGJvYXJkRGF0YSkuZ2V0RGF0YSgndGV4dCcpOwoKICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgdGhpcy5kZWJ1Z0xvZyhgUGFzdGluZyB2YWx1ZSAiJHtwYXN0aW5nVGV4dH0iIGZyb20gY2xpcGJvYXJkYCk7CiAgICAgIH0KCiAgICAgIGlmICghcGFzdGluZ1RleHQgfHwgIXBhc3RpbmdUZXh0Lmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBSZXBsYWNlIGN1c3RvbSBBTS9QTSB0ZXh0IChpZiBhbnkpCgoKICAgICAgaWYgKHRoaXMuaGFzLmN1c3RvbUFwbVRleHQpIHsKICAgICAgICBwYXN0aW5nVGV4dCA9IHRoaXMucmVwbGFjZUN1c3RvbUFwbVRleHQocGFzdGluZ1RleHQpOwogICAgICB9CgogICAgICBpZiAodGhpcy5pbnB1dElzRW1wdHkpIHsKICAgICAgICB0aGlzLnJlYWRTdHJpbmdWYWx1ZXMocGFzdGluZ1RleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMua2JJbnB1dExvZyA9IHBhc3RpbmdUZXh0LnN1YnN0cigtMiwgMik7CiAgICAgICAgdGhpcy5zZXRLYklucHV0KCk7CiAgICAgICAgdGhpcy5kZWJvdW5jZUNsZWFyS2JMb2coKTsKICAgICAgfQogICAgfSwKCiAgICBhcnJvd0hhbmRsZXIoZXZ0KSB7CiAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IHsKICAgICAgICAzNzogJ0wnLAogICAgICAgIDM4OiAnVScsCiAgICAgICAgMzk6ICdSJywKICAgICAgICA0MDogJ0QnCiAgICAgIH1bZXZ0LmtleUNvZGVdOwoKICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ1UnIHx8IGRpcmVjdGlvbiA9PT0gJ0QnKSB7CiAgICAgICAgaWYgKHRoaXMuaW5wdXRJc0VtcHR5KSB7CiAgICAgICAgICB0aGlzLnNlbGVjdEZpcnN0VmFsaWRWYWx1ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBjdXJyZW50Q2h1bmsgPSB0aGlzLmdldEN1cnJlbnRUb2tlbkNodW5rKCk7CgogICAgICAgICAgaWYgKCFjdXJyZW50Q2h1bmspIHsKICAgICAgICAgICAgdGhpcy5zZWxlY3RGaXJzdFZhbGlkVmFsdWUoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IHRva2VuVHlwZSA9IGN1cnJlbnRDaHVuay50eXBlOwogICAgICAgICAgdGhpcy5nZXRDbG9zZXN0VmFsaWRJdGVtSW5Db2wodG9rZW5UeXBlLCB0aGlzW3Rva2VuVHlwZV0sIGRpcmVjdGlvbik7CiAgICAgICAgICBjb25zdCBuZXdDaHVua1BvcyA9IHRoaXMuZ2V0Q3VycmVudFRva2VuQ2h1bmsoKTsKICAgICAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihuZXdDaHVua1Bvcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ1InKSB7CiAgICAgICAgdGhpcy50b0xhdGVyYWxUb2tlbihmYWxzZSk7CiAgICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnTCcpIHsKICAgICAgICB0aGlzLnRvTGF0ZXJhbFRva2VuKHRydWUpOwogICAgICB9CiAgICB9LAoKICAgIHRhYkhhbmRsZXIoZXZ0KSB7CiAgICAgIGlmICghdGhpcy5pbnB1dElzRW1wdHkgJiYgdGhpcy50b2tlbkNodW5rc1BvcyAmJiB0aGlzLnRva2VuQ2h1bmtzUG9zLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGN1cnJlbnRDaHVuayA9IHRoaXMuZ2V0Q3VycmVudFRva2VuQ2h1bmsoKTsKCiAgICAgICAgaWYgKCFjdXJyZW50Q2h1bmspIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGZpcnN0Q2h1bmsgPSB0aGlzLnRva2VuQ2h1bmtzUG9zWzBdOwogICAgICAgIGNvbnN0IGxhc3RDaHVuayA9IHRoaXMudG9rZW5DaHVua3NQb3NbdGhpcy50b2tlbkNodW5rc1Bvcy5sZW5ndGggLSAxXTsKCiAgICAgICAgaWYgKGV2dC5zaGlmdEtleSAmJiBjdXJyZW50Q2h1bmsudG9rZW4gIT09IGZpcnN0Q2h1bmsudG9rZW4gfHwgIWV2dC5zaGlmdEtleSAmJiBjdXJyZW50Q2h1bmsudG9rZW4gIT09IGxhc3RDaHVuay50b2tlbikgewogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB0aGlzLnRvTGF0ZXJhbFRva2VuKGV2dC5zaGlmdEtleSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoaXMuYXBwZW5kVG9Cb2R5ICYmIHRoaXMuYWR2YW5jZWRLZXlib2FyZCkgewogICAgICAgIGlmIChldnQuc2hpZnRLZXkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICBpZiAodGhpcy5pbnB1dElzRW1wdHkpIHsKICAgICAgICAgIGNvbnN0IGZpcnN0Q29sdW1uID0gdGhpcy5pblVzZS50eXBlc1swXTsKICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gdGhpcy52YWxpZEl0ZW1zSW5Db2woZmlyc3RDb2x1bW4pWzBdOwoKICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZSkgewogICAgICAgICAgICB0YXJnZXRWYWx1ZS5mb2N1cygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBrZXlib2FyZElucHV0KG5ld0NoYXIsIGlzQXBtID0gZmFsc2UpIHsKICAgICAgY29uc3QgY3VycmVudENodW5rID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpOwoKICAgICAgaWYgKCFjdXJyZW50Q2h1bmsgfHwgY3VycmVudENodW5rLnR5cGUgIT09ICdhcG0nICYmIGlzQXBtIHx8IGN1cnJlbnRDaHVuay50eXBlID09PSAnYXBtJyAmJiAhaXNBcG0pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMua2JJbnB1dExvZyA9IGAke3RoaXMua2JJbnB1dExvZy5zdWJzdHIoLTEpfSR7bmV3Q2hhcn1gOwogICAgICB0aGlzLnNldEtiSW5wdXQoKTsKICAgICAgdGhpcy5kZWJvdW5jZUNsZWFyS2JMb2coKTsKICAgIH0sCgogICAgY2xlYXJLYklucHV0TG9nKCkgewogICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMua2JJbnB1dFRpbWVyKTsKICAgICAgdGhpcy5rYklucHV0TG9nID0gJyc7CiAgICB9LAoKICAgIGRlYm91bmNlQ2xlYXJLYkxvZygpIHsKICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmtiSW5wdXRUaW1lcik7CiAgICAgIHRoaXMua2JJbnB1dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuY2xlYXJLYklucHV0TG9nKCk7CiAgICAgIH0sIHRoaXMub3B0cy5tYW51YWxJbnB1dFRpbWVvdXQpOwogICAgfSwKCiAgICBzZXRLYklucHV0KHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdmFsdWUgfHwgdGhpcy5rYklucHV0TG9nOwogICAgICBjb25zdCBjdXJyZW50Q2h1bmsgPSB0aGlzLmdldEN1cnJlbnRUb2tlbkNodW5rKCk7CgogICAgICBpZiAoIWN1cnJlbnRDaHVuayB8fCAhdmFsdWUgfHwgIXZhbHVlLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgY2h1bmtUeXBlID0gY3VycmVudENodW5rLnR5cGU7CiAgICAgIGNvbnN0IGNodW5rVG9rZW4gPSBjdXJyZW50Q2h1bmsudG9rZW47CiAgICAgIGxldCB2YWxpZFZhbHVlOwoKICAgICAgaWYgKGNodW5rVHlwZSA9PT0gJ2FwbScpIHsKICAgICAgICBpZiAodGhpcy5sb3dlckNhc2VkQXBtKHZhbHVlKS5pbmNsdWRlcygnYScpKSB7CiAgICAgICAgICB2YWxpZFZhbHVlID0gJ2FtJzsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG93ZXJDYXNlZEFwbSh2YWx1ZSkuaW5jbHVkZXMoJ3AnKSkgewogICAgICAgICAgdmFsaWRWYWx1ZSA9ICdwbSc7CiAgICAgICAgfQoKICAgICAgICBpZiAodmFsaWRWYWx1ZSkgewogICAgICAgICAgdmFsaWRWYWx1ZSA9IGNodW5rVG9rZW4gPT09ICdBJyA/IHZhbGlkVmFsdWUudG9VcHBlckNhc2UoKSA6IHZhbGlkVmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLmlzVmFsaWRWYWx1ZShjaHVua1Rva2VuLCB2YWx1ZSkpIHsKICAgICAgICAgIHZhbGlkVmFsdWUgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbGFzdElucHV0VmFsdWUgPSB0aGlzLmZvcm1hdFZhbHVlKGNodW5rVG9rZW4sIHZhbHVlLnN1YnN0cigtMSkpOwoKICAgICAgICAgIGlmICh0aGlzLmlzVmFsaWRWYWx1ZShjaHVua1Rva2VuLCBsYXN0SW5wdXRWYWx1ZSkpIHsKICAgICAgICAgICAgdmFsaWRWYWx1ZSA9IGxhc3RJbnB1dFZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHZhbGlkVmFsdWUpIHsKICAgICAgICB0aGlzLnNldFNhbml0aXplZFZhbHVlVG9TZWN0aW9uKGNodW5rVHlwZSwgdmFsaWRWYWx1ZSk7CiAgICAgICAgY29uc3QgbmV3Q2h1bmtQb3MgPSB0aGlzLmdldEN1cnJlbnRUb2tlbkNodW5rKCk7CiAgICAgICAgdGhpcy5kZWJvdW5jZVNldElucHV0U2VsZWN0aW9uKG5ld0NodW5rUG9zKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgaWYgKHZhbGlkVmFsdWUpIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFN1Y2Nlc3NmdWxseSBzZXQgdmFsdWUgIiR7dmFsaWRWYWx1ZX0iIGZyb20gbGF0ZXN0IGlucHV0ICIke3ZhbHVlfSIgZm9yIHRoZSAiJHtjaHVua1R5cGV9IiBzbG90YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuZGVidWdMb2coYFZhbHVlICIke3ZhbHVlfSIgaXMgaW52YWxpZCBpbiB0aGUgIiR7Y2h1bmtUeXBlfSIgc2xvdGApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvLyBGb3JtIEF1dG9maWxsCiAgICBvbkNoYW5nZSgpIHsKICAgICAgaWYgKCF0aGlzLm1hbnVhbElucHV0IHx8ICF0aGlzLiRyZWZzIHx8ICF0aGlzLiRyZWZzLmlucHV0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBhdXRvRmlsbFZhbHVlID0gdGhpcy4kcmVmcy5pbnB1dC52YWx1ZSB8fCAnJzsKCiAgICAgIGlmIChhdXRvRmlsbFZhbHVlICYmIGF1dG9GaWxsVmFsdWUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5yZWFkU3RyaW5nVmFsdWVzKGF1dG9GaWxsVmFsdWUpOwogICAgICB9CiAgICB9LAoKICAgIGdldE5lYXJlc3RDaHVua0J5UG9zKHN0YXJ0UG9zKSB7CiAgICAgIGlmICghdGhpcy50b2tlbkNodW5rc1BvcyB8fCAhdGhpcy50b2tlbkNodW5rc1Bvcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGxldCBuZWFyZXN0OwogICAgICBsZXQgbmVhcmVzdERlbHRhID0gLTE7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaHVuayA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy50b2tlbkNodW5rc1Bvc1tpXSkpOwoKICAgICAgICBpZiAoY2h1bmsuc3RhcnQgPT09IHN0YXJ0UG9zKSB7CiAgICAgICAgICByZXR1cm4gY2h1bms7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkZWx0YSA9IE1hdGguYWJzKGNodW5rLnN0YXJ0IC0gc3RhcnRQb3MpOwoKICAgICAgICBpZiAobmVhcmVzdERlbHRhIDwgMCkgewogICAgICAgICAgbmVhcmVzdCA9IGNodW5rOwogICAgICAgICAgbmVhcmVzdERlbHRhID0gZGVsdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChuZWFyZXN0RGVsdGEgPD0gZGVsdGEpIHsKICAgICAgICAgICAgcmV0dXJuIG5lYXJlc3Q7CiAgICAgICAgICB9CgogICAgICAgICAgbmVhcmVzdERlbHRhID0gZGVsdGE7CiAgICAgICAgICBuZWFyZXN0ID0gY2h1bms7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbmVhcmVzdDsKICAgIH0sCgogICAgc2VsZWN0Rmlyc3RWYWxpZFZhbHVlKCkgewogICAgICBpZiAoIXRoaXMudG9rZW5DaHVua3NQb3MgfHwgIXRoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBmaXJzdFNsb3RUeXBlID0gdGhpcy50b2tlbkNodW5rc1Bvc1swXS50eXBlOwoKICAgICAgaWYgKGZpcnN0U2xvdFR5cGUgPT09ICdob3VyJykgewogICAgICAgIHRoaXMuZ2V0Q2xvc2VzdEhvdXJJdGVtKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5nZXRDbG9zZXN0VmFsaWRJdGVtSW5Db2woZmlyc3RTbG90VHlwZSwgdGhpc1tmaXJzdFNsb3RUeXBlXSk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2VsZWN0Rmlyc3RTbG90KCk7CiAgICB9LAoKICAgIGdldENsb3Nlc3RIb3VySXRlbShjdXJyZW50VmFsdWUsIGRpcmVjdGlvbiA9ICdVJykgewogICAgICBpZiAoIXRoaXMudmFsaWRIb3Vyc0xpc3QgfHwgIXRoaXMudmFsaWRIb3Vyc0xpc3QubGVuZ3RoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBObyB2YWxpZCBob3VyIHZhbHVlcyBmb3VuZCwgcGxlYXNlIGNoZWNrIHlvdXIgImhvdXItcmFuZ2UiIGNvbmZpZ1xuaG91ci1yYW5nZTogJHtKU09OLnN0cmluZ2lmeSh0aGlzLmhvdXJSYW5nZSl9YCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghY3VycmVudFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXRNYW51YWxIb3VyKHRoaXMudmFsaWRIb3Vyc0xpc3RbMF0pOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gdGhpcy52YWxpZEhvdXJzTGlzdC5maW5kSW5kZXgoaXRlbSA9PiB7CiAgICAgICAgaWYgKCF0aGlzLmJhc2VPbjEySG91cnMpIHsKICAgICAgICAgIHJldHVybiBpdGVtID09PSBjdXJyZW50VmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHZhbHVlS2V5ID0gYCR7Y3VycmVudFZhbHVlfSR7dGhpcy5sb3dlckNhc2VkQXBtKHRoaXMuYXBtKSA9PT0gJ3BtJyA/ICdwJyA6ICdhJ31gOwogICAgICAgICAgcmV0dXJuIGl0ZW0gPT09IHZhbHVlS2V5OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGxldCBuZXh0SW5kZXg7CgogICAgICBpZiAoY3VycmVudEluZGV4ID09PSAtMSkgewogICAgICAgIG5leHRJbmRleCA9IDA7CiAgICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnRCcpIHsKICAgICAgICBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggPT09IDAgPyB0aGlzLnZhbGlkSG91cnNMaXN0Lmxlbmd0aCAtIDEgOiBjdXJyZW50SW5kZXggLSAxOwogICAgICB9IGVsc2UgewogICAgICAgIG5leHRJbmRleCA9IChjdXJyZW50SW5kZXggKyAxKSAlIHRoaXMudmFsaWRIb3Vyc0xpc3QubGVuZ3RoOwogICAgICB9CgogICAgICBjb25zdCBuZXh0SXRlbSA9IHRoaXMudmFsaWRIb3Vyc0xpc3RbbmV4dEluZGV4XTsKICAgICAgdGhpcy5zZXRNYW51YWxIb3VyKG5leHRJdGVtKTsKICAgIH0sCgogICAgZ2V0Q2xvc2VzdFZhbGlkSXRlbUluQ29sKGNvbHVtbiwgY3VycmVudFZhbHVlLCBkaXJlY3Rpb24gPSAnVScpIHsKICAgICAgaWYgKGNvbHVtbiA9PT0gJ2hvdXInKSB7CiAgICAgICAgdGhpcy5nZXRDbG9zZXN0SG91ckl0ZW0oY3VycmVudFZhbHVlLCBkaXJlY3Rpb24pOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG5leHRJdGVtID0gZGlyZWN0aW9uID09PSAnRCcgPyB0aGlzLnByZXZJdGVtKGNvbHVtbiwgdGhpc1tjb2x1bW5dLCB0cnVlKSA6IHRoaXMubmV4dEl0ZW0oY29sdW1uLCB0aGlzW2NvbHVtbl0sIHRydWUpOwoKICAgICAgICBpZiAobmV4dEl0ZW0pIHsKICAgICAgICAgIHRoaXMuc2VsZWN0KGNvbHVtbiwgbmV4dEl0ZW0uZ2V0QXR0cmlidXRlKCdkYXRhLWtleScpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0U2FuaXRpemVkVmFsdWVUb1NlY3Rpb24oc2VjdGlvbiwgaW5wdXRWYWx1ZSkgewogICAgICBpZiAoIXNlY3Rpb24gfHwgIXRoaXMuZ2V0VG9rZW5CeVR5cGUoc2VjdGlvbikpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gTk9URTogRGlzYWJsZWQgdmFsdWVzIGFyZSBhbGxvd2VkIGhlcmUsIGZvbGxvd2VkIGJ5IGFuICdlcnJvcicgZXZlbnQsIHRob3VnaAoKCiAgICAgIGNvbnN0IHNhbml0aXplZFZhbHVlID0gdGhpcy5zYW5pdGl6ZWRWYWx1ZSh0aGlzLmdldFRva2VuQnlUeXBlKHNlY3Rpb24pLCBpbnB1dFZhbHVlKTsKICAgICAgdGhpc1tzZWN0aW9uXSA9IHNhbml0aXplZFZhbHVlOwogICAgfSwKCiAgICBzZXRNYW51YWxIb3VyKG5leHRJdGVtKSB7CiAgICAgIGlmICh0aGlzLmlzMTJoUmFuZ2UobmV4dEl0ZW0pKSB7CiAgICAgICAgY29uc3QgaG91clQgPSB0aGlzLm1hdGNoMTJoUmFuZ2UobmV4dEl0ZW0pOwogICAgICAgIGNvbnN0IGFwbVZhbHVlID0gaG91clRbMl0gPT09ICdhJyA/ICdBTScgOiAnUE0nOwogICAgICAgIHRoaXMuc2V0U2FuaXRpemVkVmFsdWVUb1NlY3Rpb24oJ2FwbScsIHRoaXMuYXBtVHlwZSA9PT0gJ2EnID8gYXBtVmFsdWUudG9Mb3dlckNhc2UoKSA6IGFwbVZhbHVlKTsKICAgICAgICB0aGlzLnNldFNhbml0aXplZFZhbHVlVG9TZWN0aW9uKCdob3VyJywgaG91clRbMV0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0U2FuaXRpemVkVmFsdWVUb1NlY3Rpb24oJ2hvdXInLCBuZXh0SXRlbSk7CiAgICAgIH0KICAgIH0sCgogICAgZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbih7CiAgICAgIHN0YXJ0ID0gMCwKICAgICAgZW5kID0gMAogICAgfSkgewogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgdGhpcy5zZXRJbnB1dFNlbGVjdGlvblJhbmdlKHN0YXJ0LCBlbmQpOwogICAgICB9KTsKICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnNlbGVjdGlvblRpbWVyKTsKICAgICAgdGhpcy5zZWxlY3Rpb25UaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpOyAvLyBEb3VibGUtY2hlY2sgc2VsZWN0aW9uIGZvciAxMmhyIGZvcm1hdAoKICAgICAgICBpZiAodGhpcy4kcmVmcy5pbnB1dCAmJiAodGhpcy4kcmVmcy5pbnB1dC5zZWxlY3Rpb25TdGFydCAhPT0gc3RhcnQgfHwgdGhpcy4kcmVmcy5pbnB1dC5zZWxlY3Rpb25FbmQgIT09IGVuZCkpIHsKICAgICAgICAgIHRoaXMuc2V0SW5wdXRTZWxlY3Rpb25SYW5nZShzdGFydCwgZW5kKTsKICAgICAgICB9CiAgICAgIH0sIDMwKTsKICAgIH0sCgogICAgc2V0SW5wdXRTZWxlY3Rpb25SYW5nZShzdGFydCwgZW5kKSB7CiAgICAgIGlmICh0aGlzLiRyZWZzICYmIHRoaXMuJHJlZnMuaW5wdXQpIHsKICAgICAgICB0aGlzLiRyZWZzLmlucHV0LnNldFNlbGVjdGlvblJhbmdlKHN0YXJ0LCBlbmQpOwogICAgICB9CiAgICB9LAoKICAgIGdldEN1cnJlbnRUb2tlbkNodW5rKCkgewogICAgICByZXR1cm4gdGhpcy5nZXROZWFyZXN0Q2h1bmtCeVBvcyh0aGlzLiRyZWZzLmlucHV0ICYmIHRoaXMuJHJlZnMuaW5wdXQuc2VsZWN0aW9uU3RhcnQgfHwgMCk7CiAgICB9LAoKICAgIHNlbGVjdEZpcnN0U2xvdCgpIHsKICAgICAgY29uc3QgZmlyc3RDaHVua1BvcyA9IHRoaXMuZ2V0TmVhcmVzdENodW5rQnlQb3MoMCk7CiAgICAgIHRoaXMuZGVib3VuY2VTZXRJbnB1dFNlbGVjdGlvbihmaXJzdENodW5rUG9zKTsKICAgIH0sCgogICAgdG9OZXh0U2xvdCgpIHsKICAgICAgaWYgKCF0aGlzLmlucHV0SXNFbXB0eSAmJiB0aGlzLnRva2VuQ2h1bmtzUG9zICYmIHRoaXMudG9rZW5DaHVua3NQb3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgY3VycmVudENodW5rID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpOwoKICAgICAgICBpZiAoIWN1cnJlbnRDaHVuaykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgbGFzdENodW5rID0gdGhpcy50b2tlbkNodW5rc1Bvc1t0aGlzLnRva2VuQ2h1bmtzUG9zLmxlbmd0aCAtIDFdOwoKICAgICAgICBpZiAoY3VycmVudENodW5rLnRva2VuICE9PSBsYXN0Q2h1bmsudG9rZW4pIHsKICAgICAgICAgIHRoaXMudG9MYXRlcmFsVG9rZW4oZmFsc2UpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICB0b0xhdGVyYWxUb2tlbih0b0xlZnQpIHsKICAgICAgY29uc3QgY3VycmVudENodW5rID0gdGhpcy5nZXRDdXJyZW50VG9rZW5DaHVuaygpOwoKICAgICAgaWYgKCFjdXJyZW50Q2h1bmspIHsKICAgICAgICB0aGlzLnNlbGVjdEZpcnN0VmFsaWRWYWx1ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgY3VycmVudENodW5rSW5kZXggPSB0aGlzLnRva2VuQ2h1bmtzUG9zLmZpbmRJbmRleChjaGsgPT4gY2hrLnRva2VuID09PSBjdXJyZW50Q2h1bmsudG9rZW4pOwoKICAgICAgaWYgKCF0b0xlZnQgJiYgY3VycmVudENodW5rSW5kZXggPj0gdGhpcy50b2tlbkNodW5rc1Bvcy5sZW5ndGggLSAxIHx8IHRvTGVmdCAmJiBjdXJyZW50Q2h1bmtJbmRleCA9PT0gMCkgewogICAgICAgIGlmICh0aGlzLmRlYnVnTW9kZSkgewogICAgICAgICAgaWYgKHRvTGVmdCkgewogICAgICAgICAgICB0aGlzLmRlYnVnTG9nKCdZb3VcJ3JlIGluIHRoZSBsZWZ0bW9zdCBzbG90IGFscmVhZHknKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdMb2coJ1lvdVwncmUgaW4gdGhlIHJpZ2h0bW9zdCBzbG90IGFscmVhZHknKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgdGFyZ2V0U2xvdFBvcyA9IHRvTGVmdCA/IHRoaXMudG9rZW5DaHVua3NQb3NbY3VycmVudENodW5rSW5kZXggLSAxXSA6IHRoaXMudG9rZW5DaHVua3NQb3NbY3VycmVudENodW5rSW5kZXggKyAxXTsKICAgICAgdGhpcy5kZWJvdW5jZVNldElucHV0U2VsZWN0aW9uKHRhcmdldFNsb3RQb3MpOwogICAgfSwKCiAgICBpc0N1c3RvbUFwbVRleHQoaW5wdXREYXRhKSB7CiAgICAgIGlmICghaW5wdXREYXRhIHx8ICFpbnB1dERhdGEubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAodGhpcy5hbVRleHQgJiYgdGhpcy5hbVRleHQgPT09IGlucHV0RGF0YSkgewogICAgICAgIHJldHVybiB0aGlzLmFwbVR5cGUgPT09ICdBJyA/ICdBTScgOiAnYW0nOwogICAgICB9CgogICAgICBpZiAodGhpcy5wbVRleHQgJiYgdGhpcy5wbVRleHQgPT09IGlucHV0RGF0YSkgewogICAgICAgIHJldHVybiB0aGlzLmFwbVR5cGUgPT09ICdBJyA/ICdQTScgOiAncG0nOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIHJlcGxhY2VDdXN0b21BcG1UZXh0KGlucHV0U3RyaW5nKSB7CiAgICAgIGlmICh0aGlzLmFtVGV4dCAmJiB0aGlzLmFtVGV4dC5sZW5ndGggJiYgaW5wdXRTdHJpbmcuaW5jbHVkZXModGhpcy5hbVRleHQpKSB7CiAgICAgICAgcmV0dXJuIGlucHV0U3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cCh0aGlzLmFtVGV4dCwgJ2cnKSwgdGhpcy5hcG1UeXBlID09PSAnQScgPyAnQU0nIDogJ2FtJyk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5wbVRleHQgJiYgdGhpcy5wbVRleHQubGVuZ3RoICYmIGlucHV0U3RyaW5nLmluY2x1ZGVzKHRoaXMucG1UZXh0KSkgewogICAgICAgIHJldHVybiBpbnB1dFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy5wbVRleHQsICdnJyksIHRoaXMuYXBtVHlwZSA9PT0gJ0EnID8gJ1BNJyA6ICdwbScpOwogICAgICB9CgogICAgICByZXR1cm4gaW5wdXRTdHJpbmc7CiAgICB9LAoKICAgIGNoZWNrRHJvcERpcmVjdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLiRlbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbGV0IGNvbnRhaW5lcjsKCiAgICAgIGlmICh0aGlzLmNvbnRhaW5lcklkICYmIHRoaXMuY29udGFpbmVySWQubGVuZ3RoKSB7CiAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5jb250YWluZXJJZCk7CgogICAgICAgIGlmICghY29udGFpbmVyICYmIHRoaXMuZGVidWdNb2RlKSB7CiAgICAgICAgICB0aGlzLmRlYnVnTG9nKGBDb250YWluZXIgd2l0aCBpZCAiJHt0aGlzLmNvbnRhaW5lcklkfSIgbm90IGZvdW5kLiBGYWxsYmFjayB0byBkb2N1bWVudCBib2R5LmApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZWwgPSB0aGlzLiRlbDsKICAgICAgbGV0IHNwYWNlRG93bjsKCiAgICAgIGlmIChjb250YWluZXIgJiYgY29udGFpbmVyLm9mZnNldEhlaWdodCkgewogICAgICAgIC8vIFZhbGlkIGNvbnRhaW5lciBmb3VuZAogICAgICAgIHNwYWNlRG93biA9IGNvbnRhaW5lci5vZmZzZXRUb3AgKyBjb250YWluZXIub2Zmc2V0SGVpZ2h0IC0gKGVsLm9mZnNldFRvcCArIGVsLm9mZnNldEhlaWdodCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRmFsbGJhY2sgdG8gZG9jdW1lbnQgYm9keQogICAgICAgIGNvbnN0IGRvY0hlaWdodCA9IE1hdGgubWF4KGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0LCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0LCBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodCwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm9mZnNldEhlaWdodCwgZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpOwogICAgICAgIHNwYWNlRG93biA9IGRvY0hlaWdodCAtIChlbC5vZmZzZXRUb3AgKyBlbC5vZmZzZXRIZWlnaHQpOwogICAgICB9CgogICAgICB0aGlzLmZvcmNlRHJvcE9uVG9wID0gdGhpcy5vcHRzLmRyb3BPZmZzZXRIZWlnaHQgPiBzcGFjZURvd247CiAgICB9LAoKICAgIC8vCiAgICAvLyBIZWxwZXJzCiAgICAvLwogICAgaXMxMmhSYW5nZSh2YWx1ZSkgewogICAgICByZXR1cm4gL15cZHsxLDJ9KGF8cHxBfFApJC8udGVzdCh2YWx1ZSk7CiAgICB9LAoKICAgIG1hdGNoMTJoUmFuZ2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLm1hdGNoKC9eKFxkezEsMn0pKGF8cHxBfFApJC8pOwogICAgfSwKCiAgICBpc051bWJlcih2YWx1ZSkgewogICAgICByZXR1cm4gIWlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKSAmJiBpc0Zpbml0ZSh2YWx1ZSk7CiAgICB9LAoKICAgIGlzQmFzaWNUeXBlKHR5cGUpIHsKICAgICAgcmV0dXJuIENPTkZJRy5CQVNJQ19UWVBFUy5pbmNsdWRlcyh0eXBlKTsKICAgIH0sCgogICAgbG93ZXJDYXNlZEFwbShhcG1WYWx1ZSkgewogICAgICByZXR1cm4gKGFwbVZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKCiAgICBnZXRUb2tlblJlZ2V4KHRva2VuKSB7CiAgICAgIHN3aXRjaCAodG9rZW4pIHsKICAgICAgICBjYXNlICdISCc6CiAgICAgICAgICByZXR1cm4gJyhbMDFdWzAtOV18MlswLTNdfEh7Mn0pJzsKCiAgICAgICAgY2FzZSAnSCc6CiAgICAgICAgICByZXR1cm4gJyhbMC05XXsxfXwxWzAtOV18MlswLTNdfEh7MX0pJzsKCiAgICAgICAgY2FzZSAnaGgnOgogICAgICAgICAgcmV0dXJuICcoMFsxLTldfDFbMC0yXXxoezJ9KSc7CgogICAgICAgIGNhc2UgJ2gnOgogICAgICAgICAgcmV0dXJuICcoWzEtOV17MX18MVswLTJdfGh7MX0pJzsKCiAgICAgICAgY2FzZSAna2snOgogICAgICAgICAgcmV0dXJuICcoMFsxLTldfDFbMC05XXwyWzAtNF18a3syfSknOwoKICAgICAgICBjYXNlICdrJzoKICAgICAgICAgIHJldHVybiAnKFsxLTldezF9fDFbMC05XXwyWzAtNF18a3sxfSknOwoKICAgICAgICBjYXNlICdtbSc6CiAgICAgICAgICByZXR1cm4gJyhbMC01XVswLTldfG17Mn0pJzsKCiAgICAgICAgY2FzZSAnc3MnOgogICAgICAgICAgcmV0dXJuICcoWzAtNV1bMC05XXxzezJ9KSc7CgogICAgICAgIGNhc2UgJ20nOgogICAgICAgICAgcmV0dXJuICcoWzAtOV17MX18WzEtNV1bMC05XXxtezF9KSc7CgogICAgICAgIGNhc2UgJ3MnOgogICAgICAgICAgcmV0dXJuICcoWzAtOV17MX18WzEtNV1bMC05XXxzezF9KSc7CgogICAgICAgIGNhc2UgJ0EnOgogICAgICAgICAgcmV0dXJuICcoQU18UE18QXsxfSknOwoKICAgICAgICBjYXNlICdhJzoKICAgICAgICAgIHJldHVybiAnKGFtfHBtfGF7MX0pJzsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgfQogICAgfSwKCiAgICBpc0VtcHR5VmFsdWUodGFyZ2V0VG9rZW4sIHRlc3RWYWx1ZSkgewogICAgICByZXR1cm4gIXRlc3RWYWx1ZSB8fCAhdGVzdFZhbHVlLmxlbmd0aCB8fCB0ZXN0VmFsdWUgJiYgdGVzdFZhbHVlID09PSB0YXJnZXRUb2tlbjsKICAgIH0sCgogICAgaXNWYWxpZFZhbHVlKHRhcmdldFRva2VuLCB0ZXN0VmFsdWUpIHsKICAgICAgaWYgKCF0YXJnZXRUb2tlbiB8fCB0aGlzLmlzRW1wdHlWYWx1ZSh0YXJnZXRUb2tlbiwgdGVzdFZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgY29uc3QgdG9rZW5SZWdleFN0ciA9IHRoaXMuZ2V0VG9rZW5SZWdleCh0YXJnZXRUb2tlbik7CgogICAgICBpZiAoIXRva2VuUmVnZXhTdHIgfHwgIXRva2VuUmVnZXhTdHIubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFJlZ0V4cChgXiR7dG9rZW5SZWdleFN0cn0kYCkudGVzdCh0ZXN0VmFsdWUpOwogICAgfSwKCiAgICBzYW5pdGl6ZWRWYWx1ZSh0YXJnZXRUb2tlbiwgaW5wdXRWYWx1ZSkgewogICAgICBpZiAodGhpcy5pc1ZhbGlkVmFsdWUodGFyZ2V0VG9rZW4sIGlucHV0VmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGlucHV0VmFsdWU7CiAgICAgIH0KCiAgICAgIHJldHVybiAnJzsKICAgIH0sCgogICAgZ2V0VG9rZW5UeXBlKHRva2VuKSB7CiAgICAgIHJldHVybiB0aGlzLmluVXNlLnR5cGVzW3RoaXMuaW5Vc2UudG9rZW5zLmluZGV4T2YodG9rZW4pXSB8fCAnJzsKICAgIH0sCgogICAgZ2V0VG9rZW5CeVR5cGUodHlwZSkgewogICAgICByZXR1cm4gdGhpc1tgJHt0eXBlfVR5cGVgXSB8fCAnJzsKICAgIH0sCgogICAgaXNNaW51dGVPclNlY29uZCh0eXBlKSB7CiAgICAgIHJldHVybiBbJ21pbnV0ZScsICdzZWNvbmQnXS5pbmNsdWRlcyh0eXBlKTsKICAgIH0sCgogICAgZGVidWdMb2cobG9nVGV4dCkgewogICAgICBpZiAoIWxvZ1RleHQgfHwgIWxvZ1RleHQubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBsZXQgaWRlbnRpZmllciA9ICcnOwoKICAgICAgaWYgKHRoaXMuaWQpIHsKICAgICAgICBpZGVudGlmaWVyICs9IGAjJHt0aGlzLmlkfWA7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm5hbWUpIHsKICAgICAgICBpZGVudGlmaWVyICs9IGBbbmFtZT0ke3RoaXMubmFtZX1dYDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaW5wdXRDbGFzcykgewogICAgICAgIGxldCBpbnB1dENsYXNzZXMgPSBbXTsKCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmlucHV0Q2xhc3MgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpbnB1dENsYXNzZXMgPSB0aGlzLmlucHV0Q2xhc3Muc3BsaXQoL1xzL2cpOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmlucHV0Q2xhc3MpKSB7CiAgICAgICAgICBpbnB1dENsYXNzZXMgPSBbXS5jb25jYXQoW10sIHRoaXMuaW5wdXRDbGFzcyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5pbnB1dENsYXNzID09PSAnb2JqZWN0JykgewogICAgICAgICAgT2JqZWN0LmtleXModGhpcy5pbnB1dENsYXNzKS5mb3JFYWNoKGNsc05hbWUgPT4gewogICAgICAgICAgICBpZiAodGhpcy5pbnB1dENsYXNzW2Nsc05hbWVdKSB7CiAgICAgICAgICAgICAgaW5wdXRDbGFzc2VzLnB1c2goY2xzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZm9yIChsZXQgaW5wdXRDbGFzcyBvZiBpbnB1dENsYXNzZXMpIHsKICAgICAgICAgIGlmIChpbnB1dENsYXNzICYmIGlucHV0Q2xhc3MudHJpbSgpLmxlbmd0aCkgewogICAgICAgICAgICBpZGVudGlmaWVyICs9IGAuJHtpbnB1dENsYXNzLnRyaW0oKX1gOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZmluYWxMb2dUZXh0ID0gYERFQlVHOiAke2xvZ1RleHR9JHtpZGVudGlmaWVyID8gYFxuXHQoJHtpZGVudGlmaWVyfSlgIDogJyd9YDsKCiAgICAgIGlmICh3aW5kb3cuY29uc29sZS5kZWJ1ZyAmJiB0eXBlb2Ygd2luZG93LmNvbnNvbGUuZGVidWcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS5kZWJ1ZyhmaW5hbExvZ1RleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhmaW5hbExvZ1RleHQpOwogICAgICB9CiAgICB9CgogIH0sCgogIG1vdW50ZWQoKSB7CiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuZGVib3VuY2VUaW1lcik7CiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpOwogICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmtiSW5wdXRUaW1lcik7CiAgICB0aGlzLnJlbmRlckZvcm1hdCgpOwogIH0sCgogIGJlZm9yZURlc3Ryb3koKSB7CiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuZGVib3VuY2VUaW1lcik7CiAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuc2VsZWN0aW9uVGltZXIpOwogICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmtiSW5wdXRUaW1lcik7CiAgfQoKfTs="},null]}